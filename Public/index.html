<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#040812" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Orizon" />
  <title>Orizon — Find Your Circle</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap');

    :root {
      --bg: #040812;
      --surface: rgba(12,20,40,0.97);
      --surface2: rgba(18,30,56,0.95);
      --border: rgba(99,179,255,0.13);
      --accent: #3b82f6;
      --accent-glow: rgba(59,130,246,0.35);
      --green: #22c55e;
      --green-glow: rgba(34,197,94,0.4);
      --orange: #f97316;
      --orange-glow: rgba(249,115,22,0.4);
      --red: #ef4444;
      --text: #e2eeff;
      --text-muted: #5a7aaa;
      --mono: 'Space Mono', monospace;
      --sans: 'Syne', sans-serif;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; height: -webkit-fill-available; }
    body {
      width: 100%; height: 100%; min-height: -webkit-fill-available;
      background: var(--bg); color: var(--text);
      font-family: var(--sans); overflow: hidden;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }

    /* ── LOADING ─────────────────────────────────────────── */
    #loading-screen {
      position: fixed; inset: 0; background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      z-index: 500; transition: opacity 0.4s;
    }
    #loading-screen.fade { opacity: 0; pointer-events: none; }
    .loader {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── SCREENS ─────────────────────────────────────────── */
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 0.4s, transform 0.4s;
      z-index: 10;
    }
    .screen.hidden { opacity: 0; pointer-events: none; transform: translateY(16px); }

    /* ── VERIFIED SCREEN ─────────────────────────────────── */
    #verified-screen { background: var(--bg); gap: 20px; padding: 32px; text-align: center; }
    .verified-icon {
      width: 80px; height: 80px;
      background: rgba(34,197,94,0.1); border: 2px solid var(--green);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      margin: 0 auto; box-shadow: 0 0 40px var(--green-glow);
      animation: pop-in 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes pop-in { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .verified-icon svg { width: 36px; height: 36px; fill: var(--green); }
    .verified-title { font-size: 1.6rem; font-weight: 800; }
    .verified-sub { font-family: var(--mono); font-size: 0.72rem; color: var(--text-muted); line-height: 1.9; max-width: 280px; }

    /* ── AUTH SCREEN ─────────────────────────────────────── */
    #auth-screen { background: var(--bg); gap: 28px; padding: 28px; overflow-y: auto; }
    #auth-screen::before {
      content: ''; position: fixed; inset: 0;
      background: radial-gradient(ellipse at 50% 0%, rgba(59,130,246,0.07) 0%, transparent 60%);
      pointer-events: none;
    }

    .logo { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .logo-mark {
      width: 68px; height: 68px; border: 2px solid var(--accent); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; position: relative;
      box-shadow: 0 0 40px var(--accent-glow); animation: pulse-glow 3s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%,100% { box-shadow: 0 0 30px var(--accent-glow); }
      50% { box-shadow: 0 0 70px var(--accent-glow); }
    }
    .logo-mark::before {
      content: ''; position: absolute; width: 38px; height: 38px;
      border-radius: 50%; border: 1px solid rgba(99,179,255,0.2);
      animation: spin 10s linear infinite;
    }
    .logo-mark svg { width: 26px; height: 26px; fill: var(--accent); }
    .logo h1 { font-size: clamp(1.8rem,5vw,2.2rem); font-weight: 800; letter-spacing: -0.02em; }
    .logo p { font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); letter-spacing: 0.2em; text-transform: uppercase; }

    .auth-form { width: 100%; max-width: 380px; display: flex; flex-direction: column; gap: 10px; }
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); letter-spacing: 0.1em; text-transform: uppercase; }
    .input-group input {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 13px 15px;
      color: var(--text); font-family: var(--mono); font-size: 0.88rem;
      outline: none; width: 100%; -webkit-appearance: none;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .input-group input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

    .btn {
      padding: 13px 20px; border-radius: 12px; border: none;
      font-family: var(--sans); font-size: 0.9rem; font-weight: 700;
      cursor: pointer; transition: all var(--transition); letter-spacing: 0.01em;
    }
    .btn-primary { background: var(--accent); color: #fff; box-shadow: 0 4px 20px var(--accent-glow); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 28px var(--accent-glow); }
    .btn-primary:active { transform: scale(0.97); }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--surface); color: var(--text); }
    .btn-danger { background: rgba(239,68,68,0.12); color: var(--red); border: 1px solid rgba(239,68,68,0.25); }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }

    .divider { text-align: center; font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); }
    .error-msg { font-family: var(--mono); font-size: 0.68rem; color: var(--red); text-align: center; min-height: 16px; }
    .success-msg { font-family: var(--mono); font-size: 0.68rem; color: var(--green); text-align: center; }

    /* ── MAP ─────────────────────────────────────────────── */
    #map-screen { padding: 0; }
    #map { position: fixed; inset: 0; z-index: 1; }
    .leaflet-tile { filter: brightness(0.35) saturate(0.5) invert(1) hue-rotate(200deg); }
    .leaflet-control-zoom, .leaflet-control-attribution { display: none !important; }

    /* ── TOP BAR ─────────────────────────────────────────── */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      padding: calc(var(--safe-top) + 10px) calc(16px + var(--safe-right)) 10px calc(16px + var(--safe-left));
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      background: linear-gradient(180deg, rgba(4,8,18,0.97) 0%, rgba(4,8,18,0.6) 85%, transparent 100%);
    }
    .app-name {
      font-size: clamp(1.1rem,4vw,1.3rem); font-weight: 800; letter-spacing: -0.02em;
      display: flex; align-items: center; gap: 8px; flex-shrink: 0;
    }
    .tracking-dot {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
      background: var(--green); box-shadow: 0 0 10px var(--green);
      animation: blink 2s ease-in-out infinite;
      transition: background 0.4s, box-shadow 0.4s;
    }
    .tracking-dot.vis-off { background: var(--orange); box-shadow: 0 0 10px var(--orange); animation: none; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

    .profile-chip {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 5px 12px 5px 5px;
      cursor: pointer; transition: all var(--transition); backdrop-filter: blur(12px);
    }
    .profile-chip:hover { border-color: rgba(99,179,255,0.3); }
    .profile-chip:active { transform: scale(0.96); }
    .profile-chip-avatar {
      width: 26px; height: 26px; border-radius: 50%; background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700;
    }
    .profile-chip-name { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ── COMPASS ─────────────────────────────────────────── */
    .compass-bar {
      position: fixed; top: calc(var(--safe-top) + 62px); left: 50%; transform: translateX(-50%);
      z-index: 100; background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 5px 14px;
      font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted);
      display: none; align-items: center; gap: 8px; backdrop-filter: blur(12px);
      white-space: nowrap;
    }
    .compass-bar.visible { display: flex; }
    .compass-needle { font-size: 1rem; display: inline-block; transition: transform 0.1s linear; }

    /* ── SIDE BUTTONS ────────────────────────────────────── */
    .side-btns {
      position: fixed; right: calc(16px + var(--safe-right));
      bottom: calc(var(--safe-bottom) + 250px);
      z-index: 100; display: flex; flex-direction: column; gap: 10px; align-items: center;
    }
    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--transition); backdrop-filter: blur(12px);
    }
    .icon-btn:hover { border-color: rgba(99,179,255,0.3); transform: scale(1.06); }
    .icon-btn:active { transform: scale(0.92); }
    .icon-btn svg { width: 18px; height: 18px; fill: var(--text); transition: fill 0.2s; }
    .icon-btn.active-btn { background: rgba(59,130,246,0.15); border-color: var(--accent); }
    .icon-btn.active-btn svg { fill: var(--accent); }

    /* ── LOCATE ME ───────────────────────────────────────── */
    .locate-me-btn {
      position: fixed; left: calc(16px + var(--safe-left));
      bottom: calc(var(--safe-bottom) + 100px); z-index: 100;
    }

    /* ── FABs ────────────────────────────────────────────── */
    .fab-container {
      position: fixed; right: calc(16px + var(--safe-right));
      bottom: calc(var(--safe-bottom) + 100px);
      z-index: 100; display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
    }
    .fab {
      border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .fab:hover { transform: scale(1.08); }
    .fab:active { transform: scale(0.9) !important; }
    .fab svg { fill: #fff; }

    .fab-add {
      width: 50px; height: 50px;
      background: var(--accent); box-shadow: 0 4px 24px var(--accent-glow);
    }
    .fab-add svg { width: 22px; height: 22px; }

    .fab-vis {
      width: 58px; height: 58px;
      background: var(--green); box-shadow: 0 4px 30px var(--green-glow);
      transition: background 0.4s, box-shadow 0.4s, transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .fab-vis.vis-off { background: var(--orange); box-shadow: 0 4px 30px var(--orange-glow); }
    .fab-vis svg { width: 26px; height: 26px; }

    /* ── CONTACTS PANEL ──────────────────────────────────── */
    .contacts-panel {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 89;
      background: var(--surface); border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      transform: translateY(calc(100% - 64px));
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      max-height: 65vh; display: flex; flex-direction: column;
      padding-bottom: var(--safe-bottom); backdrop-filter: blur(20px);
    }
    .contacts-panel.open { transform: translateY(0); }

    .panel-drag { padding: 10px 20px 6px; cursor: pointer; }
    .panel-handle {
      width: 36px; height: 4px; background: var(--border);
      border-radius: 2px; margin: 0 auto 8px; transition: background 0.2s;
    }
    .contacts-panel:hover .panel-handle { background: rgba(99,179,255,0.3); }
    .panel-header { display: flex; align-items: center; justify-content: space-between; }
    .panel-title { font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .contact-count {
      font-family: var(--mono); font-size: 0.6rem;
      background: var(--surface2); border: 1px solid var(--border);
      padding: 2px 8px; border-radius: 20px; color: var(--text-muted);
    }
    .panel-arrow { width: 18px; height: 18px; fill: var(--text-muted); transition: transform 0.3s; }
    .contacts-panel.open .panel-arrow { transform: rotate(180deg); }

    .contacts-list {
      overflow-y: auto; padding: 4px 12px 12px;
      display: flex; flex-direction: column; gap: 6px; flex: 1;
      overscroll-behavior: contain;
    }
    .contacts-list::-webkit-scrollbar { display: none; }

    .contact-card {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 14px; padding: 12px 14px;
      display: flex; align-items: center; gap: 12px;
      cursor: pointer; transition: all var(--transition);
    }
    .contact-card:hover { border-color: rgba(99,179,255,0.25); transform: translateX(2px); }
    .contact-card:active { opacity: 0.7; transform: scale(0.98); }

    .contact-avatar {
      width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 0.95rem; color: #fff !important;
      position: relative;
    }
    .status-dot {
      position: absolute; bottom: -1px; right: -1px;
      width: 11px; height: 11px; border-radius: 50%;
      border: 2px solid var(--surface2); transition: all 0.3s;
    }
    .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.offline { background: var(--orange); }
    .status-dot.unknown { background: var(--text-muted); }

    .contact-info { flex: 1; overflow: hidden; }
    .contact-name { font-weight: 700; font-size: 0.88rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .contact-dist { font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); }

    .contact-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .mini-btn {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--transition);
    }
    .mini-btn:hover { background: var(--accent); border-color: var(--accent); }
    .mini-btn:hover svg { fill: #fff; }
    .mini-btn:active { transform: scale(0.88); }
    .mini-btn svg { width: 13px; height: 13px; fill: var(--text-muted); transition: fill 0.2s; }
    .mini-btn.vis-hidden { background: rgba(249,115,22,0.12); border-color: var(--orange); }
    .mini-btn.vis-hidden svg { fill: var(--orange); }

    .empty-contacts {
      text-align: center; padding: 28px 16px;
      font-family: var(--mono); font-size: 0.72rem;
      color: var(--text-muted); line-height: 2;
    }

    /* ── MODALS ──────────────────────────────────────────── */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(4,8,18,0.88); backdrop-filter: blur(16px);
      display: flex; align-items: flex-end; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }

    .modal {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 28px 28px 0 0;
      padding: 16px 20px calc(20px + var(--safe-bottom));
      width: 100%; max-width: 480px;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      display: flex; flex-direction: column; gap: 14px;
      max-height: 90vh; overflow-y: auto;
    }
    .modal-overlay.open .modal { transform: translateY(0); }

    .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 2px; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.1rem; font-weight: 800; }
    .close-btn {
      width: 30px; height: 30px; background: var(--surface2); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1rem; color: var(--text-muted); transition: all 0.2s;
    }
    .close-btn:hover { background: rgba(239,68,68,0.15); color: var(--red); }

    /* QR */
    .qr-tabs { display: flex; gap: 6px; }
    .qr-tab {
      flex: 1; padding: 10px; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; text-align: center;
      font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted);
      cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; transition: all var(--transition);
    }
    .qr-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    #qr-display { display: flex; flex-direction: column; gap: 14px; align-items: center; }
    #qr-scan { display: none; flex-direction: column; gap: 10px; }
    #qrcode-container { background: #fff; padding: 14px; border-radius: 18px; display: inline-block; }
    #qrcode-container canvas, #qrcode-container img { display: block; }
    .qr-hint { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); text-align: center; line-height: 1.7; }

    #scan-video-container {
      position: relative; width: 100%; border-radius: 18px;
      overflow: hidden; background: #000; aspect-ratio: 1;
    }
    #scan-video { width: 100%; height: 100%; object-fit: cover; display: block; }
    .scan-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
    .scan-frame {
      width: 200px; height: 200px; border: 2px solid var(--accent);
      border-radius: 18px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.45); position: relative;
    }
    .scan-line {
      position: absolute; left: 10px; right: 10px; height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      top: 10px; animation: scan-move 2s ease-in-out infinite;
    }
    @keyframes scan-move { 0%{top:10px} 100%{top:calc(100% - 12px)} }
    #scan-status { font-family: var(--mono); font-size: 0.68rem; color: var(--text-muted); text-align: center; }

    /* Confirm */
    .confi      --sans: 'Syne', sans-serif;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --radius: 16px;
      --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { height: 100%; height: -webkit-fill-available; }
    body {
      width: 100%; height: 100%; min-height: -webkit-fill-available;
      background: var(--bg); color: var(--text);
      font-family: var(--sans); overflow: hidden;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }

    /* ─── SCREENS ──────────────────────────────────────── */
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 0.4s ease, transform 0.4s ease;
      z-index: 10;
    }
    .screen.hidden { opacity: 0; pointer-events: none; transform: translateY(16px); }

    /* ─── EMAIL VERIFIED SCREEN ───────────────────────── */
    #verified-screen {
      background: var(--bg); gap: 24px; padding: 32px;
      text-align: center;
    }
    .verified-icon {
      width: 80px; height: 80px;
      background: rgba(34,197,94,0.12);
      border: 2px solid var(--green);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto;
      box-shadow: 0 0 40px var(--green-glow);
      animation: pop-in 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes pop-in { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .verified-icon svg { width: 36px; height: 36px; fill: var(--green); }
    .verified-title { font-size: 1.6rem; font-weight: 800; }
    .verified-sub { font-family: var(--mono); font-size: 0.75rem; color: var(--text-muted); line-height: 1.8; max-width: 280px; }

    /* ─── AUTH SCREEN ──────────────────────────────────── */
    #auth-screen { background: var(--bg); gap: 28px; padding: 32px; overflow-y: auto; }
    #auth-screen::before {
      content: '';
      position: fixed; inset: 0;
      background: radial-gradient(ellipse at 50% 0%, rgba(59,130,246,0.08) 0%, transparent 60%);
      pointer-events: none;
    }

    .logo { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .logo-mark {
      width: 68px; height: 68px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      position: relative;
      box-shadow: 0 0 40px var(--accent-glow), inset 0 0 30px rgba(59,130,246,0.06);
      animation: pulse-ring 3s ease-in-out infinite;
    }
    @keyframes pulse-ring {
      0%,100% { box-shadow: 0 0 40px var(--accent-glow), inset 0 0 30px rgba(59,130,246,0.06); }
      50% { box-shadow: 0 0 70px var(--accent-glow), inset 0 0 50px rgba(59,130,246,0.12); }
    }
    .logo-mark::before {
      content: ''; position: absolute;
      width: 38px; height: 38px; border-radius: 50%;
      border: 1px solid rgba(99,179,255,0.25);
      animation: spin 10s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .logo-mark svg { width: 26px; height: 26px; fill: var(--accent); }
    .logo h1 { font-size: clamp(1.8rem, 5vw, 2.2rem); font-weight: 800; letter-spacing: -0.02em; }
    .logo p { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.2em; text-transform: uppercase; }

    .auth-form { width: 100%; max-width: 380px; display: flex; flex-direction: column; gap: 10px; }
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); letter-spacing: 0.12em; text-transform: uppercase; }
    .input-group input {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 13px 15px;
      color: var(--text); font-family: var(--mono); font-size: 0.9rem;
      outline: none; width: 100%;
      transition: border-color var(--transition), box-shadow var(--transition);
      -webkit-appearance: none;
    }
    .input-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .btn {
      padding: 13px 20px; border-radius: 12px; border: none;
      font-family: var(--sans); font-size: 0.9rem; font-weight: 700;
      cursor: pointer; transition: all var(--transition); letter-spacing: 0.01em;
      position: relative; overflow: hidden;
    }
    .btn::after {
      content: ''; position: absolute; inset: 0;
      background: rgba(255,255,255,0); transition: background 0.15s;
    }
    .btn:active::after { background: rgba(255,255,255,0.08); }
    .btn-primary { background: var(--accent); color: #fff; box-shadow: 0 4px 24px var(--accent-glow); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 32px var(--accent-glow); }
    .btn-primary:active { transform: translateY(0) scale(0.98); }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--surface); border-color: rgba(99,179,255,0.25); color: var(--text); }
    .btn-danger { background: rgba(239,68,68,0.12); color: var(--red); border: 1px solid rgba(239,68,68,0.25); }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }

    .divider { text-align: center; font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); }
    .error-msg { font-family: var(--mono); font-size: 0.68rem; color: var(--red); text-align: center; min-height: 16px; transition: all 0.2s; }
    .success-msg { font-family: var(--mono); font-size: 0.68rem; color: var(--green); text-align: center; min-height: 16px; }

    /* ─── MAP ──────────────────────────────────────────── */
    #map-screen { padding: 0; }
    #map { position: fixed; inset: 0; z-index: 1; }
    .leaflet-tile { filter: brightness(0.82) saturate(0.65) hue-rotate(195deg); }
    .leaflet-control-zoom { display: none; }
    .leaflet-attribution-flag { display: none !important; }
    .leaflet-control-attribution { display: none; }

    /* ─── TOP BAR ──────────────────────────────────────── */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0;
      padding: calc(var(--safe-top) + 10px) calc(16px + var(--safe-right)) 10px calc(16px + var(--safe-left));
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(180deg, rgba(4,8,18,0.96) 0%, rgba(4,8,18,0.7) 80%, transparent 100%);
      z-index: 100; gap: 10px;
    }
    .app-name {
      font-size: clamp(1.1rem, 4vw, 1.3rem); font-weight: 800; letter-spacing: -0.02em;
      display: flex; align-items: center; gap: 8px; flex-shrink: 0;
    }
    .tracking-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--green); box-shadow: 0 0 10px var(--green);
      animation: blink 2s ease-in-out infinite; flex-shrink: 0;
    }
    .tracking-dot.hidden-dot { background: var(--orange); box-shadow: 0 0 10px var(--orange); animation: none; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.35} }

    .profile-chip {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 5px 12px 5px 5px;
      cursor: pointer; transition: all var(--transition);
      backdrop-filter: blur(12px);
    }
    .profile-chip:hover { border-color: rgba(99,179,255,0.3); background: var(--surface2); }
    .profile-chip:active { transform: scale(0.96); }
    .profile-chip-avatar {
      width: 26px; height: 26px; border-radius: 50%;
      background: var(--accent); display: flex; align-items: center;
      justify-content: center; font-size: 0.7rem; font-weight: 700;
    }
    .profile-chip-name { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ─── RIGHT SIDE BUTTONS ───────────────────────────── */
    .side-btns {
      position: fixed;
      right: calc(16px + var(--safe-right));
      bottom: calc(var(--safe-bottom) + 110px);
      z-index: 100;
      display: flex; flex-direction: column; gap: 10px; align-items: center;
    }
    .icon-btn {
      width: 44px; height: 44px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--transition);
      backdrop-filter: blur(12px);
    }
    .icon-btn:hover { border-color: rgba(99,179,255,0.3); background: var(--surface2); transform: scale(1.05); }
    .icon-btn:active { transform: scale(0.92); }
    .icon-btn svg { width: 18px; height: 18px; fill: var(--text); transition: fill 0.2s; }
    .icon-btn.active-btn { background: rgba(59,130,246,0.15); border-color: var(--accent); }
    .icon-btn.active-btn svg { fill: var(--accent); }

    /* ─── FAB ──────────────────────────────────────────── */
    .fab-container {
      position: fixed;
      right: calc(16px + var(--safe-right));
      bottom: calc(var(--safe-bottom) + 90px);
      z-index: 100;
      display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
    }
    .fab {
      border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .fab:hover { transform: scale(1.08); }
    .fab:active { transform: scale(0.9) !important; }
    .fab svg { fill: #fff; transition: transform 0.3s; }

    .fab-add {
      width: 50px; height: 50px;
      background: var(--accent); box-shadow: 0 4px 24px var(--accent-glow);
    }
    .fab-add svg { width: 22px; height: 22px; }

    .fab-visibility {
      width: 58px; height: 58px;
      background: var(--green); box-shadow: 0 4px 30px var(--green-glow);
    }
    .fab-visibility.vis-off {
      background: var(--orange); box-shadow: 0 4px 30px var(--orange-glow);
    }
    .fab-visibility svg { width: 26px; height: 26px; }

    /* ─── LOCATE ME ────────────────────────────────────── */
    .locate-me-btn {
      position: fixed;
      left: calc(16px + var(--safe-left));
      bottom: calc(var(--safe-bottom) + 110px);
      z-index: 100;
    }

    /* ─── CONTACTS PANEL ───────────────────────────────── */
    .contacts-panel {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      z-index: 90;
      transform: translateY(calc(100% - 72px));
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      max-height: 72vh;
      display: flex; flex-direction: column;
      padding-bottom: var(--safe-bottom);
      backdrop-filter: blur(20px);
      will-change: transform;
    }
    .contacts-panel.open { transform: translateY(0); }

    .panel-drag {
      padding: 10px 20px 6px;
      cursor: pointer; display: flex; flex-direction: column; gap: 8px;
    }
    .panel-handle {
      width: 36px; height: 4px; background: var(--border);
      border-radius: 2px; margin: 0 auto;
      transition: background 0.2s;
    }
    .contacts-panel:hover .panel-handle { background: rgba(99,179,255,0.25); }
    .panel-header { display: flex; align-items: center; justify-content: space-between; }
    .panel-title { font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .contact-count {
      font-family: var(--mono); font-size: 0.6rem;
      background: var(--surface2); border: 1px solid var(--border);
      padding: 2px 8px; border-radius: 20px; color: var(--text-muted);
    }
    .panel-arrow { width: 18px; height: 18px; fill: var(--text-muted); transition: transform 0.3s; }
    .contacts-panel.open .panel-arrow { transform: rotate(180deg); }

    .contacts-list {
      overflow-y: auto; padding: 4px 12px 12px;
      display: flex; flex-direction: column; gap: 6px; flex: 1;
      overscroll-behavior: contain;
    }
    .contacts-list::-webkit-scrollbar { display: none; }

    .contact-card {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 14px; padding: 12px 14px;
      display: flex; align-items: center; gap: 12px;
      transition: all var(--transition); cursor: pointer;
    }
    .contact-card:hover { border-color: rgba(99,179,255,0.25); transform: translateX(2px); }
    .contact-card:active { opacity: 0.7; transform: scale(0.98); }

    .contact-avatar {
      width: 38px; height: 38px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.95rem; flex-shrink: 0; position: relative;
    }
    .status-dot {
      position: absolute; bottom: -1px; right: -1px;
      width: 11px; height: 11px; border-radius: 50%;
      border: 2px solid var(--surface2);
      transition: background 0.3s, box-shadow 0.3s;
    }
    .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.offline { background: var(--orange); box-shadow: 0 0 4px var(--orange); }
    .status-dot.hidden-status { background: var(--text-muted); }

    .contact-info { flex: 1; overflow: hidden; }
    .contact-name { font-weight: 700; font-size: 0.88rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .contact-dist { font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); }

    .contact-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .mini-btn {
      width: 32px; height: 32px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--transition);
    }
    .mini-btn:hover { background: var(--accent); border-color: var(--accent); }
    .mini-btn:hover svg { fill: #fff; }
    .mini-btn:active { transform: scale(0.88); }
    .mini-btn svg { width: 13px; height: 13px; fill: var(--text-muted); transition: fill 0.2s; }
    .mini-btn.hide-user-btn.active { background: rgba(249,115,22,0.15); border-color: var(--orange); }
    .mini-btn.hide-user-btn.active svg { fill: var(--orange); }

    .empty-contacts {
      text-align: center; padding: 28px 16px;
      font-family: var(--mono); font-size: 0.72rem;
      color: var(--text-muted); line-height: 2;
    }

    /* ─── MODALS ───────────────────────────────────────── */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(4,8,18,0.88);
      backdrop-filter: blur(16px);
      z-index: 200;
      display: flex; align-items: flex-end; justify-content: center;
      padding: 0;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 28px 28px 0 0;
      padding: 20px 20px calc(20px + var(--safe-bottom));
      width: 100%; max-width: 480px;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      display: flex; flex-direction: column; gap: 16px;
      max-height: 92vh; overflow-y: auto;
    }
    .modal-overlay.open .modal { transform: translateY(0); }

    .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 4px; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.15rem; font-weight: 800; }
    .close-btn {
      width: 30px; height: 30px; background: var(--surface2);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1rem; color: var(--text-muted);
      transition: all 0.2s;
    }
    .close-btn:hover { background: rgba(239,68,68,0.15); color: var(--red); }

    /* QR */
    .qr-tabs { display: flex; gap: 6px; }
    .qr-tab {
      flex: 1; padding: 10px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; text-align: center;
      font-family: var(--mono); font-size: 0.62rem;
      color: var(--text-muted); cursor: pointer;
      text-transform: uppercase; letter-spacing: 0.05em;
      transition: all var(--transition);
    }
    .qr-tab:hover { border-color: rgba(99,179,255,0.25); color: var(--text); }
    .qr-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    #qr-display { display: flex; flex-direction: column; gap: 14px; align-items: center; }
    #qr-scan { display: none; flex-direction: column; gap: 10px; }
    #qrcode-container { background: #fff; padding: 14px; border-radius: 18px; display: inline-block; }
    #qrcode-container canvas, #qrcode-container img { display: block; }
    .qr-hint { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); text-align: center; line-height: 1.7; }

    #scan-video-container {
      position: relative; width: 100%; border-radius: 18px;
      overflow: hidden; background: #000; aspect-ratio: 1;
    }
    #scan-video { width: 100%; height: 100%; object-fit: cover; display: block; }
    .scan-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
    .scan-frame {
      width: 200px; height: 200px;
      border: 2px solid var(--accent); border-radius: 18px;
      box-shadow: 0 0 0 2000px rgba(0,0,0,0.45);
      position: relative;
    }
    .scan-line {
      position: absolute; left: 10px; right: 10px; height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      top: 0; animation: scan-move 2s ease-in-out infinite;
    }
    @keyframes scan-move { 0%{top:10px} 100%{top:calc(100% - 12px)} }
    #scan-status { font-family: var(--mono); font-size: 0.68rem; color: var(--text-muted); text-align: center; }

    /* Confirm */
    .confirm-avatar {
      width: 66px; height: 66px; background: var(--accent);
      border-radius: 50%; margin: 0 auto;
           --green: #22c55e;
      --red: #ef4444;
      --text: #e2eeff;
      --text-muted: #5a7aaa;
      --mono: 'Space Mono', monospace;
      --sans: 'Syne', sans-serif;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      width: 100%; height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      overflow: hidden;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* ─── SCREENS ─────────────────────────────────────── */
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 24px;
      transition: opacity 0.35s, transform 0.35s;
      z-index: 10;
    }
    .screen.hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }

    /* ─── AUTH SCREEN ─────────────────────────────────── */
    #auth-screen {
      background: var(--bg);
      gap: 32px;
    }
    .logo {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .logo-mark {
      width: 72px; height: 72px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 40px var(--accent-glow), inset 0 0 30px rgba(59,130,246,0.08);
      position: relative;
      animation: pulse-ring 3s ease-in-out infinite;
    }
    @keyframes pulse-ring {
      0%, 100% { box-shadow: 0 0 40px var(--accent-glow), inset 0 0 30px rgba(59,130,246,0.08); }
      50% { box-shadow: 0 0 80px var(--accent-glow), inset 0 0 50px rgba(59,130,246,0.15); }
    }
    .logo-mark::before {
      content: '';
      position: absolute;
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 1px solid rgba(99,179,255,0.3);
      animation: spin 8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .logo-mark svg { width: 28px; height: 28px; fill: var(--accent); }
    .logo h1 { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.02em; }
    .logo p { font-family: var(--mono); font-size: 0.7rem; color: var(--text-muted); letter-spacing: 0.2em; text-transform: uppercase; }

    .auth-form { width: 100%; max-width: 360px; display: flex; flex-direction: column; gap: 12px; }
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    .input-group label { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.1em; text-transform: uppercase; }
    .input-group input {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      color: var(--text);
      font-family: var(--mono);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      -webkit-appearance: none;
    }
    .input-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .btn {
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      font-family: var(--sans);
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.01em;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 0 30px var(--accent-glow);
    }
    .btn-primary:active { transform: scale(0.97); box-shadow: 0 0 15px var(--accent-glow); }
    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .btn-ghost:active { background: var(--surface); }

    .divider { text-align: center; font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); }
    .error-msg { font-family: var(--mono); font-size: 0.7rem; color: var(--red); text-align: center; min-height: 16px; }

    /* ─── MAP SCREEN ──────────────────────────────────── */
    #map-screen { padding: 0; background: transparent; }

    #map {
      position: fixed; inset: 0;
      z-index: 1;
    }

    /* Leaflet tiles dark */
    .leaflet-tile { filter: brightness(0.85) saturate(0.7) hue-rotate(200deg); }

    /* ─── TOP BAR ─────────────────────────────────────── */
    .top-bar {
      position: fixed;
      top: 0; left: 0; right: 0;
      padding: calc(var(--safe-top) + 12px) 16px 12px;
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(to bottom, rgba(4,8,18,0.95) 60%, transparent);
      z-index: 100;
    }
    .app-name {
      font-size: 1.3rem; font-weight: 800; letter-spacing: -0.02em;
      display: flex; align-items: center; gap: 8px;
    }
    .app-name .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 10px var(--green);
      animation: blink 2s ease-in-out infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .top-actions { display: flex; gap: 8px; }
    .icon-btn {
      width: 40px; height: 40px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }
    .icon-btn:active { transform: scale(0.9); }
    .icon-btn svg { width: 18px; height: 18px; fill: var(--text); }

    /* ─── FAB ─────────────────────────────────────────── */
    .fab-container {
      position: fixed;
      bottom: calc(var(--safe-bottom) + 100px);
      right: 20px;
      z-index: 100;
      display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
    }
    .fab {
      width: 56px; height: 56px;
      border-radius: 50%;
      border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
      position: relative;
    }
    .fab:active { transform: scale(0.9); }
    .fab-visibility {
      background: var(--green);
      box-shadow: 0 0 30px rgba(34,197,94,0.5);
    }
    .fab-visibility.off {
      background: var(--surface2);
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .fab-visibility svg { width: 24px; height: 24px; fill: #fff; }
    .fab-add {
      background: var(--accent);
      box-shadow: 0 0 30px var(--accent-glow);
      width: 48px; height: 48px;
    }
    .fab-add svg { width: 20px; height: 20px; fill: #fff; }

    /* ─── CONTACTS PANEL ─────────────────────────────── */
    .contacts-panel {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      z-index: 90;
      transform: translateY(calc(100% - 80px));
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      max-height: 75vh;
      display: flex; flex-direction: column;
      padding-bottom: var(--safe-bottom);
    }
    .contacts-panel.open { transform: translateY(0); }

    .panel-handle {
      width: 36px; height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 12px auto 0;
      cursor: pointer;
    }
    .panel-header {
      padding: 12px 20px 8px;
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer;
    }
    .panel-title {
      font-size: 1rem; font-weight: 700;
      display: flex; align-items: center; gap: 8px;
    }
    .contact-count {
      font-family: var(--mono);
      font-size: 0.65rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 20px;
      color: var(--text-muted);
    }

    .contacts-list {
      overflow-y: auto;
      padding: 0 16px 16px;
      display: flex; flex-direction: column; gap: 8px;
      flex: 1;
    }
    .contacts-list::-webkit-scrollbar { display: none; }

    .contact-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      display: flex; align-items: center; gap: 14px;
      transition: all 0.2s;
    }
    .contact-card:active { opacity: 0.7; }

    .contact-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1rem;
      flex-shrink: 0;
      position: relative;
    }
    .status-dot {
      position: absolute; bottom: -1px; right: -1px;
      width: 12px; height: 12px; border-radius: 50%;
      border: 2px solid var(--surface2);
    }
    .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.offline { background: var(--text-muted); }

    .contact-info { flex: 1; overflow: hidden; }
    .contact-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 2px; }
    .contact-dist { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); }

    .locate-btn {
      width: 34px; height: 34px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .locate-btn:active { background: var(--accent); border-color: var(--accent); }
    .locate-btn svg { width: 14px; height: 14px; fill: var(--text-muted); }
    .locate-btn:active svg { fill: #fff; }

    .empty-contacts {
      text-align: center; padding: 32px 16px;
      font-family: var(--mono); font-size: 0.75rem; color: var(--text-muted);
      line-height: 1.8;
    }

    /* ─── MODALS ─────────────────────────────────────── */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(4,8,18,0.92);
      backdrop-filter: blur(12px);
      z-index: 200;
      display: flex; align-items: center; justify-content: center;
      padding: 24px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 28px 24px;
      width: 100%; max-width: 360px;
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
      display: flex; flex-direction: column; gap: 20px;
    }
    .modal-overlay.open .modal { transform: scale(1) translateY(0); }

    .modal-header { display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.2rem; font-weight: 800; }
    .close-btn {
      width: 32px; height: 32px;
      background: var(--surface2);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 1.1rem; color: var(--text-muted);
    }

    /* QR Modal */
    .qr-tabs { display: flex; gap: 8px; }
    .qr-tab {
      flex: 1; padding: 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      text-align: center;
      font-family: var(--mono); font-size: 0.65rem;
      color: var(--text-muted);
      cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em;
      transition: all 0.2s;
    }
    .qr-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    #qr-display { display: flex; flex-direction: column; gap: 16px; align-items: center; }
    #qr-scan { display: none; flex-direction: column; gap: 12px; }

    #qrcode-container {
      background: #fff;
      padding: 16px;
      border-radius: 16px;
      display: inline-block;
    }
    #qrcode-container canvas, #qrcode-container img { display: block; }

    .qr-hint { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); text-align: center; line-height: 1.6; }

    #scan-video-container {
      position: relative;
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      aspect-ratio: 1;
    }
    #scan-video { width: 100%; height: 100%; object-fit: cover; }
    .scan-overlay {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
    }
    .scan-frame {
      width: 180px; height: 180px;
      border: 2px solid var(--accent);
      border-radius: 16px;
      box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
    }
    .scan-line {
      position: absolute; left: 50%; top: 50%;
      width: 160px; height: 2px;
      background: linear-gradient(to right, transparent, var(--accent), transparent);
      transform: translate(-50%, -50%);
      animation: scan-anim 2s ease-in-out infinite;
    }
    @keyframes scan-anim {
      0% { margin-top: -80px; }
      100% { margin-top: 80px; }
    }
    #scan-status { font-family: var(--mono); font-size: 0.7rem; color: var(--text-muted); text-align: center; }

    /* Confirm modal */
    .confirm-avatar {
      width: 64px; height: 64px;
      background: var(--accent);
      border-radius: 50%;
      margin: 0 auto;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.8rem; font-weight: 800;
      box-shadow: 0 0 30px var(--accent-glow);
    }
    .confirm-name { text-align: center; font-size: 1.1rem; font-weight: 700; }
    .confirm-sub { text-align: center; font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); }
    .confirm-actions { display: flex; gap: 10px; }
    .btn-danger { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }

    /* Locate me btn */
    .locate-me-btn {
      position: fixed;
      bottom: calc(var(--safe-bottom) + 170px);
      left: 20px;
      width: 44px; height: 44px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 100;
      backdrop-filter: blur(10px);
      transition: all 0.2s;
    }
    .locate-me-btn:active { background: var(--accent); border-color: var(--accent); }
    .locate-me-btn svg { width: 18px; height: 18px; fill: var(--text); }

    /* Notification toast */
    .toast {
      position: fixed;
      top: calc(var(--safe-top) + 70px);
      left: 50%; transform: translateX(-50%) translateY(-20px);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 10px 20px;
      font-family: var(--mono); font-size: 0.7rem;
      z-index: 300;
      white-space: nowrap;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Marker styles */
    .user-marker {
      width: 36px; height: 36px;
      border-radius: 50%;
      border: 3px solid #fff;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      cursor: pointer;
    }
    .my-marker {
      width: 16px; height: 16px;
      border-radius: 50%;
      background: var(--accent);
      border: 3px solid #fff;
      box-shadow: 0 0 20px var(--accent-glow);
    }
    .pulse-ring {
      position: absolute;
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid var(--accent);
      animation: expand 2s ease-out infinite;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }
    @keyframes expand {
      0% { width: 16px; height: 16px; opacity: 0.8; }
      100% { width: 60px; height: 60px; opacity: 0; }
    }

    /* Loading */
    .loader {
      width: 40px; height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Profile chip */
    .profile-chip {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 12px 6px 6px;
      cursor: pointer;
    }
    .profile-chip-avatar {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; font-weight: 700;
    }
    .profile-chip-name { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); }

    /* ── AUTH FOOTER ─────────────────────────────────────── */
    .auth-footer { font-family: var(--mono); font-size: 0.55rem; color: var(--text-muted); opacity: 0.45; text-align: center; margin-top: 4px; }

    /* ── HEADER DOT HIDDEN STATE ──────────────────────────── */
    .app-name .dot { transition: background 0.4s, box-shadow 0.4s; }
    .app-name .dot.vis-off { background: var(--orange) !important; box-shadow: 0 0 10px var(--orange) !important; animation: none !important; }

    /* ── FAB VIS STATES (override legacy) ────────────────── */
    .fab-visibility.vis-off { background: var(--orange) !important; box-shadow: 0 4px 30px var(--orange-glow) !important; }

    /* ── QR WAIT MODAL ───────────────────────────────────── */
    .qr-wait { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 14px; padding: 8px 0; }
    .qr-wait-spinner { width: 60px; height: 60px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.9s linear infinite; }
    .qr-wait-text { font-family: var(--mono); font-size: 0.72rem; color: var(--text-muted); line-height: 1.8; }
    .qr-wait-name { font-size: 1.1rem; font-weight: 800; }

    /* ── NAVIGATION MODAL ────────────────────────────────── */
    .nav-options { display: flex; flex-direction: column; gap: 8px; }
    .nav-option { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: var(--surface2); border: 1px solid var(--border); border-radius: 14px; cursor: pointer; transition: all var(--transition); text-decoration: none; color: var(--text); }
    .nav-option:hover { border-color: var(--accent); background: rgba(59,130,246,0.1); }
    .nav-option:active { transform: scale(0.97); opacity: 0.8; }
    .nav-option-icon { width: 40px; height: 40px; border-radius: 50%; background: rgba(59,130,246,0.12); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .nav-option-icon svg { width: 20px; height: 20px; fill: var(--accent); }
    .nav-option-label { font-weight: 700; font-size: 0.88rem; }
    .nav-option-sub { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); margin-top: 2px; }

    /* ── SETTINGS MODAL ──────────────────────────────────── */
    .settings-group { display: flex; flex-direction: column; gap: 6px; }
    .settings-group-label { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); letter-spacing: 0.1em; text-transform: uppercase; padding-left: 4px; margin-bottom: 2px; }
    .settings-item { display: flex; align-items: center; gap: 12px; padding: 13px 16px; background: var(--surface2); border: 1px solid var(--border); border-radius: 14px; cursor: pointer; transition: all var(--transition); }
    .settings-item:hover { border-color: rgba(99,179,255,0.25); }
    .settings-item:active { transform: scale(0.97); }
    .settings-item svg { width: 18px; height: 18px; fill: var(--text-muted); flex-shrink: 0; }
    .settings-item-text { flex: 1; }
    .settings-item-title { font-weight: 600; font-size: 0.88rem; }
    .settings-item-value { font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); margin-top: 1px; }
    .settings-item.danger svg { fill: var(--red); }
    .settings-item.danger .settings-item-title { color: var(--red); }
    .settings-item.danger { border-color: rgba(239,68,68,0.15); background: rgba(239,68,68,0.05); }

    /* ── COMPASS BAR ─────────────────────────────────────── */
    .compass-bar { position: fixed; top: calc(var(--safe-top) + 58px); left: 50%; transform: translateX(-50%); z-index: 100; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 5px 14px; font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); display: none; align-items: center; gap: 8px; backdrop-filter: blur(12px); white-space: nowrap; pointer-events: none; }
    .compass-bar.visible { display: flex; }
    .compass-needle { font-size: 1rem; display: inline-block; transition: transform 0.15s linear; }

    /* ── SIDE BUTTONS ────────────────────────────────────── */
    .side-btns { position: fixed; right: calc(16px + var(--safe-right)); bottom: calc(var(--safe-bottom) + 190px); z-index: 100; display: flex; flex-direction: column; gap: 10px; align-items: center; }

    /* ── SETTINGS OPEN BTN in TOP BAR ───────────────────── */
    .settings-btn { margin-left: 4px; }

    /* ── HAMBURGER MENU BTN ─────────────────────────────── */
    .hamburger-btn {
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; flex-shrink: 0; border: none; background: none; padding: 0;
    }
    .hamburger-btn svg { width: 22px; height: 22px; fill: var(--text); transition: fill 0.2s; }

    /* ── SIDEBAR DRAWER ─────────────────────────────────── */
    .sidebar-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.55);
      z-index: 150; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .sidebar-overlay.open { opacity: 1; pointer-events: all; }

    .sidebar {
      position: fixed; top: 0; left: 0; bottom: 0;
      width: 280px; max-width: 80vw;
      background: var(--surface);
      border-right: 1px solid var(--border);
      z-index: 160;
      transform: translateX(-100%);
      transition: transform 0.32s cubic-bezier(0.4,0,0.2,1);
      display: flex; flex-direction: column;
      padding: calc(var(--safe-top) + 16px) 16px var(--safe-bottom);
      overflow-y: auto;
    }
    .sidebar.open { transform: translateX(0); }

    .sidebar-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px; padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-title {
      font-size: 1.2rem; font-weight: 800;
      font-family: var(--sans);
    }
    .sidebar-close {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--surface2); border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1.1rem; color: var(--text-muted);
    }

    .sidebar-section-label {
      font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted);
      letter-spacing: 0.1em; text-transform: uppercase;
      padding-left: 4px; margin: 16px 0 8px;
    }

    .sidebar-contact {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 12px; border-radius: 12px;
      transition: background 0.2s; cursor: pointer;
    }
    .sidebar-contact:active { background: var(--surface2); }
    .sidebar-contact-avatar {
      width: 34px; height: 34px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.85rem; color: #fff; flex-shrink: 0;
      position: relative;
    }
    .sidebar-contact-name { font-size: 0.85rem; font-weight: 600; }
    .sidebar-contact-status { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); }
    .sidebar-contact .status-dot { width: 10px; height: 10px; border-width: 2px; }

    .sidebar-actions {
      display: flex; gap: 8px; margin-top: 16px; padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    .sidebar-action-btn {
      flex: 1; padding: 10px; border-radius: 12px;
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); font-family: var(--mono); font-size: 0.65rem;
      text-align: center; cursor: pointer; transition: all 0.2s;
    }
    .sidebar-action-btn:active { transform: scale(0.96); }
    .sidebar-action-btn svg { width: 16px; height: 16px; fill: var(--text-muted); display: block; margin: 0 auto 4px; }

    /* ── FAB HIDE ON SIDEBAR ────────────────────────────── */
    .fab-container.sidebar-hidden,
    .locate-me-btn.sidebar-hidden,
    .side-btns.sidebar-hidden {
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s ease;
    }
    .fab-container,
    .locate-me-btn,
    .side-btns {
      transition: opacity 0.25s ease;
    }

    /* ── TITLE GRADIENT ─────────────────────────────────── */
    .app-name-text {
      font-family: var(--sans);
      font-weight: 800;
      font-size: 1.3rem;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: filter 0.3s;
    }
    .app-name-text:hover {
      filter: drop-shadow(0 0 8px rgba(59,130,246,0.5));
    }

    /* ── ARROW MARKER (compass mode) ───────────────────── */
    .my-marker-arrow {
      width: 0; height: 0; position: relative;
    }
    .my-marker-arrow svg {
      width: 32px; height: 32px;
      filter: drop-shadow(0 0 6px var(--accent-glow));
      transition: transform 0.15s linear;
    }

    /* ── MARKER COLOR CODING ───────────────────────────── */
    .my-marker.marker-green { background: var(--green); box-shadow: 0 0 20px var(--green-glow); }
    .my-marker.marker-orange { background: var(--orange); box-shadow: 0 0 20px var(--orange-glow); }
    .my-marker.marker-red { background: var(--red); box-shadow: 0 0 20px rgba(239,68,68,0.4); }
    .pulse-ring.marker-green { border-color: var(--green); }
    .pulse-ring.marker-orange { border-color: var(--orange); }
    .pulse-ring.marker-red { border-color: var(--red); }

    /* ── GHOST MODE INDICATOR ──────────────────────────── */
    .ghost-indicator {
      position: fixed;
      top: calc(var(--safe-top) + 58px);
      right: 16px;
      z-index: 110;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 20px;
      padding: 5px 12px;
      font-family: var(--mono); font-size: 0.6rem;
      color: var(--red);
      display: none; align-items: center; gap: 6px;
      backdrop-filter: blur(12px);
    }
    .ghost-indicator.visible { display: flex; }
    .ghost-indicator-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--red);
      animation: blink 1.5s ease-in-out infinite;
    }

    /* ── BATTERY DISPLAY ───────────────────────────────── */
    .battery-chip {
      font-family: var(--mono); font-size: 0.58rem;
      color: var(--text-muted);
      display: flex; align-items: center; gap: 3px;
      margin-left: 4px;
    }
    .battery-chip svg { width: 12px; height: 12px; fill: var(--text-muted); }
    .battery-chip.low svg { fill: var(--red); }
    .battery-chip.low { color: var(--red); }
    .contact-battery {
      font-family: var(--mono); font-size: 0.58rem;
      color: var(--text-muted);
      display: inline-flex; align-items: center; gap: 2px;
    }
    .contact-battery svg { width: 10px; height: 10px; fill: var(--text-muted); }

    /* ── DARK / LIGHT MODE ─────────────────────────────── */
    body.light-mode {
      --bg: #f0f4f8;
      --surface: rgba(255,255,255,0.97);
      --surface2: rgba(240,244,248,0.95);
      --border: rgba(0,0,0,0.1);
      --text: #1a202c;
      --text-muted: #718096;
    }
    body.light-mode .top-bar {
      background: linear-gradient(to bottom, rgba(240,244,248,0.95) 60%, transparent);
    }
    body.light-mode .leaflet-tile { filter: none; }
    body.light-mode .my-marker { border-color: #333; }
    body.light-mode .user-marker { border-color: #333; }

    .toggle-switch {
      position: relative; display: inline-block;
      width: 44px; height: 24px; flex-shrink: 0;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; inset: 0;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .toggle-slider::before {
      content: '';
      position: absolute; left: 2px; top: 2px;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: all 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider {
      background: var(--accent); border-color: var(--accent);
    }
    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(20px);
      background: #fff;
    }

    /* ── GEOFENCE MODAL ────────────────────────────────── */
    .geofence-list {
      display: flex; flex-direction: column; gap: 8px;
      max-height: 200px; overflow-y: auto;
    }
    .geofence-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; background: var(--surface2);
      border: 1px solid var(--border); border-radius: 12px;
    }
    .geofence-item-info { flex: 1; }
    .geofence-item-name { font-weight: 600; font-size: 0.85rem; }
    .geofence-item-radius { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); }
    .geofence-item-remove {
      width: 28px; height: 28px; border-radius: 50%;
      background: rgba(239,68,68,0.1); border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--red); font-size: 0.9rem;
    }
    .geofence-form { display: flex; flex-direction: column; gap: 8px; }
    .geofence-form input {
      width: 100%; padding: 10px 14px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text);
      font-family: var(--mono); font-size: 0.75rem;
      outline: none;
    }
    .geofence-form input:focus { border-color: var(--accent); }
    .geofence-form .geofence-row { display: flex; gap: 8px; }
    .geofence-form .geofence-row input { flex: 1; }

    /* ── ORIZON WORLD MODAL ─────────────────────────────── */
    .orizon-world-content {
      display: flex; flex-direction: column; gap: 18px;
      max-height: 55vh; overflow-y: auto;
      padding-right: 4px;
    }
    .orizon-world-section { }
    .orizon-world-section h3 {
      font-size: 0.9rem; font-weight: 700;
      margin-bottom: 6px; color: var(--accent);
    }
    .orizon-world-section p {
      font-family: var(--mono); font-size: 0.68rem;
      color: var(--text-muted); line-height: 1.7;
    }

    /* ── LAST SEEN PROMINENT ───────────────────────────── */
    .contact-last-seen {
      font-family: var(--mono); font-size: 0.6rem;
      color: var(--orange); margin-top: 1px;
    }

    /* ── CONTACT CARD BATTERY ──────────────────────────── */
    .contact-card-meta {
      display: flex; align-items: center; gap: 6px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="screen" id="auth-screen">
  <div class="logo">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
    </div>
    <h1>Orizon</h1>
    <p>Real-time location sharing</p>
  </div>

  <div class="auth-form" id="auth-form">
    <div id="auth-login">
      <div class="input-group" style="margin-bottom:12px">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="tu@email.com" autocomplete="email" />
      </div>
      <div class="input-group" style="margin-bottom:16px">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="••••••••" autocomplete="current-password" />
      </div>
      <button class="btn btn-primary" onclick="handleLogin()" style="width:100%;margin-bottom:10px">Accedi</button>
      <div class="divider">— oppure —</div>
      <button class="btn btn-ghost" onclick="showRegister()" style="width:100%;margin-top:10px">Crea account</button>
    </div>

    <div id="auth-register" style="display:none">
      <div class="input-group" style="margin-bottom:12px">
        <label>Nome visualizzato</label>
        <input type="text" id="reg-name" placeholder="Il tuo nome" autocomplete="name" />
      </div>
      <div class="input-group" style="margin-bottom:12px">
        <label>Email</label>
        <input type="email" id="reg-email" placeholder="tu@email.com" autocomplete="email" />
      </div>
      <div class="input-group" style="margin-bottom:16px">
        <label>Password</label>
        <input type="password" id="reg-password" placeholder="min. 8 caratteri" autocomplete="new-password" />
      </div>
      <button class="btn btn-primary" onclick="handleRegister()" style="width:100%;margin-bottom:10px">Registrati</button>
      <button class="btn btn-ghost" onclick="showLogin()" style="width:100%;margin-top:4px">Ho già un account</button>
    </div>

    <p class="error-msg" id="auth-error"></p>
  </div>
  <div class="auth-footer">v1.0.0 · Build 202405</div>
</div>

<!-- VERIFIED SCREEN -->
<div class="screen hidden" id="verified-screen">
  <div class="verified-icon">
    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
  </div>
  <div class="verified-title">Email Verificata!</div>
  <div class="verified-sub">Il tuo account è stato verificato con successo.<br/>Ora puoi accedere a Orizon.</div>
  <button class="btn btn-primary" style="width:100%;max-width:280px;margin-top:8px" onclick="goToMapFromVerified()">Vai alla Mappa →</button>
</div>

<!-- MAP SCREEN -->
<div class="screen hidden" id="map-screen">
  <div id="map"></div>

  <!-- Top Bar -->
  <div class="top-bar">
    <div style="display:flex;align-items:center;gap:8px">
      <button class="hamburger-btn" onclick="openSidebar()" aria-label="Menu">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      </button>
      <div class="app-name">
        <div class="dot" id="tracking-dot"></div>
        <span class="app-name-text">Orizon</span>
      </div>
    </div>
    <div class="top-actions">
      <div class="profile-chip" onclick="openSettings()">
        <div class="profile-chip-avatar" id="profile-avatar">?</div>
        <span class="profile-chip-name" id="profile-name">...</span>
        <span class="battery-chip" id="battery-chip" style="display:none">
          <svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></svg>
          <span id="battery-level">--</span>
        </span>
      </div>
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- Sidebar Drawer -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">Cerchia</div>
      <button class="sidebar-close" onclick="closeSidebar()">✕</button>
    </div>
    <div class="sidebar-section-label">Contatti</div>
    <div id="sidebar-contacts-list"></div>
    <div class="sidebar-actions">
      <div class="sidebar-action-btn" onclick="closeSidebar();openQRModal()">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        Aggiungi
      </div>
      <div class="sidebar-action-btn" onclick="closeSidebar();togglePanel()">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
        Pannello
      </div>
    </div>
  </div>

  <!-- Ghost Mode Indicator -->
  <div class="ghost-indicator" id="ghost-indicator">
    <div class="ghost-indicator-dot"></div>
    GHOST MODE
  </div>

  <!-- Compass Bar (hidden, replaced by arrow marker) -->
  <div class="compass-bar" id="compass-bar" style="display:none">
    <span class="compass-needle" id="compass-needle">🧭</span>
    <span id="compass-text">N 0°</span>
  </div>

  <!-- Side Buttons -->
  <div class="side-btns">
    <div class="icon-btn" id="compass-btn" onclick="toggleCompass()" title="Modalità bussola">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13l-2 5.5 5.5-2L16 5l-5 .5z"/><circle cx="12" cy="12" r="1.5"/></svg>
    </div>
  </div>

  <!-- Locate Me -->
  <div class="locate-me-btn" onclick="centerOnMe()">
    <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
  </div>

  <!-- FABs -->
  <div class="fab-container">
    <div class="fab fab-add" onclick="openQRModal()" title="Aggiungi contatto">
      <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </div>
    <div class="fab fab-visibility" id="visibility-fab" onclick="toggleVisibility()">
      <svg viewBox="0 0 24 24" id="vis-icon"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
    </div>
  </div>

  <!-- Contacts Panel -->
  <div class="contacts-panel" id="contacts-panel">
    <div class="panel-handle" onclick="togglePanel()"></div>
    <div class="panel-header" onclick="togglePanel()">
      <div class="panel-title">
        Cerchia
        <span class="contact-count" id="contact-count">0</span>
      </div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--text-muted)" id="panel-arrow">
        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
      </svg>
    </div>
    <div class="contacts-list" id="contacts-list">
      <div class="empty-contacts">
        Nessun contatto ancora.<br/>
        Premi + per aggiungere qualcuno<br/>
        alla tua cerchia.
      </div>
    </div>
  </div>
</div>

<!-- QR MODAL -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Aggiungi contatto</div>
      <div class="close-btn" onclick="closeQRModal()">✕</div>
    </div>

    <div class="qr-tabs">
      <div class="qr-tab active" id="tab-show" onclick="switchTab('show')">Il mio QR</div>
      <div class="qr-tab" id="tab-scan" onclick="switchTab('scan')">Scansiona</div>
    </div>

    <div id="qr-display">
      <div id="qrcode-container"></div>
      <p class="qr-hint">Fai scansionare questo codice<br/>da un amico per connettervi</p>
    </div>

    <div id="qr-scan">
      <div id="scan-video-container">
        <video id="scan-video" playsinline autoplay muted></video>
        <div class="scan-overlay">
          <div class="scan-frame"></div>
          <div class="scan-line"></div>
        </div>
      </div>
      <p id="scan-status">Punta la fotocamera sul QR code dell'amico</p>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL (for QR shower: accept/reject incoming request) -->
<div class="modal-overlay" id="confirm-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Nuova connessione</div>
      <div class="close-btn" onclick="rejectIncomingRequest()">✕</div>
    </div>
    <div class="confirm-avatar" id="confirm-avatar">?</div>
    <div class="confirm-name" id="confirm-name">—</div>
    <div class="confirm-sub">Vuole aggiungerti alla sua cerchia.<br/>Vuoi accettare?</div>
    <div class="confirm-actions">
      <button class="btn btn-danger" style="flex:1" onclick="rejectIncomingRequest()">Rifiuta</button>
      <button class="btn btn-primary" style="flex:1" onclick="acceptIncomingRequest()">Accetta ✓</button>
    </div>
  </div>
</div>

<!-- QR WAIT MODAL (for scanner: waiting for shower to confirm) -->
<div class="modal-overlay" id="qr-wait-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Richiesta inviata</div>
      <div class="close-btn" onclick="closeQRWaitModal()">✕</div>
    </div>
    <div class="qr-wait">
      <div class="qr-wait-spinner"></div>
      <div class="qr-wait-name" id="qr-wait-name">—</div>
      <div class="qr-wait-text">Attendi che l'altro utente<br/>accetti la connessione...</div>
    </div>
  </div>
</div>

<!-- NAVIGATION MODAL (transport selection) -->
<div class="modal-overlay" id="nav-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Navigazione</div>
      <div class="close-btn" onclick="closeNavModal()">✕</div>
    </div>
    <div style="font-family:var(--mono);font-size:0.62rem;color:var(--text-muted);text-align:center">
      Apri Google Maps verso <strong id="nav-target-name">—</strong>
    </div>
    <div class="nav-options">
      <div class="nav-option" onclick="openGoogleMaps('w')">
        <div class="nav-option-icon"><svg viewBox="0 0 24 24"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg></div>
        <div>
          <div class="nav-option-label">A piedi</div>
          <div class="nav-option-sub">Percorso pedonale</div>
        </div>
      </div>
      <div class="nav-option" onclick="openGoogleMaps('d')">
        <div class="nav-option-icon"><svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg></div>
        <div>
          <div class="nav-option-label">In auto</div>
          <div class="nav-option-sub">Percorso in auto</div>
        </div>
      </div>
      <div class="nav-option" onclick="openGoogleMaps('r')">
        <div class="nav-option-icon"><svg viewBox="0 0 24 24"><path d="M12 2c-4.42 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2.23l2-2H14l2 2H18v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-3.58-4-8-4zm0 2c3.62 0 5.5.46 5.93 1.5H6.07C6.5 4.46 8.38 4 12 4zm-.5 6.5h-4v-3h4v3zm1 0v-3h4v3h-4z"/></svg></div>
        <div>
          <div class="nav-option-label">Trasporto pubblico</div>
          <div class="nav-option-sub">Bus, metro, treno</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">Impostazioni</div>
      <div class="close-btn" onclick="closeSettings()">✕</div>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">Profilo</div>
      <div class="settings-item" style="cursor:default">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title" id="settings-name">—</div>
          <div class="settings-item-value" id="settings-email">—</div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">Aspetto</div>
      <div class="settings-item" style="cursor:default">
        <svg viewBox="0 0 24 24"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Modalità Chiara</div>
          <div class="settings-item-value">Cambia tema colori</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">Privacy</div>
      <div class="settings-item" onclick="toggleGhostMode()" id="ghost-mode-item">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Ghost Mode</div>
          <div class="settings-item-value" id="ghost-mode-status">Disattivato · La posizione si aggiorna</div>
        </div>
      </div>
      <div class="settings-item" onclick="openGeofenceModal()">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Geofence</div>
          <div class="settings-item-value">Notifiche di zona per i contatti</div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">Info</div>
      <div class="settings-item" style="cursor:default">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Orizon</div>
          <div class="settings-item-value">Versione 1.0.0 · Build 202405</div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">Scopri</div>
      <div class="settings-item" onclick="openOrizonWorld()">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Il Mondo Orizon</div>
          <div class="settings-item-value">Scopri la visione e le funzionalità</div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-item danger" onclick="handleLogout()">
        <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Esci</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- GEOFENCE MODAL -->
<div class="modal-overlay" id="geofence-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Geofence</div>
      <div class="close-btn" onclick="closeGeofenceModal()">✕</div>
    </div>
    <div class="geofence-list" id="geofence-list"></div>
    <div class="geofence-form">
      <input type="text" id="geofence-name" placeholder="Nome del luogo (es. Casa)">
      <div class="geofence-row">
        <input type="number" id="geofence-lat" placeholder="Latitudine" step="any">
        <input type="number" id="geofence-lng" placeholder="Longitudine" step="any">
      </div>
      <input type="number" id="geofence-radius" placeholder="Raggio in metri (es. 500)" min="50" step="50">
      <button class="btn btn-primary" style="width:100%" onclick="addGeofence()">Aggiungi Geofence</button>
      <button class="btn" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-size:0.7rem" onclick="useCurrentPositionForGeofence()">📍 Usa posizione attuale</button>
    </div>
  </div>
</div>

<!-- IL MONDO ORIZON MODAL -->
<div class="modal-overlay" id="orizon-world-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Il Mondo Orizon</div>
      <div class="close-btn" onclick="closeOrizonWorld()">✕</div>
    </div>
    <div class="orizon-world-content">
      <div class="orizon-world-section">
        <h3>🌍 Obiettivo</h3>
        <p>Orizon nasce con la missione di connettere le persone in modo sicuro e trasparente. Crediamo che sapere dove si trovano i propri cari porti tranquillità e rafforzi i legami. La nostra visione è un mondo dove la condivisione della posizione è un gesto di fiducia, non di controllo.</p>
      </div>
      <div class="orizon-world-section">
        <h3>🧭 Guida Funzionalità</h3>
        <p><strong>Bussola & Giroscopio:</strong> Attiva la modalità bussola per trasformare il tuo indicatore in una freccia direzionale che segue l'orientamento del dispositivo. Perfetto per navigare verso i tuoi amici.</p>
        <p><strong>Gestione Cerchia:</strong> Usa il menu laterale per vedere rapidamente i tuoi contatti. Aggiungi amici scansionando il QR code. Puoi nascondere singoli contatti dalla mappa mantenendo la connessione.</p>
        <p><strong>Ghost Mode:</strong> Congela la tua posizione quando hai bisogno di privacy. La tua ultima posizione nota rimarrà visibile ma non si aggiornerà.</p>
        <p><strong>Geofence:</strong> Imposta zone virtuali e ricevi notifiche quando un contatto entra o esce da un'area definita.</p>
      </div>
      <div class="orizon-world-section">
        <h3>🔒 Privacy Manifesto</h3>
        <p>La privacy è al centro di Orizon. I tuoi dati di posizione sono criptati e accessibili solo ai contatti che hai esplicitamente approvato. Non vendiamo, non condividiamo e non analizziamo i tuoi dati per scopi pubblicitari.</p>
        <p>Hai sempre il pieno controllo: puoi attivare il Ghost Mode, nascondere singoli contatti o disattivare completamente la visibilità con un solo tocco. I dati di posizione vengono aggiornati in tempo reale e non vengono conservati come storico.</p>
      </div>
    </div>
  </div>
</div>

<script>
// ─── CONFIG ─────────────────────────────────────────────
// Replace with your Supabase project URL and anon key
const SUPABASE_URL = window.SUPABASE_URL || 'https://slqgdewtdbugoofthcao.supabase.co';
const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscWdkZXd0ZGJ1Z29vZnRoY2FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyODMzOTYsImV4cCI6MjA4Nzg1OTM5Nn0.Gj9FKhlHdTBLOAvhwWV07RFz22A-BQJh6RwzufI0ehw';

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true }
});

// ─── STATE ───────────────────────────────────────────────
let currentUser = null;
let userProfile = null;
let map = null;
let myMarker = null;
let myPulse = null;
let contactMarkers = {};
let isVisible = true;
let visibilityState = 'visible'; // 'visible' | 'limited' | 'ghost'
let panelOpen = false;
let geoWatcher = null;
let realtimeChannel = null;
let pendingConnection = null;
let scanAnimFrame = null;
let videoStream = null;
let contacts = [];
let compassMode = false;
let compassHeading = 0;
let ghostMode = false;
let frozenLat = null;
let frozenLng = null;
let batteryLevel = null;
let geofences = (() => { try { return JSON.parse(localStorage.getItem('orizon_geofences') || '[]'); } catch { return []; } })();
let geofenceStates = {};
let hiddenUsers = (() => { try { return JSON.parse(localStorage.getItem('orizon_hidden_users') || '[]'); } catch { return []; } })();
let navTargetLat = null;
let navTargetLng = null;
let darkTileLayer = null;
let lightTileLayer = null;

// ─── INIT ────────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', async () => {
  // Check for email verification redirect (Supabase v2 uses hash fragment)
  const hash = new URLSearchParams(window.location.hash.slice(1));
  const hashType = hash.get('type');
  if (hashType === 'email_confirmation' || hashType === 'signup') {
    // Supabase already processes the token; get resulting session
    const { data: { session } } = await db.auth.getSession();
    if (session) {
      currentUser = session.user;
      await loadUserProfile();
    }
    history.replaceState({}, '', '/');
    showVerifiedScreen();
    return;
  }

  const { data: { session } } = await db.auth.getSession();
  if (session) {
    currentUser = session.user;
    await loadUserProfile();
    showMapScreen();
  }

  db.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
      currentUser = session.user;
    }
  });

  // Check for QR token in URL
  const params = new URLSearchParams(window.location.search);
  const qrToken = params.get('connect');
  if (qrToken) {
    window.pendingQRToken = qrToken;
    history.replaceState({}, '', '/');
  }
});

// ─── AUTH ────────────────────────────────────────────────
function showVerifiedScreen() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('verified-screen').classList.remove('hidden');
}

async function goToMapFromVerified() {
  document.getElementById('verified-screen').classList.add('hidden');
  const { data: { session } } = await db.auth.getSession();
  if (session) {
    currentUser = session.user;
    if (!userProfile) await loadUserProfile();
    showMapScreen();
  } else {
    document.getElementById('auth-screen').classList.remove('hidden');
  }
}

function showRegister() {
  document.getElementById('auth-login').style.display = 'none';
  document.getElementById('auth-register').style.display = 'block';
}
function showLogin() {
  document.getElementById('auth-login').style.display = 'block';
  document.getElementById('auth-register').style.display = 'none';
}

async function handleLogin() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  setAuthError('');

  const { data, error } = await db.auth.signInWithPassword({ email, password });
  if (error) return setAuthError(error.message);

  currentUser = data.user;
  await loadUserProfile();
  showMapScreen();
}

async function handleRegister() {
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  setAuthError('');

  if (!name) return setAuthError('Inserisci il tuo nome.');
  if (password.length < 8) return setAuthError('Password minimo 8 caratteri.');

  const { data, error } = await db.auth.signUp({
    email, password,
    options: { data: { display_name: name } }
  });
  if (error) return setAuthError(error.message);

  // If email confirmation required, show message
  if (!data.session) {
    setAuthError('');
    document.getElementById('auth-error').style.color = 'var(--green)';
    document.getElementById('auth-error').textContent = '✓ Controlla la tua email per verificare l\'account.';
    return;
  }

  currentUser = data.user;
  // Create profile
  await db.from('profiles').upsert({
    id: currentUser.id,
    display_name: name,
    email: email
  });

  await loadUserProfile();
  showMapScreen();
}

async function handleLogout() {
  closeSettings();
  if (!confirm('Vuoi uscire da Orizon?')) return;
  stopGeolocation();
  stopCompass();
  if (realtimeChannel) db.removeChannel(realtimeChannel);
  await db.auth.signOut();
  currentUser = null; userProfile = null;
  document.getElementById('map-screen').classList.add('hidden');
  document.getElementById('auth-screen').classList.remove('hidden');
}

// ─── SETTINGS ────────────────────────────────────────────
function openSettings() {
  const name = userProfile?.display_name || currentUser?.email?.split('@')[0] || '—';
  const email = userProfile?.email || currentUser?.email || '—';
  document.getElementById('settings-name').textContent = name;
  document.getElementById('settings-email').textContent = email;
  document.getElementById('settings-modal').classList.add('open');
}
function closeSettings() {
  document.getElementById('settings-modal').classList.remove('open');
}

function setAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.style.color = '';
  el.textContent = msg;
}

async function loadUserProfile() {
  let { data } = await db.from('profiles').select('*').eq('id', currentUser.id).single();
  if (!data) {
    // Create from auth metadata
    const name = currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
    await db.from('profiles').upsert({ id: currentUser.id, display_name: name, email: currentUser.email });
    data = { id: currentUser.id, display_name: name, email: currentUser.email };
  }
  userProfile = data;
}

// ─── MAP SCREEN ──────────────────────────────────────────
function showMapScreen() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('map-screen').classList.remove('hidden');

  // Update profile UI
  const name = userProfile?.display_name || currentUser.email.split('@')[0];
  document.getElementById('profile-name').textContent = name.split(' ')[0];
  document.getElementById('profile-avatar').textContent = name[0].toUpperCase();

  setTimeout(() => {
    initMap();
    startGeolocation();
    loadContacts();
    subscribeRealtime();

    if (window.pendingQRToken) {
      handleIncomingQR(window.pendingQRToken);
      window.pendingQRToken = null;
    }
  }, 300);
}

// ─── MAP ─────────────────────────────────────────────────
function initMap() {
  if (map) return;
  map = L.map('map', {
    center: [41.9, 12.5],
    zoom: 13,
    zoomControl: false,
    attributionControl: false
  });

  darkTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  });
  lightTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  });

  const isLight = localStorage.getItem('orizon_theme') === 'light';
  if (isLight) {
    document.body.classList.add('light-mode');
    document.getElementById('theme-toggle').checked = true;
    lightTileLayer.addTo(map);
  } else {
    darkTileLayer.addTo(map);
  }

  initBattery();
}

function getMarkerColorClass() {
  if (ghostMode || visibilityState === 'ghost') return 'marker-red';
  if (visibilityState === 'limited') return 'marker-orange';
  return 'marker-green';
}

function createMyMarker(lat, lng) {
  if (myMarker) {
    myMarker.setLatLng([lat, lng]);
    updateMyMarkerAppearance();
    return;
  }

  const el = document.createElement('div');
  el.style.cssText = 'position:relative;width:16px;height:16px;';
  el.id = 'my-marker-container';

  if (compassMode) {
    el.style.cssText = 'position:relative;width:32px;height:32px;';
    el.innerHTML = `<div class="my-marker-arrow"><svg viewBox="0 0 24 24" fill="${ghostMode ? 'var(--red)' : 'var(--accent)'}"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg></div>`;
    myMarker = L.marker([lat, lng], {
      icon: L.divIcon({ html: el, className: '', iconSize: [32, 32], iconAnchor: [16, 16] })
    }).addTo(map);
  } else {
    const colorClass = getMarkerColorClass();
    el.innerHTML = `<div class="my-marker ${colorClass}"></div><div class="pulse-ring ${colorClass}"></div>`;
    myMarker = L.marker([lat, lng], {
      icon: L.divIcon({ html: el, className: '', iconSize: [16, 16], iconAnchor: [8, 8] })
    }).addTo(map);
  }
}

function updateMyMarkerAppearance() {
  if (!myMarker) return;
  const container = document.getElementById('my-marker-container');
  if (!container) return;

  if (compassMode) {
    container.style.cssText = 'position:relative;width:32px;height:32px;';
    const fillColor = ghostMode ? 'var(--red)' : (visibilityState === 'limited' ? 'var(--orange)' : 'var(--accent)');
    container.innerHTML = `<div class="my-marker-arrow"><svg viewBox="0 0 24 24" fill="${fillColor}"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg></div>`;
    const latlng = myMarker.getLatLng();
    myMarker.setIcon(L.divIcon({ html: container, className: '', iconSize: [32, 32], iconAnchor: [16, 16] }));
  } else {
    container.style.cssText = 'position:relative;width:16px;height:16px;';
    const colorClass = getMarkerColorClass();
    container.innerHTML = `<div class="my-marker ${colorClass}"></div><div class="pulse-ring ${colorClass}"></div>`;
    myMarker.setIcon(L.divIcon({ html: container, className: '', iconSize: [16, 16], iconAnchor: [8, 8] }));
  }
}

function updateContactMarker(contact, lat, lng) {
  // Don't show marker if user is in hidden list
  if (hiddenUsers.includes(contact.id)) {
    removeContactMarker(contact.id);
    return;
  }

  const name = contact.display_name || '?';
  const initial = name[0].toUpperCase();
  const colors = ['#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981'];
  const color = colors[name.charCodeAt(0) % colors.length];

  if (contactMarkers[contact.id]) {
    contactMarkers[contact.id].setLatLng([lat, lng]);
    return;
  }

  const el = document.createElement('div');
  el.className = 'user-marker';
  el.style.background = color;
  el.style.color = '#fff';
  el.textContent = initial;
  el.title = name;
  el.onclick = () => {
    map.flyTo([lat, lng], 16, { duration: 1 });
    openNavModal(name, lat, lng);
  };

  contactMarkers[contact.id] = L.marker([lat, lng], {
    icon: L.divIcon({ html: el, className: '', iconSize: [36, 36], iconAnchor: [18, 18] })
  }).addTo(map);
}

function removeContactMarker(userId) {
  if (contactMarkers[userId]) {
    map.removeLayer(contactMarkers[userId]);
    delete contactMarkers[userId];
  }
}

function centerOnMe() {
  if (myMarker) {
    map.flyTo(myMarker.getLatLng(), 16, { duration: 1 });
  }
}

// ─── GEOLOCATION ─────────────────────────────────────────
function startGeolocation() {
  if (!navigator.geolocation) return showToast('GPS non supportato');

  geoWatcher = navigator.geolocation.watchPosition(
    async (pos) => {
      const { latitude: lat, longitude: lng } = pos.coords;

      if (ghostMode) {
        // In ghost mode, show marker at frozen position
        createMyMarker(frozenLat || lat, frozenLng || lng);
        if (!frozenLat) { frozenLat = lat; frozenLng = lng; }
        return;
      }

      createMyMarker(lat, lng);

      if (!myMarker._hasCentered) {
        map.setView([lat, lng], 15);
        myMarker._hasCentered = true;
      }

      // Update DB
      const upsertData = {
        user_id: currentUser.id,
        lat, lng,
        is_visible: isVisible,
        last_seen: new Date().toISOString()
      };
      if (batteryLevel !== null) upsertData.battery = batteryLevel;

      await db.from('locations').upsert(upsertData, { onConflict: 'user_id' });

      // Check geofences
      checkGeofences();
    },
    (err) => showToast('Errore GPS: ' + err.message),
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
  );
}

function stopGeolocation() {
  if (geoWatcher !== null) {
    navigator.geolocation.clearWatch(geoWatcher);
    geoWatcher = null;
  }
}

// ─── VISIBILITY ───────────────────────────────────────────
async function toggleVisibility() {
  // Cycle through: visible -> limited -> ghost -> visible
  const states = ['visible', 'limited', 'ghost'];
  const idx = states.indexOf(visibilityState);
  visibilityState = states[(idx + 1) % 3];

  const fab = document.getElementById('visibility-fab');
  const icon = document.getElementById('vis-icon');
  const dot = document.getElementById('tracking-dot');

  if (visibilityState === 'visible') {
    isVisible = true;
    fab.classList.remove('off', 'vis-off');
    fab.style.background = '';
    fab.style.boxShadow = '';
    icon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
    dot.style.background = 'var(--green)';
    dot.style.boxShadow = '0 0 10px var(--green)';
    dot.classList.remove('vis-off', 'hidden-dot');
    showToast('Posizione visibile a tutti ✓');
  } else if (visibilityState === 'limited') {
    isVisible = true;
    fab.classList.add('vis-off');
    fab.classList.remove('off');
    fab.style.background = 'var(--orange)';
    fab.style.boxShadow = '0 4px 30px var(--orange-glow)';
    icon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
    dot.style.background = 'var(--orange)';
    dot.style.boxShadow = '0 0 10px var(--orange)';
    dot.classList.add('vis-off');
    showToast('Visibilità limitata 🔶');
  } else {
    isVisible = false;
    fab.classList.add('vis-off');
    fab.style.background = 'var(--red)';
    fab.style.boxShadow = '0 4px 30px rgba(239,68,68,0.4)';
    icon.innerHTML = '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>';
    dot.style.background = 'var(--red)';
    dot.style.boxShadow = '0 0 10px var(--red)';
    dot.classList.add('vis-off');
    showToast('Posizione nascosta a tutti 🔴');
  }

  updateMyMarkerAppearance();

  await db.from('locations').update({ is_visible: isVisible })
    .eq('user_id', currentUser.id);
}

// ─── CONTACTS ────────────────────────────────────────────
async function loadContacts() {
  // Get accepted connections
  const { data: conns } = await db.from('connections')
    .select('user_a, user_b, status')
    .or(`user_a.eq.${currentUser.id},user_b.eq.${currentUser.id}`)
    .eq('status', 'accepted');

  if (!conns || conns.length === 0) return;

  const contactIds = conns.map(c =>
    c.user_a === currentUser.id ? c.user_b : c.user_a
  );

  const { data: profiles } = await db.from('profiles')
    .select('*').in('id', contactIds);

  contacts = profiles || [];
  document.getElementById('contact-count').textContent = contacts.length;

  // Load their locations
  const { data: locs } = await db.from('locations')
    .select('*').in('user_id', contactIds).eq('is_visible', true);

  renderContactsList(locs || []);
  (locs || []).forEach(loc => {
    const contact = contacts.find(c => c.id === loc.user_id);
    if (contact) updateContactMarker(contact, loc.lat, loc.lng);
  });
}

function contactStatusText(c, loc, isOnline, isHidden) {
  if (isHidden) return '🚫 Nascosto da te';
  if (isOnline) {
    if (loc && myMarker) return calcDist(myMarker.getLatLng(), { lat: loc.lat, lng: loc.lng }) + ' km';
    return 'Visibile';
  }
  const lastSeen = loc ? timeSince(new Date(loc.last_seen)) : 'Mai';
  return 'Visto ' + lastSeen;
}

function contactBatteryHtml(loc) {
  if (!loc || loc.battery === undefined || loc.battery === null) return '';
  const lvl = Math.round(loc.battery);
  const cls = lvl <= 20 ? 'low' : '';
  return `<span class="contact-battery ${cls}"><svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></svg>${lvl}%</span>`;
}

function renderContactsList(locations) {
  const list = document.getElementById('contacts-list');
  if (contacts.length === 0) {
    list.innerHTML = `<div class="empty-contacts">Nessun contatto ancora.<br/>Premi + per aggiungere qualcuno<br/>alla tua cerchia.</div>`;
    return;
  }

  const SVG_EYE_ON = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
  const SVG_EYE_OFF = '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>';
  const SVG_NAV = '<path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>';

  list.innerHTML = contacts.map(c => {
    const loc = locations.find(l => l.user_id === c.id);
    const isOnline = !!(loc && loc.is_visible);
    const isHidden = hiddenUsers.includes(c.id);
    const initial = (c.display_name || '?')[0].toUpperCase();
    const colors = ['#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981'];
    const color = colors[(c.display_name || '').charCodeAt(0) % colors.length];
    const statusText = contactStatusText(c, loc, isOnline, isHidden);
    const eyeSvg = isHidden ? SVG_EYE_OFF : SVG_EYE_ON;
    const eyeTitle = isHidden ? 'Mostra sulla mappa' : 'Nascondi dalla mappa';
    const batteryHtml = contactBatteryHtml(loc);
    const lastSeenHtml = (!isOnline && loc && loc.last_seen)
      ? `<div class="contact-last-seen">Visto ${timeSince(new Date(loc.last_seen))}</div>`
      : '';
    const navBtn = isOnline && !isHidden
      ? `<div class="mini-btn" onclick="event.stopPropagation();openNavModal('${c.display_name || c.email}',${loc.lat},${loc.lng})"><svg viewBox="0 0 24 24">${SVG_NAV}</svg></div>`
      : '';

    return `
      <div class="contact-card" onclick="flyToContact('${c.id}', ${loc?.lat || 0}, ${loc?.lng || 0}, ${isOnline})">
        <div class="contact-avatar" style="background:${color}">
          ${initial}
          <div class="status-dot ${isOnline ? 'online' : 'offline'}"></div>
        </div>
        <div class="contact-info">
          <div class="contact-name">${c.display_name || c.email}</div>
          <div class="contact-card-meta">
            <span class="contact-dist">${statusText}</span>
            ${batteryHtml}
          </div>
          ${lastSeenHtml}
        </div>
        <div class="contact-actions">
          <div class="mini-btn hide-user-btn ${isHidden ? 'active' : ''}" onclick="event.stopPropagation();toggleHideUser('${c.id}')" title="${eyeTitle}">
            <svg viewBox="0 0 24 24">${eyeSvg}</svg>
          </div>
          ${navBtn}
        </div>
      </div>
    `;
  }).join('');
}

// ─── PRIVACY: HIDE/SHOW USER ──────────────────────────────
function toggleHideUser(userId) {
  if (hiddenUsers.includes(userId)) {
    hiddenUsers = hiddenUsers.filter(id => id !== userId);
    // Reload marker for now-visible user
    const contact = contacts.find(c => c.id === userId);
    if (contact) loadContactsLocations();
    showToast('Contatto visibile sulla mappa');
  } else {
    hiddenUsers.push(userId);
    removeContactMarker(userId);
    showToast('Contatto nascosto dalla mappa');
  }
  localStorage.setItem('orizon_hidden_users', JSON.stringify(hiddenUsers));
  loadContactsLocations();
}

function flyToContact(userId, lat, lng, isOnline) {
  if (!isOnline || !lat) { showToast('Posizione non disponibile'); return; }
  map.flyTo([lat, lng], 16, { duration: 1.2 });
  if (panelOpen) togglePanel();
}

function calcDist(a, b) {
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const x = Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return (R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x))).toFixed(1);
}

function timeSince(date) {
  const s = (Date.now() - date) / 1000;
  if (s < 60) return 'ora';
  if (s < 3600) return Math.floor(s/60) + 'm fa';
  if (s < 86400) return Math.floor(s/3600) + 'h fa';
  return Math.floor(s/86400) + 'g fa';
}

// ─── REALTIME ────────────────────────────────────────────
function subscribeRealtime() {
  realtimeChannel = db.channel('locations-channel')
    .on('postgres_changes', {
      event: '*', schema: 'public', table: 'locations'
    }, (payload) => {
      const loc = payload.new;
      if (!loc || loc.user_id === currentUser.id) return;
      const contact = contacts.find(c => c.id === loc.user_id);
      if (!contact) return;

      if (loc.is_visible) {
        updateContactMarker(contact, loc.lat, loc.lng);
      } else {
        removeContactMarker(loc.user_id);
      }

      // Refresh list
      loadContactsLocations();
    })
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'connections'
    }, (payload) => {
      const conn = payload.new;
      // Shower: receives pending request from scanner
      if (conn.user_b === currentUser.id && conn.status === 'pending') {
        handleIncomingConnectionRequest(conn);
      }
    })
    .on('postgres_changes', {
      event: 'UPDATE', schema: 'public', table: 'connections'
    }, (payload) => {
      const conn = payload.new;
      // Scanner: their pending request was accepted by the shower
      if (conn.user_a === currentUser.id && conn.status === 'accepted') {
        closeQRWaitModal();
        showToast('✓ Connessione accettata!');
        loadContacts();
      }
      // Scanner: their request was rejected
      if (conn.user_a === currentUser.id && conn.status === 'rejected') {
        closeQRWaitModal();
        showToast('Richiesta rifiutata');
      }
    })
    .subscribe();
}

async function loadContactsLocations() {
  const contactIds = contacts.map(c => c.id);
  if (!contactIds.length) return;
  const { data: locs } = await db.from('locations')
    .select('*').in('user_id', contactIds);
  renderContactsList(locs || []);
}

// ─── PANEL ───────────────────────────────────────────────
function togglePanel() {
  panelOpen = !panelOpen;
  document.getElementById('contacts-panel').classList.toggle('open', panelOpen);
  const arrow = document.getElementById('panel-arrow');
  arrow.style.transform = panelOpen ? 'rotate(180deg)' : '';
}

// ─── QR MODAL ────────────────────────────────────────────
function openQRModal() {
  generateQR();
  document.getElementById('qr-modal').classList.add('open');
}

function closeQRModal() {
  document.getElementById('qr-modal').classList.remove('open');
  stopScan();
  switchTab('show');
}

function generateQR() {
  const container = document.getElementById('qrcode-container');
  container.innerHTML = '';
  const token = btoa(JSON.stringify({
    uid: currentUser.id,
    name: userProfile?.display_name || currentUser.email,
    ts: Date.now()
  }));
  const url = `${window.location.origin}?connect=${token}`;
  new QRCode(container, {
    text: url, width: 200, height: 200,
    colorDark: '#040812', colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });
}

function switchTab(tab) {
  document.getElementById('tab-show').classList.toggle('active', tab === 'show');
  document.getElementById('tab-scan').classList.toggle('active', tab === 'scan');
  document.getElementById('qr-display').style.display = tab === 'show' ? 'flex' : 'none';
  document.getElementById('qr-scan').style.display = tab === 'scan' ? 'flex' : 'none';
  if (tab === 'scan') startScan();
  else stopScan();
}

async function startScan() {
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' }
    });
    const video = document.getElementById('scan-video');
    video.srcObject = videoStream;
    await video.play();
    scanFrame();
  } catch (e) {
    document.getElementById('scan-status').textContent = 'Fotocamera non disponibile';
  }
}

function stopScan() {
  if (scanAnimFrame) { cancelAnimationFrame(scanAnimFrame); scanAnimFrame = null; }
  if (videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
}

function scanFrame() {
  const video = document.getElementById('scan-video');
  if (!video.videoWidth) { scanAnimFrame = requestAnimationFrame(scanFrame); return; }

  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height);

  if (code && code.data.includes('connect=')) {
    const token = new URL(code.data).searchParams.get('connect');
    closeQRModal();
    handleIncomingQR(token);
    return;
  }

  scanAnimFrame = requestAnimationFrame(scanFrame);
}

// ─── QR CONNECT ──────────────────────────────────────────
async function handleIncomingQR(token) {
  try {
    const decoded = JSON.parse(atob(token));
    if (!decoded.uid || decoded.uid === currentUser.id) return;

    // Check if already connected or pending
    const { data: existing } = await db.from('connections')
      .select('*')
      .or(`and(user_a.eq.${currentUser.id},user_b.eq.${decoded.uid}),and(user_a.eq.${decoded.uid},user_b.eq.${currentUser.id})`)
      .maybeSingle();

    if (existing) {
      if (existing.status === 'accepted') { showToast('Già nella tua cerchia!'); return; }
      if (existing.status === 'pending') { showToast('Richiesta già inviata, attendi...'); return; }
    }

    // Scanner inserts pending request and shows wait modal
    const { data: conn, error } = await db.from('connections').insert({
      user_a: currentUser.id,
      user_b: decoded.uid,
      status: 'pending',
      created_at: new Date().toISOString()
    }).select().single();

    if (error) { showToast('Errore: ' + error.message); return; }

    pendingConnection = { ...decoded, connId: conn?.id };
    document.getElementById('qr-wait-name').textContent = decoded.name || 'Utente';
    document.getElementById('qr-wait-modal').classList.add('open');
  } catch (e) {
    showToast('QR non valido');
  }
}

function closeQRWaitModal() {
  document.getElementById('qr-wait-modal').classList.remove('open');
  pendingConnection = null;
}

// Shower: accept incoming pending request
async function acceptIncomingRequest() {
  if (!pendingConnection) return;
  document.getElementById('confirm-modal').classList.remove('open');

  await db.from('connections')
    .update({ status: 'accepted' })
    .eq('id', pendingConnection.connId);

  showToast('✓ ' + pendingConnection.name + ' aggiunto!');
  pendingConnection = null;
  await loadContacts();
}

// Shower: reject incoming pending request
async function rejectIncomingRequest() {
  document.getElementById('confirm-modal').classList.remove('open');
  if (pendingConnection?.connId) {
    await db.from('connections')
      .update({ status: 'rejected' })
      .eq('id', pendingConnection.connId);
  }
  pendingConnection = null;
}

async function handleIncomingConnectionRequest(conn) {
  const { data: profile } = await db.from('profiles').select('*').eq('id', conn.user_a).single();
  pendingConnection = { uid: conn.user_a, name: profile?.display_name || 'Utente', connId: conn.id };
  document.getElementById('confirm-avatar').textContent = (pendingConnection.name || '?')[0].toUpperCase();
  document.getElementById('confirm-name').textContent = pendingConnection.name;
  document.getElementById('confirm-modal').classList.add('open');
}

// ─── NAVIGATION MODAL ────────────────────────────────────
function openNavModal(name, lat, lng) {
  navTargetLat = lat;
  navTargetLng = lng;
  document.getElementById('nav-target-name').textContent = name;
  document.getElementById('nav-modal').classList.add('open');
}
function closeNavModal() {
  document.getElementById('nav-modal').classList.remove('open');
}
function openGoogleMaps(mode) {
  if (navTargetLat === null) return;
  const url = `https://maps.google.com/maps?daddr=${navTargetLat},${navTargetLng}&dirflg=${mode}`;
  window.open(url, '_blank');
  closeNavModal();
}

// ─── COMPASS MODE ─────────────────────────────────────────
function toggleCompass() {
  compassMode = !compassMode;
  const btn = document.getElementById('compass-btn');
  btn.classList.toggle('active-btn', compassMode);

  if (compassMode) {
    if (window.DeviceOrientationEvent) {
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(perm => { if (perm === 'granted') window.addEventListener('deviceorientation', handleOrientation, true); })
          .catch(() => showToast('Accesso bussola negato'));
      } else {
        window.addEventListener('deviceorientation', handleOrientation, true);
      }
    } else {
      showToast('Bussola non supportata');
      compassMode = false;
      btn.classList.remove('active-btn');
      return;
    }
    updateMyMarkerAppearance();
    showToast('Modalità freccia attiva 🧭');
  } else {
    window.removeEventListener('deviceorientation', handleOrientation, true);
    updateMyMarkerAppearance();
    showToast('Modalità freccia disattivata');
  }
}

function handleOrientation(e) {
  if (!compassMode) return;
  const heading = e.webkitCompassHeading !== null && e.webkitCompassHeading !== undefined
    ? e.webkitCompassHeading
    : (e.alpha !== null && e.alpha !== undefined ? (360 - e.alpha) % 360 : 0);
  compassHeading = heading;

  // Rotate the arrow marker
  if (myMarker) {
    const container = document.getElementById('my-marker-container');
    if (container) {
      const arrow = container.querySelector('.my-marker-arrow svg');
      if (arrow) {
        arrow.style.transform = `rotate(${heading}deg)`;
      }
    }
  }
}

function stopCompass() {
  compassMode = false;
  window.removeEventListener('deviceorientation', handleOrientation, true);
}

// ─── TOAST ───────────────────────────────────────────────
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// ─── SIDEBAR ─────────────────────────────────────────────
function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebar-overlay').classList.add('open');
  document.querySelector('.fab-container').classList.add('sidebar-hidden');
  document.querySelector('.locate-me-btn').classList.add('sidebar-hidden');
  document.querySelector('.side-btns').classList.add('sidebar-hidden');
  renderSidebarContacts();
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
  document.querySelector('.fab-container').classList.remove('sidebar-hidden');
  document.querySelector('.locate-me-btn').classList.remove('sidebar-hidden');
  document.querySelector('.side-btns').classList.remove('sidebar-hidden');
}

function renderSidebarContacts() {
  const list = document.getElementById('sidebar-contacts-list');
  if (!contacts.length) {
    list.innerHTML = '<div style="font-family:var(--mono);font-size:0.7rem;color:var(--text-muted);padding:16px 0;text-align:center">Nessun contatto</div>';
    return;
  }
  const colors = ['#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981'];
  list.innerHTML = contacts.map(c => {
    const initial = (c.display_name || '?')[0].toUpperCase();
    const color = colors[(c.display_name || '').charCodeAt(0) % colors.length];
    return `
      <div class="sidebar-contact" onclick="closeSidebar();flyToContact('${c.id}',0,0,true)">
        <div class="sidebar-contact-avatar" style="background:${color}">${initial}</div>
        <div>
          <div class="sidebar-contact-name">${c.display_name || c.email}</div>
        </div>
      </div>`;
  }).join('');
}

// ─── DARK / LIGHT MODE ───────────────────────────────────
function toggleTheme() {
  const isLight = document.getElementById('theme-toggle').checked;
  document.body.classList.toggle('light-mode', isLight);
  localStorage.setItem('orizon_theme', isLight ? 'light' : 'dark');

  if (map) {
    if (isLight) {
      if (darkTileLayer && map.hasLayer(darkTileLayer)) map.removeLayer(darkTileLayer);
      if (lightTileLayer && !map.hasLayer(lightTileLayer)) lightTileLayer.addTo(map);
    } else {
      if (lightTileLayer && map.hasLayer(lightTileLayer)) map.removeLayer(lightTileLayer);
      if (darkTileLayer && !map.hasLayer(darkTileLayer)) darkTileLayer.addTo(map);
    }
  }
}

// ─── GHOST MODE ──────────────────────────────────────────
function toggleGhostMode() {
  ghostMode = !ghostMode;
  const indicator = document.getElementById('ghost-indicator');
  const statusEl = document.getElementById('ghost-mode-status');

  if (ghostMode) {
    if (myMarker) {
      const ll = myMarker.getLatLng();
      frozenLat = ll.lat;
      frozenLng = ll.lng;
    }
    indicator.classList.add('visible');
    statusEl.textContent = 'Attivo · Posizione congelata';
    document.getElementById('ghost-mode-item').style.borderColor = 'rgba(239,68,68,0.3)';
    document.getElementById('ghost-mode-item').style.background = 'rgba(239,68,68,0.05)';
    showToast('Ghost Mode attivato 👻');
  } else {
    frozenLat = null;
    frozenLng = null;
    indicator.classList.remove('visible');
    statusEl.textContent = 'Disattivato · La posizione si aggiorna';
    document.getElementById('ghost-mode-item').style.borderColor = '';
    document.getElementById('ghost-mode-item').style.background = '';
    showToast('Ghost Mode disattivato');
  }

  updateMyMarkerAppearance();
}

// ─── BATTERY API ─────────────────────────────────────────
async function initBattery() {
  if (!navigator.getBattery) return;
  try {
    const battery = await navigator.getBattery();
    const update = () => {
      batteryLevel = Math.round(battery.level * 100);
      const chip = document.getElementById('battery-chip');
      const lvlEl = document.getElementById('battery-level');
      if (chip && lvlEl) {
        chip.style.display = 'flex';
        lvlEl.textContent = batteryLevel + '%';
        chip.classList.toggle('low', batteryLevel <= 20);
      }
    };
    update();
    battery.addEventListener('levelchange', update);
  } catch (e) { /* Battery API not available */ }
}

// ─── GEOFENCE ────────────────────────────────────────────
function openGeofenceModal() {
  closeSettings();
  renderGeofenceList();
  document.getElementById('geofence-modal').classList.add('open');
}

function closeGeofenceModal() {
  document.getElementById('geofence-modal').classList.remove('open');
}

function renderGeofenceList() {
  const list = document.getElementById('geofence-list');
  if (!geofences.length) {
    list.innerHTML = '<div style="font-family:var(--mono);font-size:0.7rem;color:var(--text-muted);text-align:center;padding:12px">Nessun geofence impostato</div>';
    return;
  }
  list.innerHTML = geofences.map((g, i) => `
    <div class="geofence-item">
      <div class="geofence-item-info">
        <div class="geofence-item-name">${g.name}</div>
        <div class="geofence-item-radius">${g.radius}m · ${Number(g.lat).toFixed(4)}, ${Number(g.lng).toFixed(4)}</div>
      </div>
      <button class="geofence-item-remove" onclick="removeGeofence(${i})">✕</button>
    </div>
  `).join('');
}

function addGeofence() {
  const name = document.getElementById('geofence-name').value.trim();
  const lat = parseFloat(document.getElementById('geofence-lat').value);
  const lng = parseFloat(document.getElementById('geofence-lng').value);
  const radius = parseInt(document.getElementById('geofence-radius').value);

  if (!name) { showToast('Inserisci un nome'); return; }
  if (isNaN(lat) || isNaN(lng)) { showToast('Coordinate non valide'); return; }
  if (isNaN(radius) || radius < 50) { showToast('Raggio minimo 50m'); return; }

  geofences.push({ name, lat, lng, radius });
  localStorage.setItem('orizon_geofences', JSON.stringify(geofences));

  document.getElementById('geofence-name').value = '';
  document.getElementById('geofence-lat').value = '';
  document.getElementById('geofence-lng').value = '';
  document.getElementById('geofence-radius').value = '';

  renderGeofenceList();
  showToast('Geofence aggiunto ✓');
}

function removeGeofence(idx) {
  geofences.splice(idx, 1);
  localStorage.setItem('orizon_geofences', JSON.stringify(geofences));
  renderGeofenceList();
  showToast('Geofence rimosso');
}

function useCurrentPositionForGeofence() {
  if (myMarker) {
    const ll = myMarker.getLatLng();
    document.getElementById('geofence-lat').value = ll.lat.toFixed(6);
    document.getElementById('geofence-lng').value = ll.lng.toFixed(6);
    showToast('Coordinate impostate');
  } else {
    showToast('Posizione non disponibile');
  }
}

function checkGeofences() {
  if (!geofences.length || !contacts.length) return;

  contacts.forEach(contact => {
    const marker = contactMarkers[contact.id];
    if (!marker) return;
    const contactPos = marker.getLatLng();

    geofences.forEach(fence => {
      const dist = calcDistMeters(contactPos, { lat: fence.lat, lng: fence.lng });
      const key = `${contact.id}_${fence.name}`;
      const wasInside = geofenceStates[key] || false;
      const isInside = dist <= fence.radius;

      if (isInside && !wasInside) {
        showToast(`📍 ${contact.display_name} è entrato in "${fence.name}"`);
      } else if (!isInside && wasInside) {
        showToast(`📍 ${contact.display_name} è uscito da "${fence.name}"`);
      }
      geofenceStates[key] = isInside;
    });
  });
}

function calcDistMeters(a, b) {
  const R = 6371000;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const x = Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
}

// ─── IL MONDO ORIZON ─────────────────────────────────────
function openOrizonWorld() {
  closeSettings();
  document.getElementById('orizon-world-modal').classList.add('open');
}

function closeOrizonWorld() {
  document.getElementById('orizon-world-modal').classList.remove('open');
}

// ─── SERVICE WORKER ──────────────────────────────────────
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body>
</html>
