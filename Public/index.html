<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#040812" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Orizon" />
  <title>Orizon — Find Your Circle</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap');

    :root {
      --bg: #040812;
      --surface: rgba(12,20,40,0.97);
      --surface2: rgba(18,30,56,0.95);
      --border: rgba(99,179,255,0.13);
      --accent: #3b82f6;
      --accent-glow: rgba(59,130,246,0.35);
      --green: #22c55e;
      --green-glow: rgba(34,197,94,0.4);
      --orange: #f97316;
      --orange-glow: rgba(249,115,22,0.4);
      --red: #ef4444;
      --text: #e2eeff;
      --text-muted: #5a7aaa;
      --mono: 'Space Mono', monospace;
      --sans: 'Syne', sans-serif;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; height: -webkit-fill-available; }
    body {
      width: 100%; height: 100%; min-height: -webkit-fill-available;
      background: var(--bg); color: var(--text);
      font-family: var(--sans); overflow: hidden;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }

    /* ── LOADING ─────────────────────────────────────────── */
    #loading-screen {
      position: fixed; inset: 0; background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      z-index: 500; transition: opacity 0.4s;
    }
    #loading-screen.fade { opacity: 0; pointer-events: none; }
    .loader {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── SCREENS ─────────────────────────────────────────── */
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 0.4s, transform 0.4s;
      z-index: 10;
    }
    .screen.hidden { opacity: 0; pointer-events: none; transform: translateY(16px); }

    /* ── VERIFIED SCREEN ─────────────────────────────────── */
    #verified-screen { background: var(--bg); gap: 20px; padding: 32px; text-align: center; }
    .verified-icon {
      width: 80px; height: 80px;
      background: rgba(34,197,94,0.1); border: 2px solid var(--green);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      margin: 0 auto; box-shadow: 0 0 40px var(--green-glow);
      animation: pop-in 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes pop-in { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .verified-icon svg { width: 36px; height: 36px; fill: var(--green); }
    .verified-title { font-size: 1.6rem; font-weight: 800; }
    .verified-sub { font-family: var(--mono); font-size: 0.72rem; color: var(--text-muted); line-height: 1.9; max-width: 280px; }

    /* ── AUTH SCREEN ─────────────────────────────────────── */
    #auth-screen { background: var(--bg); gap: 28px; padding: 28px; overflow-y: auto; }
    #auth-screen::before {
      content: ''; position: fixed; inset: 0;
      background: radial-gradient(ellipse at 50% 0%, rgba(59,130,246,0.07) 0%, transparent 60%);
      pointer-events: none;
    }

    .logo { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .logo-mark {
      width: 68px; height: 68px; border: 2px solid var(--accent); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; position: relative;
      box-shadow: 0 0 40px var(--accent-glow); animation: pulse-glow 3s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%,100% { box-shadow: 0 0 30px var(--accent-glow); }
      50% { box-shadow: 0 0 70px var(--accent-glow); }
    }
    .logo-mark::before {
      content: ''; position: absolute; width: 38px; height: 38px;
      border-radius: 50%; border: 1px solid rgba(99,179,255,0.2);
      animation: spin 10s linear infinite;
    }
    .logo-mark svg { width: 26px; height: 26px; fill: var(--accent); }
    .logo h1 { font-size: clamp(1.8rem,5vw,2.2rem); font-weight: 800; letter-spacing: -0.02em; }
    .logo p { font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); letter-spacing: 0.2em; text-transform: uppercase; }

    .auth-form { width: 100%; max-width: 380px; display: flex; flex-direction: column; gap: 10px; }
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); letter-spacing: 0.1em; text-transform: uppercase; }
    .input-group input {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 13px 15px;
      color: var(--text); font-family: var(--mono); font-size: 0.88rem;
      outline: none; width: 100%; appearance: none; -webkit-appearance: none;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .input-group input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

    .btn {
      padding: 13px 20px; border-radius: 12px; border: none;
      font-family: var(--sans); font-size: 0.9rem; font-weight: 700;
      cursor: pointer; transition: all var(--transition); letter-spacing: 0.01em;
    }
    .btn-primary { background: var(--accent); color: #fff; box-shadow: 0 4px 20px var(--accent-glow); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 28px var(--accent-glow); }
    .btn-primary:active { transform: scale(0.97); }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--surface); color: var(--text); }
    .btn-danger { background: rgba(239,68,68,0.12); color: var(--red); border: 1px solid rgba(239,68,68,0.25); }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }

    .divider { text-align: center; font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); }
    .error-msg { font-family: var(--mono); font-size: 0.68rem; color: var(--red); text-align: center; min-height: 16px; }
    .success-msg { font-family: var(--mono); font-size: 0.68rem; color: var(--green); text-align: center; }

    /* ── MAP ─────────────────────────────────────────────── */
    #map-screen { padding: 0; }
    #map { position: fixed; inset: 0; z-index: 1; }
    .leaflet-tile { filter: brightness(0.35) saturate(0.5) invert(1) hue-rotate(200deg); }
    .leaflet-control-zoom, .leaflet-control-attribution { display: none !important; }

    /* ── TOP BAR ─────────────────────────────────────────── */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      padding: calc(var(--safe-top) + 10px) calc(16px + var(--safe-right)) 10px calc(16px + var(--safe-left));
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      background: linear-gradient(180deg, rgba(4,8,18,0.97) 0%, rgba(4,8,18,0.6) 85%, transparent 100%);
    }
    .app-name {
      font-size: clamp(1.1rem,4vw,1.3rem); font-weight: 800; letter-spacing: -0.02em;
      display: flex; align-items: center; gap: 8px; flex-shrink: 0;
    }
    .tracking-dot {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
      background: var(--green); box-shadow: 0 0 10px var(--green);
      animation: blink 2s ease-in-out infinite;
      transition: background 0.4s, box-shadow 0.4s;
    }
    .tracking-dot.vis-off { background: var(--orange); box-shadow: 0 0 10px var(--orange); animation: none; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

    .profile-chip {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 5px 12px 5px 5px;
      cursor: pointer; transition: all var(--transition); backdrop-filter: blur(12px);
    }
    .profile-chip:hover { border-color: rgba(99,179,255,0.3); }
    .profile-chip:active { transform: scale(0.96); }
    .profile-chip-avatar {
      width: 26px; height: 26px; border-radius: 50%; background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700;
    }
    .profile-chip-name { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ── COMPASS ─────────────────────────────────────────── */
    .compass-bar {
      position: fixed; top: calc(var(--safe-top) + 62px); left: 50%; transform: translateX(-50%);
      z-index: 100; background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 5px 14px;
      font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted);
      display: none; align-items: center; gap: 8px; backdrop-filter: blur(12px);
      white-space: nowrap;
    }
    .compass-bar.visible { display: flex; }
    .compass-needle { font-size: 1rem; display: inline-block; transition: transform 0.1s linear; }

    /* ── SIDE BUTTONS ────────────────────────────────────── */
    .side-btns {
      position: fixed; right: calc(16px + var(--safe-right));
      bottom: calc(var(--safe-bottom) + 250px);
      z-index: 100; display: flex; flex-direction: column; gap: 10px; align-items: center;
    }
    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--transition); backdrop-filter: blur(12px);
    }
    .icon-btn:hover { border-color: rgba(99,179,255,0.3); transform: scale(1.06); }
    .icon-btn:active { transform: scale(0.92); }
    .icon-btn svg { width: 18px; height: 18px; fill: var(--text); transition: fill 0.2s; }
    .icon-btn.active-btn { background: rgba(59,130,246,0.15); border-color: var(--accent); }
    .icon-btn.active-btn svg { fill: var(--accent); }

    /* ── LOCATE ME ───────────────────────────────────────── */
    .locate-me-btn {
      position: fixed; left: calc(16px + var(--safe-left));
      bottom: calc(var(--safe-bottom) + 100px); z-index: 100;
    }

    /* ── FABs ────────────────────────────────────────────── */
    .fab-container {
      position: fixed; right: calc(16px + var(--safe-right));
      bottom: calc(var(--safe-bottom) + 100px);
      z-index: 100; display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
    }
    .fab {
      border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .fab:hover { transform: scale(1.08); }
    .fab:active { transform: scale(0.9) !important; }
    .fab svg { fill: #fff; }

    .fab-add {
      width: 50px; height: 50px;
      background: var(--accent); box-shadow: 0 4px 24px var(--accent-glow);
    }
    .fab-add svg { width: 22px; height: 22px; }

    .fab-vis {
      width: 58px; height: 58px;
      background: var(--green); box-shadow: 0 4px 30px var(--green-glow);
      transition: background 0.4s, box-shadow 0.4s, transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .fab-vis.vis-off { background: var(--orange); box-shadow: 0 4px 30px var(--orange-glow); }
    .fab-vis svg { width: 26px; height: 26px; }

    /* ── CONTACTS PANEL ──────────────────────────────────── */
    .contacts-panel {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 89;
      background: var(--surface); border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      transform: translateY(calc(100% - 64px));
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      max-height: 65vh; display: flex; flex-direction: column;
      padding-bottom: var(--safe-bottom); backdrop-filter: blur(20px);
    }
    .contacts-panel.open { transform: translateY(0); }

    .panel-drag { padding: 10px 20px 6px; cursor: pointer; }
    .panel-handle {
      width: 36px; height: 4px; background: var(--border);
      border-radius: 2px; margin: 0 auto 8px; transition: background 0.2s;
    }
    .contacts-panel:hover .panel-handle { background: rgba(99,179,255,0.3); }
    .panel-header { display: flex; align-items: center; justify-content: space-between; }
    .panel-title { font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .contact-count {
      font-family: var(--mono); font-size: 0.6rem;
      background: var(--surface2); border: 1px solid var(--border);
      padding: 2px 8px; border-radius: 20px; color: var(--text-muted);
    }
    .panel-arrow { width: 18px; height: 18px; fill: var(--text-muted); transition: transform 0.3s; }
    .contacts-panel.open .panel-arrow { transform: rotate(180deg); }

    .contacts-list {
      overflow-y: auto; padding: 4px 12px 12px;
      display: flex; flex-direction: column; gap: 6px; flex: 1;
      overscroll-behavior: contain;
    }
    .contacts-list::-webkit-scrollbar { display: none; }

    .contact-card {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 14px; padding: 12px 14px;
      display: flex; align-items: center; gap: 12px;
      cursor: pointer; transition: all var(--transition);
    }
    .contact-card:hover { border-color: rgba(99,179,255,0.25); transform: translateX(2px); }
    .contact-card:active { opacity: 0.7; transform: scale(0.98); }

    .contact-avatar {
      width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 0.95rem; color: #fff !important;
      position: relative;
    }
    .status-dot {
      position: absolute; bottom: -1px; right: -1px;
      width: 11px; height: 11px; border-radius: 50%;
      border: 2px solid var(--surface2); transition: all 0.3s;
    }
    .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.offline { background: var(--orange); }
    .status-dot.unknown { background: var(--text-muted); }

    .contact-info { flex: 1; overflow: hidden; }
    .contact-name { font-weight: 700; font-size: 0.88rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .contact-dist { font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); }

    .contact-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .mini-btn {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--transition);
    }
    .mini-btn:hover { background: var(--accent); border-color: var(--accent); }
    .mini-btn:hover svg { fill: #fff; }
    .mini-btn:active { transform: scale(0.88); }
    .mini-btn svg { width: 13px; height: 13px; fill: var(--text-muted); transition: fill 0.2s; }
    .mini-btn.vis-hidden { background: rgba(249,115,22,0.12); border-color: var(--orange); }
    .mini-btn.vis-hidden svg { fill: var(--orange); }

    .empty-contacts {
      text-align: center; padding: 28px 16px;
      font-family: var(--mono); font-size: 0.72rem;
      color: var(--text-muted); line-height: 2;
    }

    /* ── MODALS ──────────────────────────────────────────── */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(4,8,18,0.88); backdrop-filter: blur(16px);
      display: flex; align-items: flex-end; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }

    .modal {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 28px 28px 0 0;
      padding: 16px 20px calc(20px + var(--safe-bottom));
      width: 100%; max-width: 480px;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      display: flex; flex-direction: column; gap: 14px;
      max-height: 90vh; overflow-y: auto;
    }
    .modal-overlay.open .modal { transform: translateY(0); }

    .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 2px; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.1rem; font-weight: 800; }
    .close-btn {
      width: 30px; height: 30px; background: var(--surface2); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1rem; color: var(--text-muted); transition: all 0.2s;
    }
    .close-btn:hover { background: rgba(239,68,68,0.15); color: var(--red); }

    /* QR */
    .qr-tabs { display: flex; gap: 6px; }
    .qr-tab {
      flex: 1; padding: 10px; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; text-align: center;
      font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted);
      cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; transition: all var(--transition);
    }
    .qr-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    #qr-display { display: flex; flex-direction: column; gap: 14px; align-items: center; }
    #qr-scan { display: none; flex-direction: column; gap: 10px; }
    #qrcode-container { background: #fff; padding: 14px; border-radius: 18px; display: inline-block; }
    #qrcode-container canvas, #qrcode-container img { display: block; }
    .qr-hint { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); text-align: center; line-height: 1.7; }

    #scan-video-container {
      position: relative; width: 100%; border-radius: 18px;
      overflow: hidden; background: #000; aspect-ratio: 1;
    }
    #scan-video { width: 100%; height: 100%; object-fit: cover; display: block; }
    .scan-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
    .scan-frame {
      width: 200px; height: 200px; border: 2px solid var(--accent);
      border-radius: 18px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.45); position: relative;
    }
    .scan-line {
      position: absolute; left: 10px; right: 10px; height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      top: 10px; animation: scan-move 2s ease-in-out infinite;
    }
    @keyframes scan-move { 0%{top:10px} 100%{top:calc(100% - 12px)} }
    #scan-status { font-family: var(--mono); font-size: 0.68rem; color: var(--text-muted); text-align: center; }

    /* Confirm */
    .confi  {
      --sans: 'Syne', sans-serif;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --radius: 16px;
      --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { height: 100%; height: -webkit-fill-available; }
    body {
      width: 100%; height: 100%; min-height: -webkit-fill-available;
      background: var(--bg); color: var(--text);
      font-family: var(--sans); overflow: hidden;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }

    /* ─── SCREENS ──────────────────────────────────────── */
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 0.4s ease, transform 0.4s ease;
      z-index: 10;
    }
    .screen.hidden { opacity: 0; pointer-events: none; transform: translateY(16px); }

    /* ─── EMAIL VERIFIED SCREEN ───────────────────────── */
    #verified-screen {
      background: var(--bg); gap: 24px; padding: 32px;
      text-align: center;
    }
    .verified-icon {
      width: 80px; height: 80px;
      background: rgba(34,197,94,0.12);
      border: 2px solid var(--green);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto;
      box-shadow: 0 0 40px var(--green-glow);
      animation: pop-in 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes pop-in { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .verified-icon svg { width: 36px; height: 36px; fill: var(--green); }
    .verified-title { font-size: 1.6rem; font-weight: 800; }
    .verified-sub { font-family: var(--mono); font-size: 0.75rem; color: var(--text-muted); line-height: 1.8; max-width: 280px; }

    /* ─── AUTH SCREEN ──────────────────────────────────── */
    #auth-screen { background: var(--bg); gap: 28px; padding: 32px; overflow-y: auto; }
    #auth-screen::before {
      content: '';
      position: fixed; inset: 0;
      background: radial-gradient(ellipse at 50% 0%, rgba(59,130,246,0.08) 0%, transparent 60%);
      pointer-events: none;
    }

    .logo { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .logo-mark {
      width: 68px; height: 68px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      position: relative;
      box-shadow: 0 0 40px var(--accent-glow), inset 0 0 30px rgba(59,130,246,0.06);
      animation: pulse-ring 3s ease-in-out infinite;
    }
    @keyframes pulse-ring {
      0%,100% { box-shadow: 0 0 40px var(--accent-glow), inset 0 0 30px rgba(59,130,246,0.06); }
      50% { box-shadow: 0 0 70px var(--accent-glow), inset 0 0 50px rgba(59,130,246,0.12); }
    }
    .logo-mark::before {
      content: ''; position: absolute;
      width: 38px; height: 38px; border-radius: 50%;
      border: 1px solid rgba(99,179,255,0.25);
      animation: spin 10s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .logo-mark svg { width: 26px; height: 26px; fill: var(--accent); }
    .logo h1 { font-size: clamp(1.8rem, 5vw, 2.2rem); font-weight: 800; letter-spacing: -0.02em; }
    .logo p { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.2em; text-transform: uppercase; }

    .auth-form { width: 100%; max-width: 380px; display: flex; flex-direction: column; gap: 10px; }
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); letter-spacing: 0.12em; text-transform: uppercase; }
    .input-group input {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 13px 15px;
      color: var(--text); font-family: var(--mono); font-size: 0.9rem;
      outline: none; width: 100%;
      transition: border-color var(--transition), box-shadow var(--transition);
      -webkit-appearance: none;
      appearance: none;
    }
    .input-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .btn {
      padding: 13px 20px; border-radius: 12px; border: none;
      font-family: var(--sans); font-size: 0.9rem; font-weight: 700;
      cursor: pointer; transition: all var(--transition); letter-spacing: 0.01em;
      position: relative; overflow: hidden;
    }
    .btn::after {
      content: ''; position: absolute; inset: 0;
      background: rgba(255,255,255,0); transition: background 0.15s;
    }
    .btn:active::after { background: rgba(255,255,255,0.08); }
    .btn-primary { background: var(--accent); color: #fff; box-shadow: 0 4px 24px var(--accent-glow); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 32px var(--accent-glow); }
    .btn-primary:active { transform: translateY(0) scale(0.98); }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--surface); border-color: rgba(99,179,255,0.25); color: var(--text); }
    .btn-danger { background: rgba(239,68,68,0.12); color: var(--red); border: 1px solid rgba(239,68,68,0.25); }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }

    .divider { text-align: center; font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); }
    .error-msg { font-family: var(--mono); font-size: 0.68rem; color: var(--red); text-align: center; min-height: 16px; transition: all 0.2s; }
    .success-msg { font-family: var(--mono); font-size: 0.68rem; color: var(--green); text-align: center; min-height: 16px; }

    /* ─── MAP ──────────────────────────────────────────── */
    #map-screen { padding: 0; }
    #map { position: fixed; inset: 0; z-index: 1; }
    .leaflet-tile { filter: brightness(0.82) saturate(0.65) hue-rotate(195deg); }
    .leaflet-control-zoom { display: none; }
    .leaflet-attribution-flag { display: none !important; }
    .leaflet-control-attribution { display: none; }

    /* ─── TOP BAR ──────────────────────────────────────── */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0;
      padding: calc(var(--safe-top) + 10px) calc(16px + var(--safe-right)) 10px calc(16px + var(--safe-left));
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(180deg, rgba(4,8,18,0.96) 0%, rgba(4,8,18,0.7) 80%, transparent 100%);
      z-index: 100; gap: 10px;
    }
    .app-name {
      font-size: clamp(1.1rem, 4vw, 1.3rem); font-weight: 800; letter-spacing: -0.02em;
      display: flex; align-items: center; gap: 8px; flex-shrink: 0;
    }
    .tracking-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--green); box-shadow: 0 0 10px var(--green);
      animation: blink 2s ease-in-out infinite; flex-shrink: 0;
    }
    .tracking-dot.hidden-dot { background: var(--orange); box-shadow: 0 0 10px var(--orange); animation: none; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.35} }

    .profile-chip {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 5px 12px 5px 5px;
      cursor: pointer; transition: all var(--transition);
      backdrop-filter: blur(12px);
    }
    .profile-chip:hover { border-color: rgba(99,179,255,0.3); background: var(--surface2); }
    .profile-chip:active { transform: scale(0.96); }
    .profile-chip-avatar {
      width: 26px; height: 26px; border-radius: 50%;
      background: var(--accent); display: flex; align-items: center;
      justify-content: center; font-size: 0.7rem; font-weight: 700;
    }
    .profile-chip-name { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ─── RIGHT SIDE BUTTONS ───────────────────────────── */
    .side-btns {
      position: fixed;
      right: calc(16px + var(--safe-right));
      bottom: calc(var(--safe-bottom) + 110px);
      z-index: 100;
      display: flex; flex-direction: column; gap: 10px; align-items: center;
    }
    .icon-btn {
      width: 44px; height: 44px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--transition);
      backdrop-filter: blur(12px);
    }
    .icon-btn:hover { border-color: rgba(99,179,255,0.3); background: var(--surface2); transform: scale(1.05); }
    .icon-btn:active { transform: scale(0.92); }
    .icon-btn svg { width: 18px; height: 18px; fill: var(--text); transition: fill 0.2s; }
    .icon-btn.active-btn { background: rgba(59,130,246,0.15); border-color: var(--accent); }
    .icon-btn.active-btn svg { fill: var(--accent); }

    /* ─── FAB ──────────────────────────────────────────── */
    .fab-container {
      position: fixed;
      right: calc(16px + var(--safe-right));
      bottom: calc(var(--safe-bottom) + 90px);
      z-index: 100;
      display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
    }
    .fab {
      border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .fab:hover { transform: scale(1.08); }
    .fab:active { transform: scale(0.9) !important; }
    .fab svg { fill: #fff; transition: transform 0.3s; }

    .fab-add {
      width: 50px; height: 50px;
      background: var(--accent); box-shadow: 0 4px 24px var(--accent-glow);
    }
    .fab-add svg { width: 22px; height: 22px; }

    .fab-visibility {
      width: 58px; height: 58px;
      background: var(--green); box-shadow: 0 4px 30px var(--green-glow);
    }
    .fab-visibility.vis-off {
      background: var(--orange); box-shadow: 0 4px 30px var(--orange-glow);
    }
    .fab-visibility svg { width: 26px; height: 26px; }

    /* ─── LOCATE ME ────────────────────────────────────── */
    .locate-me-btn {
      position: fixed;
      left: calc(16px + var(--safe-left));
      bottom: calc(var(--safe-bottom) + 110px);
      z-index: 100;
    }

    /* ─── CONTACTS PANEL ───────────────────────────────── */
    .contacts-panel {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      z-index: 90;
      transform: translateY(calc(100% - 72px));
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      max-height: 72vh;
      display: flex; flex-direction: column;
      padding-bottom: var(--safe-bottom);
      backdrop-filter: blur(20px);
      will-change: transform;
    }
    .contacts-panel.open { transform: translateY(0); }

    .panel-drag {
      padding: 10px 20px 6px;
      cursor: pointer; display: flex; flex-direction: column; gap: 8px;
    }
    .panel-handle {
      width: 36px; height: 4px; background: var(--border);
      border-radius: 2px; margin: 0 auto;
      transition: background 0.2s;
    }
    .contacts-panel:hover .panel-handle { background: rgba(99,179,255,0.25); }
    .panel-header { display: flex; align-items: center; justify-content: space-between; }
    .panel-title { font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .contact-count {
      font-family: var(--mono); font-size: 0.6rem;
      background: var(--surface2); border: 1px solid var(--border);
      padding: 2px 8px; border-radius: 20px; color: var(--text-muted);
    }
    .panel-arrow { width: 18px; height: 18px; fill: var(--text-muted); transition: transform 0.3s; }
    .contacts-panel.open .panel-arrow { transform: rotate(180deg); }

    .contacts-list {
      overflow-y: auto; padding: 4px 12px 12px;
      display: flex; flex-direction: column; gap: 6px; flex: 1;
      overscroll-behavior: contain;
    }
    .contacts-list::-webkit-scrollbar { display: none; }

    .contact-card {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 14px; padding: 12px 14px;
      display: flex; align-items: center; gap: 12px;
      transition: all var(--transition); cursor: pointer;
    }
    .contact-card:hover { border-color: rgba(99,179,255,0.25); transform: translateX(2px); }
    .contact-card:active { opacity: 0.7; transform: scale(0.98); }

    .contact-avatar {
      width: 38px; height: 38px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.95rem; flex-shrink: 0; position: relative;
    }
    .status-dot {
      position: absolute; bottom: -1px; right: -1px;
      width: 11px; height: 11px; border-radius: 50%;
      border: 2px solid var(--surface2);
      transition: background 0.3s, box-shadow 0.3s;
    }
    .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.offline { background: var(--orange); box-shadow: 0 0 4px var(--orange); }
    .status-dot.hidden-status { background: var(--text-muted); }

    .contact-info { flex: 1; overflow: hidden; }
    .contact-name { font-weight: 700; font-size: 0.88rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .contact-dist { font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); }

    .contact-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .mini-btn {
      width: 32px; height: 32px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--transition);
    }
    .mini-btn:hover { background: var(--accent); border-color: var(--accent); }
    .mini-btn:hover svg { fill: #fff; }
    .mini-btn:active { transform: scale(0.88); }
    .mini-btn svg { width: 13px; height: 13px; fill: var(--text-muted); transition: fill 0.2s; }
    .mini-btn.hide-user-btn.active { background: rgba(249,115,22,0.15); border-color: var(--orange); }
    .mini-btn.hide-user-btn.active svg { fill: var(--orange); }

    .empty-contacts {
      text-align: center; padding: 28px 16px;
      font-family: var(--mono); font-size: 0.72rem;
      color: var(--text-muted); line-height: 2;
    }

    /* ─── MODALS ───────────────────────────────────────── */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(4,8,18,0.88);
      backdrop-filter: blur(16px);
      z-index: 200;
      display: flex; align-items: flex-end; justify-content: center;
      padding: 0;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 28px 28px 0 0;
      padding: 20px 20px calc(20px + var(--safe-bottom));
      width: 100%; max-width: 480px;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      display: flex; flex-direction: column; gap: 16px;
      max-height: 92vh; overflow-y: auto;
    }
    .modal-overlay.open .modal { transform: translateY(0); }

    .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 4px; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.15rem; font-weight: 800; }
    .close-btn {
      width: 30px; height: 30px; background: var(--surface2);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1rem; color: var(--text-muted);
      transition: all 0.2s;
    }
    .close-btn:hover { background: rgba(239,68,68,0.15); color: var(--red); }

    /* QR */
    .qr-tabs { display: flex; gap: 6px; }
    .qr-tab {
      flex: 1; padding: 10px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; text-align: center;
      font-family: var(--mono); font-size: 0.62rem;
      color: var(--text-muted); cursor: pointer;
      text-transform: uppercase; letter-spacing: 0.05em;
      transition: all var(--transition);
    }
    .qr-tab:hover { border-color: rgba(99,179,255,0.25); color: var(--text); }
    .qr-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    #qr-display { display: flex; flex-direction: column; gap: 14px; align-items: center; }
    #qr-scan { display: none; flex-direction: column; gap: 10px; }
    #qrcode-container { background: #fff; padding: 14px; border-radius: 18px; display: inline-block; }
    #qrcode-container canvas, #qrcode-container img { display: block; }
    .qr-hint { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); text-align: center; line-height: 1.7; }

    #scan-video-container {
      position: relative; width: 100%; border-radius: 18px;
      overflow: hidden; background: #000; aspect-ratio: 1;
    }
    #scan-video { width: 100%; height: 100%; object-fit: cover; display: block; }
    .scan-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
    .scan-frame {
      width: 200px; height: 200px;
      border: 2px solid var(--accent); border-radius: 18px;
      box-shadow: 0 0 0 2000px rgba(0,0,0,0.45);
      position: relative;
    }
    .scan-line {
      position: absolute; left: 10px; right: 10px; height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      top: 0; animation: scan-move 2s ease-in-out infinite;
    }
    @keyframes scan-move { 0%{top:10px} 100%{top:calc(100% - 12px)} }
    #scan-status { font-family: var(--mono); font-size: 0.68rem; color: var(--text-muted); text-align: center; }

    /* Confirm */
    .confirm-avatar {
      width: 66px; height: 66px; background: var(--accent);
      border-radius: 50%; margin: 0 auto;
           --green: #22c55e;
      --red: #ef4444;
      --text: #e2eeff;
      --text-muted: #5a7aaa;
      --mono: 'Space Mono', monospace;
      --sans: 'Syne', sans-serif;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      width: 100%; height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      overflow: hidden;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* ─── SCREENS ─────────────────────────────────────── */
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 24px;
      transition: opacity 0.35s, transform 0.35s;
      z-index: 10;
    }
    .screen.hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }

    /* ─── AUTH SCREEN ─────────────────────────────────── */
    #auth-screen {
      background: var(--bg);
      gap: 32px;
    }
    .logo {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .logo-mark {
      width: 72px; height: 72px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 40px var(--accent-glow), inset 0 0 30px rgba(59,130,246,0.08);
      position: relative;
      animation: pulse-ring 3s ease-in-out infinite;
    }
    @keyframes pulse-ring {
      0%, 100% { box-shadow: 0 0 40px var(--accent-glow), inset 0 0 30px rgba(59,130,246,0.08); }
      50% { box-shadow: 0 0 80px var(--accent-glow), inset 0 0 50px rgba(59,130,246,0.15); }
    }
    .logo-mark::before {
      content: '';
      position: absolute;
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 1px solid rgba(99,179,255,0.3);
      animation: spin 8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .logo-mark svg { width: 28px; height: 28px; fill: var(--accent); }
    .logo h1 { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.02em; }
    .logo p { font-family: var(--mono); font-size: 0.7rem; color: var(--text-muted); letter-spacing: 0.2em; text-transform: uppercase; }

    .auth-form { width: 100%; max-width: 360px; display: flex; flex-direction: column; gap: 12px; }
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    .input-group label { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.1em; text-transform: uppercase; }
    .input-group input {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      color: var(--text);
      font-family: var(--mono);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }
    .input-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .btn {
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      font-family: var(--sans);
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.01em;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 0 30px var(--accent-glow);
    }
    .btn-primary:active { transform: scale(0.97); box-shadow: 0 0 15px var(--accent-glow); }
    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .btn-ghost:active { background: var(--surface); }

    .divider { text-align: center; font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); }
    .error-msg { font-family: var(--mono); font-size: 0.7rem; color: var(--red); text-align: center; min-height: 16px; }

    /* ─── MAP SCREEN ──────────────────────────────────── */
    #map-screen { padding: 0; background: transparent; }

    #map {
      position: fixed; inset: 0;
      z-index: 1;
    }

    /* Leaflet tiles dark */
    .leaflet-tile { filter: brightness(0.85) saturate(0.7) hue-rotate(200deg); }

    /* ─── TOP BAR ─────────────────────────────────────── */
    .top-bar {
      position: fixed;
      top: 0; left: 0; right: 0;
      padding: calc(var(--safe-top) + 12px) 16px 12px;
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(to bottom, rgba(4,8,18,0.95) 60%, transparent);
      z-index: 100;
    }
    .app-name {
      font-size: 1.3rem; font-weight: 800; letter-spacing: -0.02em;
      display: flex; align-items: center; gap: 8px;
    }
    .app-name .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 10px var(--green);
      animation: blink 2s ease-in-out infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .top-actions { display: flex; gap: 8px; }
    .icon-btn {
      width: 40px; height: 40px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }
    .icon-btn:active { transform: scale(0.9); }
    .icon-btn svg { width: 18px; height: 18px; fill: var(--text); }

    /* ─── FAB ─────────────────────────────────────────── */
    .fab-container {
      position: fixed;
      bottom: calc(var(--safe-bottom) + 100px);
      right: 20px;
      z-index: 100;
      display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
    }
    .fab {
      width: 56px; height: 56px;
      border-radius: 50%;
      border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
      position: relative;
    }
    .fab:active { transform: scale(0.9); }
    .fab-visibility {
      background: var(--green);
      box-shadow: 0 0 30px rgba(34,197,94,0.5);
    }
    .fab-visibility.off {
      background: var(--surface2);
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .fab-visibility svg { width: 24px; height: 24px; fill: #fff; }
    .fab-add {
      background: var(--accent);
      box-shadow: 0 0 30px var(--accent-glow);
      width: 48px; height: 48px;
    }
    .fab-add svg { width: 20px; height: 20px; fill: #fff; }

    /* ─── CONTACTS PANEL ─────────────────────────────── */
    .contacts-panel {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      z-index: 90;
      transform: translateY(calc(100% - 80px));
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      max-height: 75vh;
      display: flex; flex-direction: column;
      padding-bottom: var(--safe-bottom);
    }
    .contacts-panel.open { transform: translateY(0); }

    .panel-handle {
      width: 36px; height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 12px auto 0;
      cursor: pointer;
    }
    .panel-header {
      padding: 12px 20px 8px;
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer;
    }
    .panel-title {
      font-size: 1rem; font-weight: 700;
      display: flex; align-items: center; gap: 8px;
    }
    .contact-count {
      font-family: var(--mono);
      font-size: 0.65rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 20px;
      color: var(--text-muted);
    }

    .contacts-list {
      overflow-y: auto;
      padding: 0 16px 16px;
      display: flex; flex-direction: column; gap: 8px;
      flex: 1;
    }
    .contacts-list::-webkit-scrollbar { display: none; }

    .contact-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      display: flex; align-items: center; gap: 14px;
      transition: all 0.2s;
    }
    .contact-card:active { opacity: 0.7; }

    .contact-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1rem;
      flex-shrink: 0;
      position: relative;
    }
    .status-dot {
      position: absolute; bottom: -1px; right: -1px;
      width: 12px; height: 12px; border-radius: 50%;
      border: 2px solid var(--surface2);
    }
    .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.offline { background: var(--text-muted); }

    .contact-info { flex: 1; overflow: hidden; }
    .contact-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 2px; }
    .contact-dist { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); }

    .locate-btn {
      width: 34px; height: 34px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .locate-btn:active { background: var(--accent); border-color: var(--accent); }
    .locate-btn svg { width: 14px; height: 14px; fill: var(--text-muted); }
    .locate-btn:active svg { fill: #fff; }

    .empty-contacts {
      text-align: center; padding: 32px 16px;
      font-family: var(--mono); font-size: 0.75rem; color: var(--text-muted);
      line-height: 1.8;
    }

    /* ─── MODALS ─────────────────────────────────────── */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(4,8,18,0.92);
      backdrop-filter: blur(12px);
      z-index: 200;
      display: flex; align-items: center; justify-content: center;
      padding: 24px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 28px 24px;
      width: 100%; max-width: 360px;
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
      display: flex; flex-direction: column; gap: 20px;
    }
    .modal-overlay.open .modal { transform: scale(1) translateY(0); }

    .modal-header { display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.2rem; font-weight: 800; }
    .close-btn {
      width: 32px; height: 32px;
      background: var(--surface2);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 1.1rem; color: var(--text-muted);
    }

    /* QR Modal */
    .qr-tabs { display: flex; gap: 8px; }
    .qr-tab {
      flex: 1; padding: 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      text-align: center;
      font-family: var(--mono); font-size: 0.65rem;
      color: var(--text-muted);
      cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em;
      transition: all 0.2s;
    }
    .qr-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    #qr-display { display: flex; flex-direction: column; gap: 16px; align-items: center; }
    #qr-scan { display: none; flex-direction: column; gap: 12px; }

    #qrcode-container {
      background: #fff;
      padding: 16px;
      border-radius: 16px;
      display: inline-block;
    }
    #qrcode-container canvas, #qrcode-container img { display: block; }

    .qr-hint { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); text-align: center; line-height: 1.6; }

    #scan-video-container {
      position: relative;
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      aspect-ratio: 1;
    }
    #scan-video { width: 100%; height: 100%; object-fit: cover; }
    .scan-overlay {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
    }
    .scan-frame {
      width: 180px; height: 180px;
      border: 2px solid var(--accent);
      border-radius: 16px;
      box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
    }
    .scan-line {
      position: absolute; left: 50%; top: 50%;
      width: 160px; height: 2px;
      background: linear-gradient(to right, transparent, var(--accent), transparent);
      transform: translate(-50%, -50%);
      animation: scan-anim 2s ease-in-out infinite;
    }
    @keyframes scan-anim {
      0% { margin-top: -80px; }
      100% { margin-top: 80px; }
    }
    #scan-status { font-family: var(--mono); font-size: 0.7rem; color: var(--text-muted); text-align: center; }

    /* Confirm modal */
    .confirm-avatar {
      width: 64px; height: 64px;
      background: var(--accent);
      border-radius: 50%;
      margin: 0 auto;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.8rem; font-weight: 800;
      box-shadow: 0 0 30px var(--accent-glow);
    }
    .confirm-name { text-align: center; font-size: 1.1rem; font-weight: 700; }
    .confirm-sub { text-align: center; font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); }
    .confirm-actions { display: flex; gap: 10px; }
    .btn-danger { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }

    /* Locate me btn */
    .locate-me-btn {
      position: fixed;
      bottom: calc(var(--safe-bottom) + 170px);
      left: 20px;
      width: 44px; height: 44px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 100;
      backdrop-filter: blur(10px);
      transition: all 0.2s;
    }
    .locate-me-btn:active { background: var(--accent); border-color: var(--accent); }
    .locate-me-btn svg { width: 18px; height: 18px; fill: var(--text); }

    /* Notification toast */
    .toast {
      position: fixed;
      top: calc(var(--safe-top) + 70px);
      left: 50%; transform: translateX(-50%) translateY(-20px);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 10px 20px;
      font-family: var(--mono); font-size: 0.7rem;
      z-index: 300;
      white-space: nowrap;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Marker styles */
    .user-marker {
      width: 36px; height: 36px;
      border-radius: 50%;
      border: 3px solid #fff;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      cursor: pointer;
    }
    .my-marker {
      width: 16px; height: 16px;
      border-radius: 50%;
      background: var(--green);
      border: 3px solid #fff;
      box-shadow: 0 0 20px var(--green-glow);
    }
    .pulse-ring {
      position: absolute;
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid var(--green);
      animation: expand 2s ease-out infinite;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }
    @keyframes expand {
      0% { width: 16px; height: 16px; opacity: 0.8; }
      100% { width: 60px; height: 60px; opacity: 0; }
    }

    /* Loading */
    .loader {
      width: 40px; height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Profile chip */
    .profile-chip {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 12px 6px 6px;
      cursor: pointer;
    }
    .profile-chip-avatar {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; font-weight: 700;
    }
    .profile-chip-name { font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); }

    /* ── AUTH FOOTER ─────────────────────────────────────── */
    .auth-footer { font-family: var(--mono); font-size: 0.55rem; color: var(--text-muted); opacity: 0.45; text-align: center; margin-top: 4px; }

    /* ── HEADER DOT HIDDEN STATE ──────────────────────────── */
    .app-name .dot { transition: background 0.4s, box-shadow 0.4s; }
    .app-name .dot.vis-off { background: var(--orange) !important; box-shadow: 0 0 10px var(--orange) !important; animation: none !important; }

    /* ── FAB VIS STATES (override legacy) ────────────────── */
    .fab-visibility.vis-off { background: var(--orange) !important; box-shadow: 0 4px 30px var(--orange-glow) !important; }

    /* ── QR WAIT MODAL ───────────────────────────────────── */
    .qr-wait { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 14px; padding: 8px 0; }
    .qr-wait-spinner { width: 60px; height: 60px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.9s linear infinite; }
    .qr-wait-text { font-family: var(--mono); font-size: 0.72rem; color: var(--text-muted); line-height: 1.8; }
    .qr-wait-name { font-size: 1.1rem; font-weight: 800; }

    /* ── NAVIGATION MODAL ────────────────────────────────── */
    .nav-options { display: flex; flex-direction: column; gap: 8px; }
    .nav-option { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: var(--surface2); border: 1px solid var(--border); border-radius: 14px; cursor: pointer; transition: all var(--transition); text-decoration: none; color: var(--text); }
    .nav-option:hover { border-color: var(--accent); background: rgba(59,130,246,0.1); }
    .nav-option:active { transform: scale(0.97); opacity: 0.8; }
    .nav-option-icon { width: 40px; height: 40px; border-radius: 50%; background: rgba(59,130,246,0.12); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .nav-option-icon svg { width: 20px; height: 20px; fill: var(--accent); }
    .nav-option-label { font-weight: 700; font-size: 0.88rem; }
    .nav-option-sub { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); margin-top: 2px; }

    /* ── SETTINGS MODAL ──────────────────────────────────── */
    .settings-group { display: flex; flex-direction: column; gap: 6px; }
    .settings-group-label { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); letter-spacing: 0.1em; text-transform: uppercase; padding-left: 4px; margin-bottom: 2px; }
    .settings-item { display: flex; align-items: center; gap: 12px; padding: 13px 16px; background: var(--surface2); border: 1px solid var(--border); border-radius: 14px; cursor: pointer; transition: all var(--transition); }
    .settings-item:hover { border-color: rgba(99,179,255,0.25); }
    .settings-item:active { transform: scale(0.97); }
    .settings-item svg { width: 18px; height: 18px; fill: var(--text-muted); flex-shrink: 0; }
    .settings-item-text { flex: 1; }
    .settings-item-title { font-weight: 600; font-size: 0.88rem; }
    .settings-item-value { font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); margin-top: 1px; }
    .settings-item.danger svg { fill: var(--red); }
    .settings-item.danger .settings-item-title { color: var(--red); }
    .settings-item.danger { border-color: rgba(239,68,68,0.15); background: rgba(239,68,68,0.05); }

    /* ── COMPASS BAR ─────────────────────────────────────── */
    .compass-bar { position: fixed; top: calc(var(--safe-top) + 58px); left: 50%; transform: translateX(-50%); z-index: 100; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 5px 14px; font-family: var(--mono); font-size: 0.65rem; color: var(--text-muted); display: none; align-items: center; gap: 8px; backdrop-filter: blur(12px); white-space: nowrap; pointer-events: none; }
    .compass-bar.visible { display: flex; }
    .compass-needle { font-size: 1rem; display: inline-block; transition: transform 0.15s linear; }

    /* ── SIDE BUTTONS ────────────────────────────────────── */
    .side-btns { position: fixed; right: calc(16px + var(--safe-right)); bottom: calc(var(--safe-bottom) + 190px); z-index: 100; display: flex; flex-direction: column; gap: 10px; align-items: center; }

    /* ── SETTINGS OPEN BTN in TOP BAR ───────────────────── */
    .settings-btn { margin-left: 4px; }

    /* ── HAMBURGER BTN ───────────────────────────────────── */
    .hamburger-btn {
      width: 44px; height: 44px; border-radius: 12px;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--transition);
      backdrop-filter: blur(12px); flex-shrink: 0;
    }
    .hamburger-btn:hover { border-color: rgba(99,179,255,0.3); background: var(--surface2); }
    .hamburger-btn:active { transform: scale(0.92); }
    .hamburger-btn svg { width: 20px; height: 20px; fill: var(--text); }

    /* ── ORIZON TITLE GRADIENT / GLOW ───────────────────── */
    .orizon-title {
      background: linear-gradient(135deg, #e2eeff 0%, #93c5fd 50%, #3b82f6 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; transition: filter 0.3s;
    }
    .orizon-title:hover { filter: drop-shadow(0 0 10px rgba(99,179,255,0.9)); }

    /* ── SIDEBAR / DRAWER ────────────────────────────────── */
    .sidebar-overlay {
      position: fixed; inset: 0; z-index: 150;
      background: rgba(4,8,18,0.72); backdrop-filter: blur(6px);
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .sidebar-overlay.open { opacity: 1; pointer-events: all; }
    .sidebar {
      position: fixed; top: 0; left: 0; bottom: 0; z-index: 160;
      width: 280px; max-width: 85vw;
      background: var(--surface); border-right: 1px solid var(--border);
      transform: translateX(-100%);
      transition: transform 0.35s cubic-bezier(0.32,0.72,0,1);
      display: flex; flex-direction: column;
      padding-top: calc(var(--safe-top) + 16px);
      padding-bottom: calc(var(--safe-bottom) + 16px);
      backdrop-filter: blur(20px);
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header {
      padding: 4px 16px 16px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .sidebar-logo { display: flex; align-items: center; gap: 10px; }
    .sidebar-logo-mark {
      width: 36px; height: 36px; border-radius: 50%;
      border: 1.5px solid var(--accent);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 16px var(--accent-glow);
    }
    .sidebar-logo-mark svg { width: 16px; height: 16px; fill: var(--accent); }
    .sidebar-logo-name {
      font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .sidebar-close {
      width: 30px; height: 30px; border-radius: 50%;
      background: var(--surface2); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 0.9rem; color: var(--text-muted); transition: all 0.2s;
    }
    .sidebar-close:hover { background: rgba(239,68,68,0.15); color: var(--red); }
    .sidebar-nav { padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; flex: 1; overflow-y: auto; }
    .sidebar-item {
      display: flex; align-items: center; gap: 14px;
      padding: 13px 14px; border-radius: 14px;
      cursor: pointer; transition: all var(--transition);
      font-weight: 600; font-size: 0.9rem; color: var(--text);
    }
    .sidebar-item:hover { background: var(--surface2); }
    .sidebar-item:active { transform: scale(0.97); opacity: 0.8; }
    .sidebar-item svg { width: 20px; height: 20px; fill: var(--text-muted); flex-shrink: 0; transition: fill 0.2s; }
    .sidebar-item:hover svg { fill: var(--accent); }
    .sidebar-item.active { background: rgba(59,130,246,0.12); color: var(--accent); }
    .sidebar-item.active svg { fill: var(--accent); }
    .sidebar-item-badge {
      margin-left: auto; font-family: var(--mono); font-size: 0.58rem;
      background: var(--accent); color: #fff;
      padding: 2px 7px; border-radius: 20px;
    }
    .sidebar-footer { padding: 12px 12px 0; border-top: 1px solid var(--border); }
    .sidebar-user {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 14px; border-radius: 14px;
      cursor: pointer; transition: all var(--transition);
    }
    .sidebar-user:hover { background: var(--surface2); }
    .sidebar-user-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--accent); display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 0.9rem; flex-shrink: 0;
    }
    .sidebar-user-info { flex: 1; overflow: hidden; }
    .sidebar-user-name { font-weight: 700; font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sidebar-user-email { font-family: var(--mono); font-size: 0.58rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* ── FAB FADE WHEN SIDEBAR OPEN ─────────────────────── */
    .fab-container.sidebar-open { opacity: 0; pointer-events: none; }
    .fab-container { transition: opacity 0.25s; }

    /* ── ARROW MARKER ────────────────────────────────────── */
    .my-marker-arrow {
      width: 0; height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 24px solid var(--accent);
      filter: drop-shadow(0 0 8px var(--accent-glow));
      transform-origin: 50% 75%;
    }
    .my-marker-arrow.vis-partial { border-bottom-color: var(--orange); filter: drop-shadow(0 0 8px var(--orange-glow)); }
    .my-marker-arrow.vis-ghost { border-bottom-color: var(--red); filter: drop-shadow(0 0 8px rgba(239,68,68,0.4)); }

    /* ── 3-STATE VISIBILITY ──────────────────────────────── */
    .fab-visibility.vis-partial { background: var(--orange) !important; box-shadow: 0 4px 30px var(--orange-glow) !important; }
    .fab-visibility.vis-ghost { background: var(--red) !important; box-shadow: 0 4px 30px rgba(239,68,68,0.4) !important; }
    .tracking-dot.vis-partial { background: var(--orange) !important; box-shadow: 0 0 10px var(--orange) !important; animation: none !important; }
    .tracking-dot.vis-ghost { background: var(--red) !important; box-shadow: 0 0 10px var(--red) !important; animation: none !important; }

    /* ── BATTERY BADGE ───────────────────────────────────── */
    .battery-info { display: inline-flex; align-items: center; gap: 3px; font-family: var(--mono); font-size: 0.58rem; color: var(--green); }
    .battery-info.low { color: var(--orange); }
    .battery-info.critical { color: var(--red); }



    /* ── "IL MONDO ORIZON" ───────────────────────────────── */
    .orizon-world-card {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 16px;
      display: flex; align-items: flex-start; gap: 12px;
    }
    .orizon-world-icon {
      width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(59,130,246,0.12); border: 1px solid rgba(59,130,246,0.2);
    }
    .orizon-world-icon svg { width: 20px; height: 20px; fill: var(--accent); }
    .orizon-world-title { font-weight: 700; font-size: 0.88rem; margin-bottom: 4px; }
    .orizon-world-text { font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); line-height: 1.7; }
    .tip-item {
      display: flex; align-items: flex-start; gap: 8px;
      padding: 8px 0; border-bottom: 1px solid var(--border);
      font-family: var(--mono); font-size: 0.62rem; color: var(--text-muted); line-height: 1.6;
    }
    .tip-item:last-child { border-bottom: none; }
    .tip-num { color: var(--accent); font-weight: 700; flex-shrink: 0; }

    /* ══ OVERRIDES: LAYOUT RESTRUCTURING ══════════════════ */

    /* Top bar: 3-column grid for centered title */
    .top-bar {
      display: grid !important;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
    }
    .top-bar .profile-chip { justify-self: start; }
    .top-bar .app-name { justify-self: center; }
    .top-bar .hamburger-btn { justify-self: end; }

    /* Sidebar: open from RIGHT */
    .sidebar {
      left: auto !important;
      right: 0 !important;
      border-right: none !important;
      border-left: 1px solid var(--border) !important;
      transform: translateX(100%) !important;
    }
    .sidebar.open { transform: translateX(0) !important; }

    /* Hide FABs completely */
    .fab-container { display: none !important; }

    /* ══ VISIBILITY MODAL ════════════════════════════════ */
    .vis-options { display: flex; flex-direction: column; gap: 8px; }
    .vis-radio-item {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 16px; background: var(--surface2);
      border: 1px solid var(--border); border-radius: 14px;
      cursor: pointer; transition: all var(--transition);
    }
    .vis-radio-item:hover { border-color: rgba(99,179,255,0.25); }
    .vis-radio-item.selected { border-color: var(--accent); background: rgba(59,130,246,0.08); }
    .vis-radio-item input[type="radio"] { display: none; }
    .vis-radio-dot {
      width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0;
      position: relative;
    }
    .vis-radio-dot.green { background: var(--green); box-shadow: 0 0 10px var(--green-glow); }
    .vis-radio-dot.red { background: var(--red); box-shadow: 0 0 10px rgba(239,68,68,0.4); }
    .vis-radio-dot.orange { background: var(--orange); box-shadow: 0 0 10px var(--orange-glow); }
    .vis-radio-dot::after {
      content: ''; position: absolute; inset: 0; border-radius: 50%;
      animation: vis-pulse 2s ease-in-out infinite;
    }
    @keyframes vis-pulse {
      0%,100% { box-shadow: 0 0 0 0 currentColor; opacity: 0.6; }
      50% { box-shadow: 0 0 0 6px currentColor; opacity: 0; }
    }
    .vis-radio-dot.green::after { color: var(--green); }
    .vis-radio-dot.red::after { color: var(--red); }
    .vis-radio-dot.orange::after { color: var(--orange); }
    .vis-radio-text { flex: 1; }
    .vis-radio-label { font-weight: 700; font-size: 0.88rem; }
    .vis-radio-sub { font-family: var(--mono); font-size: 0.6rem; color: var(--text-muted); margin-top: 2px; }

    /* Custom users checklist */
    .custom-user-item {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 14px; background: var(--surface2);
      border: 1px solid var(--border); border-radius: 12px;
      cursor: pointer; transition: all var(--transition);
      margin-bottom: 6px;
    }
    .custom-user-item:hover { border-color: rgba(99,179,255,0.25); }
    .custom-user-item.checked { border-color: var(--accent); background: rgba(59,130,246,0.08); }
    .custom-user-item input[type="checkbox"] { display: none; }
    .custom-user-check {
      width: 20px; height: 20px; border-radius: 6px; flex-shrink: 0;
      border: 2px solid var(--border); display: flex; align-items: center;
      justify-content: center; transition: all 0.2s;
    }
    .custom-user-item.checked .custom-user-check {
      background: var(--accent); border-color: var(--accent);
    }
    .custom-user-check svg { width: 12px; height: 12px; fill: #fff; opacity: 0; transition: opacity 0.2s; }
    .custom-user-item.checked .custom-user-check svg { opacity: 1; }
    .custom-user-avatar {
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem; color: #fff; flex-shrink: 0;
    }
    .custom-user-name { font-weight: 600; font-size: 0.85rem; }

    /* ══ PROFILE PICTURE ═════════════════════════════════ */
    .settings-avatar-wrapper {
      position: relative; width: 64px; height: 64px; margin: 0 auto 8px;
      cursor: pointer;
    }
    .settings-avatar-wrapper:hover .settings-avatar-overlay { opacity: 1; }
    .settings-avatar-img {
      width: 64px; height: 64px; border-radius: 50%; object-fit: cover;
      background: var(--accent); display: flex; align-items: center;
      justify-content: center; font-size: 1.5rem; font-weight: 800; color: #fff;
      border: 2px solid var(--border);
    }
    .settings-avatar-overlay {
      position: absolute; inset: 0; border-radius: 50%;
      background: rgba(0,0,0,0.5); display: flex; align-items: center;
      justify-content: center; opacity: 0; transition: opacity 0.2s;
    }
    .settings-avatar-overlay svg { width: 22px; height: 22px; fill: #fff; }
    .profile-chip-avatar { position: relative; overflow: hidden; }
    .profile-chip-avatar img {
      position: absolute; inset: 0; width: 100%; height: 100%;
      border-radius: 50%; object-fit: cover;
    }

    /* ══ GPS POINTER — PULSING & NEVER BLUE ══════════════ */
    .my-marker {
      background: var(--green) !important;
      border: 3px solid #fff;
      box-shadow: 0 0 20px var(--green-glow) !important;
    }
    .my-marker.vis-none {
      background: var(--red) !important;
      box-shadow: 0 0 20px rgba(239,68,68,0.4) !important;
    }
    .my-marker.vis-custom {
      background: var(--orange) !important;
      box-shadow: 0 0 20px var(--orange-glow) !important;
    }
    .pulse-ring {
      border-color: var(--green) !important;
      animation: gps-pulse 2s ease-out infinite !important;
    }
    .pulse-ring.vis-none {
      border-color: var(--red) !important;
    }
    .pulse-ring.vis-custom {
      border-color: var(--orange) !important;
    }
    @keyframes gps-pulse {
      0% { width: 16px; height: 16px; opacity: 0.8; }
      100% { width: 60px; height: 60px; opacity: 0; }
    }
    .my-marker-arrow {
      border-bottom-color: var(--green) !important;
      filter: drop-shadow(0 0 8px var(--green-glow)) !important;
    }
    .my-marker-arrow.vis-none {
      border-bottom-color: var(--red) !important;
      filter: drop-shadow(0 0 8px rgba(239,68,68,0.4)) !important;
    }
    .my-marker-arrow.vis-custom {
      border-bottom-color: var(--orange) !important;
      filter: drop-shadow(0 0 8px var(--orange-glow)) !important;
    }

    /* Tracking dot pulsing for all states */
    .tracking-dot { animation: gps-dot-pulse 2s ease-in-out infinite !important; }
    @keyframes gps-dot-pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .tracking-dot.vis-none {
      background: var(--red) !important;
      box-shadow: 0 0 10px var(--red) !important;
    }
    .tracking-dot.vis-custom {
      background: var(--orange) !important;
      box-shadow: 0 0 10px var(--orange) !important;
    }
    .tracking-dot.vis-all {
      background: var(--green) !important;
      box-shadow: 0 0 10px var(--green) !important;
    }

    /* ══ DRAGGABLE BOTTOM SHEET ══════════════════════════ */
    .contacts-panel { touch-action: pan-x; transform: translateY(calc(100% - 72px)); }
    .contacts-panel.open { transform: translateY(0); }
    .contacts-panel.dragging { transition: none !important; }
    .panel-drag { padding: 10px 20px 6px; cursor: grab; display: flex; flex-direction: column; gap: 8px; touch-action: none; }
    .panel-drag:active { cursor: grabbing; }

    /* Dynamic floating icon anchoring */
    .side-btns { bottom: calc(var(--safe-bottom) + var(--panel-h, 72px) + 20px) !important; transition: bottom 0.4s cubic-bezier(0.32,0.72,0,1) !important; }
    .locate-me-btn { bottom: calc(var(--safe-bottom) + var(--panel-h, 72px) + 20px) !important; transition: bottom 0.4s cubic-bezier(0.32,0.72,0,1) !important; }
    body.panel-dragging .side-btns,
    body.panel-dragging .locate-me-btn { transition: none !important; }

    /* Remove user button */
    .mini-btn.remove-btn:hover { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .mini-btn.remove-btn:hover svg { fill: var(--red); }
  </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="screen" id="auth-screen">
  <div class="logo">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
    </div>
    <h1>Orizon</h1>
    <p>Real-time location sharing</p>
  </div>

  <div class="auth-form" id="auth-form">
    <div id="auth-login">
      <div class="input-group" style="margin-bottom:12px">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="tu@email.com" autocomplete="email" />
      </div>
      <div class="input-group" style="margin-bottom:16px">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="••••••••" autocomplete="current-password" />
      </div>
      <button class="btn btn-primary" onclick="handleLogin()" style="width:100%;margin-bottom:10px">Accedi</button>
      <div class="divider">— oppure —</div>
      <button class="btn btn-ghost" onclick="showRegister()" style="width:100%;margin-top:10px">Crea account</button>
    </div>

    <div id="auth-register" style="display:none">
      <div class="input-group" style="margin-bottom:12px">
        <label>Nome visualizzato</label>
        <input type="text" id="reg-name" placeholder="Il tuo nome" autocomplete="name" />
      </div>
      <div class="input-group" style="margin-bottom:12px">
        <label>Email</label>
        <input type="email" id="reg-email" placeholder="tu@email.com" autocomplete="email" />
      </div>
      <div class="input-group" style="margin-bottom:16px">
        <label>Password</label>
        <input type="password" id="reg-password" placeholder="min. 8 caratteri" autocomplete="new-password" />
      </div>
      <button class="btn btn-primary" onclick="handleRegister()" style="width:100%;margin-bottom:10px">Registrati</button>
      <button class="btn btn-ghost" onclick="showLogin()" style="width:100%;margin-top:4px">Ho già un account</button>
    </div>

    <p class="error-msg" id="auth-error"></p>
  </div>
  <div class="auth-footer">v1.0.0 · Build 202405</div>
</div>

<!-- VERIFIED SCREEN -->
<div class="screen hidden" id="verified-screen">
  <div class="verified-icon">
    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
  </div>
  <div class="verified-title">Email Verificata!</div>
  <div class="verified-sub">Il tuo account è stato verificato con successo.<br/>Ora puoi accedere a Orizon.</div>
  <button class="btn btn-primary" style="width:100%;max-width:280px;margin-top:8px" onclick="goToMapFromVerified()">Vai alla Mappa →</button>
</div>

<!-- MAP SCREEN -->
<div class="screen hidden" id="map-screen">
  <div id="map"></div>

  <!-- Top Bar -->
  <div class="top-bar">
    <div class="profile-chip" onclick="openSettings()">
      <div class="profile-chip-avatar" id="profile-avatar"><span id="profile-avatar-letter">?</span></div>
      <span class="profile-chip-name" id="profile-name">...</span>
    </div>
    <div class="app-name">
      <div class="dot tracking-dot vis-all" id="tracking-dot"></div>
      <span class="orizon-title">Orizon</span>
    </div>
    <div class="hamburger-btn" onclick="openSidebar()" title="Menu Cerchia">
      <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </div>
  </div>

  <!-- Compass Bar -->
  <div class="compass-bar" id="compass-bar">
    <span class="compass-needle" id="compass-needle">🧭</span>
    <span id="compass-text">N 0°</span>
  </div>

  <!-- Side Buttons -->
  <div class="side-btns">
    <div class="icon-btn" id="compass-btn" onclick="toggleCompass()" title="Modalità freccia/direzione">
      <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
    </div>
  </div>

  <!-- Locate Me -->
  <div class="locate-me-btn" onclick="centerOnMe()">
    <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
  </div>

  <!-- FABs removed — functions consolidated in sidebar -->

  <!-- Contacts Panel -->
  <div class="contacts-panel" id="contacts-panel">
    <div class="panel-drag" id="panel-drag-area">
      <div class="panel-handle"></div>
      <div class="panel-header" onclick="togglePanel()">
        <div class="panel-title">
          Cerchia
          <span class="contact-count" id="contact-count">0</span>
        </div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--text-muted)" id="panel-arrow">
          <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
      </div>
    </div>
    <div class="contacts-list" id="contacts-list">
      <div class="empty-contacts">
        Nessun contatto ancora.<br/>
        Premi + per aggiungere qualcuno<br/>
        alla tua cerchia.
      </div>
    </div>
  </div>
</div>

<!-- SIDEBAR OVERLAY -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">
      <div class="sidebar-logo-mark">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
      </div>
      <span class="sidebar-logo-name">Orizon</span>
    </div>
    <div class="sidebar-close" onclick="closeSidebar()">✕</div>
  </div>
  <div class="sidebar-nav">
    <div class="sidebar-item active" onclick="closeSidebar()">
      <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
      Mappa
    </div>
    <div class="sidebar-item" onclick="closeSidebar();openQRModal()">
      <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
      Aggiungi contatto
    </div>
    <div class="sidebar-item" onclick="closeSidebar();toggleCompass()">
      <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
      Modalità freccia
    </div>
    <div class="sidebar-item" id="sidebar-visibility-item" onclick="closeSidebar();openVisibilityModal()">
      <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      <span id="sidebar-vis-label">Chi può vederti</span>
    </div>
    <div class="sidebar-item" onclick="closeSidebar();openOrizonWorld()">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
      Il Mondo Orizon
    </div>
    <div class="sidebar-item" onclick="closeSidebar();openSettings()">
      <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
      Impostazioni
    </div>
  </div>
  <div class="sidebar-footer">
    <div class="sidebar-user" onclick="closeSidebar();openSettings()">
      <div class="sidebar-user-avatar" id="sidebar-avatar">?</div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sidebar-name">—</div>
        <div class="sidebar-user-email" id="sidebar-email">—</div>
      </div>
    </div>
  </div>
</div>

<!-- QR MODAL -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Aggiungi contatto</div>
      <div class="close-btn" onclick="closeQRModal()">✕</div>
    </div>

    <div class="qr-tabs">
      <div class="qr-tab active" id="tab-show" onclick="switchTab('show')">Il mio QR</div>
      <div class="qr-tab" id="tab-scan" onclick="switchTab('scan')">Scansiona</div>
    </div>

    <div id="qr-display">
      <div id="qrcode-container"></div>
      <p class="qr-hint">Fai scansionare questo codice<br/>da un amico per connettervi</p>
    </div>

    <div id="qr-scan">
      <div id="scan-video-container">
        <video id="scan-video" playsinline autoplay muted></video>
        <div class="scan-overlay">
          <div class="scan-frame"></div>
          <div class="scan-line"></div>
        </div>
      </div>
      <p id="scan-status">Punta la fotocamera sul QR code dell'amico</p>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL (for QR shower: accept/reject incoming request) -->
<div class="modal-overlay" id="confirm-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Nuova connessione</div>
      <div class="close-btn" onclick="rejectIncomingRequest()">✕</div>
    </div>
    <div class="confirm-avatar" id="confirm-avatar">?</div>
    <div class="confirm-name" id="confirm-name">—</div>
    <div class="confirm-sub">Vuole aggiungerti alla sua cerchia.<br/>Vuoi accettare?</div>
    <div class="confirm-actions">
      <button class="btn btn-danger" style="flex:1" onclick="rejectIncomingRequest()">Rifiuta</button>
      <button class="btn btn-primary" style="flex:1" onclick="acceptIncomingRequest()">Accetta ✓</button>
    </div>
  </div>
</div>

<!-- QR WAIT MODAL (for scanner: waiting for shower to confirm) -->
<div class="modal-overlay" id="qr-wait-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Richiesta inviata</div>
      <div class="close-btn" onclick="closeQRWaitModal()">✕</div>
    </div>
    <div class="qr-wait">
      <div class="qr-wait-spinner"></div>
      <div class="qr-wait-name" id="qr-wait-name">—</div>
      <div class="qr-wait-text">Attendi che l'altro utente<br/>accetti la connessione...</div>
    </div>
  </div>
</div>

<!-- NAVIGATION MODAL (transport selection) -->
<div class="modal-overlay" id="nav-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Navigazione</div>
      <div class="close-btn" onclick="closeNavModal()">✕</div>
    </div>
    <div style="font-family:var(--mono);font-size:0.62rem;color:var(--text-muted);text-align:center">
      Apri Google Maps verso <strong id="nav-target-name">—</strong>
    </div>
    <div class="nav-options">
      <div class="nav-option" onclick="openGoogleMaps('w')">
        <div class="nav-option-icon"><svg viewBox="0 0 24 24"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg></div>
        <div>
          <div class="nav-option-label">A piedi</div>
          <div class="nav-option-sub">Percorso pedonale</div>
        </div>
      </div>
      <div class="nav-option" onclick="openGoogleMaps('d')">
        <div class="nav-option-icon"><svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg></div>
        <div>
          <div class="nav-option-label">In auto</div>
          <div class="nav-option-sub">Percorso in auto</div>
        </div>
      </div>
      <div class="nav-option" onclick="openGoogleMaps('r')">
        <div class="nav-option-icon"><svg viewBox="0 0 24 24"><path d="M12 2c-4.42 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2.23l2-2H14l2 2H18v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-3.58-4-8-4zm0 2c3.62 0 5.5.46 5.93 1.5H6.07C6.5 4.46 8.38 4 12 4zm-.5 6.5h-4v-3h4v3zm1 0v-3h4v3h-4z"/></svg></div>
        <div>
          <div class="nav-option-label">Trasporto pubblico</div>
          <div class="nav-option-sub">Bus, metro, treno</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">Impostazioni</div>
      <div class="close-btn" onclick="closeSettings()">✕</div>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">Profilo</div>
      <div class="settings-avatar-wrapper" onclick="document.getElementById('avatar-file-input').click()" title="Cambia foto profilo">
        <div class="settings-avatar-img" id="settings-avatar-img"><span id="settings-avatar-letter">?</span></div>
        <div class="settings-avatar-overlay">
          <svg viewBox="0 0 24 24"><path d="M3 4V1h2v3h3v2H5v3H3V6H0V4h3zm3 6V7h3V4h7l1.83 2H21c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V10h3zm7 9c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-3.2-5c0 1.77 1.43 3.2 3.2 3.2s3.2-1.43 3.2-3.2-1.43-3.2-3.2-3.2-3.2 1.43-3.2 3.2z"/></svg>
        </div>
        <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)" />
      </div>
      <div class="settings-item" style="cursor:default">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title" id="settings-name">—</div>
          <div class="settings-item-value" id="settings-email">—</div>
        </div>
      </div>
    </div>

    <div class="settings-group">
      <div class="settings-group-label">Info</div>
      <div class="settings-item" onclick="openOrizonWorld();closeSettings()">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Il Mondo Orizon</div>
          <div class="settings-item-value">Mission, guida e privacy</div>
        </div>
      </div>
      <div class="settings-item" style="cursor:default">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Orizon</div>
          <div class="settings-item-value">Versione 1.0.0 · Build 202405</div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-item danger" onclick="deleteAccount()">
        <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Elimina account</div>
          <div class="settings-item-value">Cancella tutti i dati permanentemente</div>
        </div>
      </div>
      <div class="settings-item danger" onclick="handleLogout()">
        <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
        <div class="settings-item-text">
          <div class="settings-item-title">Esci</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- IL MONDO ORIZON MODAL -->
<div class="modal-overlay" id="orizon-world-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">🌍 Il Mondo Orizon</div>
      <div class="close-btn" onclick="closeOrizonWorld()">✕</div>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">La nostra missione</div>
      <div class="orizon-world-card">
        <div class="orizon-world-icon">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        </div>
        <div>
          <div class="orizon-world-title">Connetti le persone in sicurezza</div>
          <div class="orizon-world-text">Orizon nasce per permettere alle persone di condividere la propria posizione con chi scelgono, senza tracciamento invasivo, senza raccolta dati e senza vendita di informazioni a terzi. Solo tu decidi chi può vederti.</div>
        </div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">Tips &amp; Tricks</div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:14px 16px">
        <div class="tip-item"><span class="tip-num">01</span> Premi la freccia (→) nella barra destra per attivare la modalità direzione: il tuo punto diventa una freccia che segue il tuo sguardo grazie al giroscopio.</div>
        <div class="tip-item"><span class="tip-num">02</span> Apri il menu laterale e tocca "Chi può vederti" per gestire la visibilità: Verde = visibile a tutti, Arancione = utenti specifici, Rosso = invisibile.</div>
        <div class="tip-item"><span class="tip-num">03</span> Aggiungi un contatto scansionando il suo QR code o mostrando il tuo. Nessuna email, nessun numero di telefono richiesto.</div>
        <div class="tip-item"><span class="tip-num">04</span> Tocca un contatto nella lista per navigare verso di lui con Google Maps.</div>
        <div class="tip-item"><span class="tip-num">05</span> Usa l'icona 🚫 su un contatto per nasconderlo dalla mappa senza rimuoverlo dalla cerchia.</div>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">Privacy Manifesto</div>
      <div class="orizon-world-card">
        <div class="orizon-world-icon">
          <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
        </div>
        <div>
          <div class="orizon-world-title">I tuoi dati sono tuoi</div>
          <div class="orizon-world-text">• Le coordinate GPS sono cifrate in transito via HTTPS/TLS.<br/>• Nessun dato viene venduto o condiviso con terzi.<br/>• Puoi diventare "fantasma" in qualsiasi momento.<br/>• Le connessioni richiedono conferma reciproca tramite QR.<br/>• Puoi eliminare il tuo account e tutti i dati in qualsiasi momento.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- VISIBILITY MODAL -->
<div class="modal-overlay" id="visibility-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="vis-modal-title">Chi può vederti</div>
      <div class="close-btn" onclick="closeVisibilityModal()">✕</div>
    </div>
    <div class="vis-options">
      <label class="vis-radio-item selected" id="vis-opt-all" onclick="setVisibility('all')">
        <input type="radio" name="visibility" value="all" checked />
        <div class="vis-radio-dot green"></div>
        <div class="vis-radio-text">
          <div class="vis-radio-label">Tutti</div>
          <div class="vis-radio-sub">Tutti nella tua cerchia possono vederti</div>
        </div>
      </label>
      <label class="vis-radio-item" id="vis-opt-none" onclick="setVisibility('none')">
        <input type="radio" name="visibility" value="none" />
        <div class="vis-radio-dot red"></div>
        <div class="vis-radio-text">
          <div class="vis-radio-label">Nessuno</div>
          <div class="vis-radio-sub">Sei completamente invisibile</div>
        </div>
      </label>
      <label class="vis-radio-item" id="vis-opt-custom" onclick="setVisibility('custom')">
        <input type="radio" name="visibility" value="custom" />
        <div class="vis-radio-dot orange"></div>
        <div class="vis-radio-text">
          <div class="vis-radio-label">Scegli chi può vederti</div>
          <div class="vis-radio-sub" id="vis-custom-sub">Seleziona utenti specifici</div>
        </div>
      </label>
    </div>
    <div id="custom-users-list" style="display:none">
      <div class="settings-group-label" style="margin-bottom:8px">Seleziona utenti dalla tua cerchia</div>
      <div id="custom-users-container"></div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ─── CONFIG ─────────────────────────────────────────────
// Replace with your Supabase project URL and anon key
const SUPABASE_URL = window.SUPABASE_URL || 'https://slqgdewtdbugoofthcao.supabase.co';
const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscWdkZXd0ZGJ1Z29vZnRoY2FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyODMzOTYsImV4cCI6MjA4Nzg1OTM5Nn0.Gj9FKhlHdTBLOAvhwWV07RFz22A-BQJh6RwzufI0ehw';

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true }
});

// ─── STATE ───────────────────────────────────────────────
let currentUser = null;
let userProfile = null;
let map = null;
let myMarker = null;
let myPulse = null;
let contactMarkers = {};
let visState = 'all'; // 'all' | 'none' | 'custom'
let isVisible = true;
let panelOpen = false;
let sidebarOpen = false;
let geoWatcher = null;
let realtimeChannel = null;
let pendingConnection = null;
let scanAnimFrame = null;
let videoStream = null;
let contacts = [];
let compassMode = false;
let compassHeading = 0;

let hiddenUsers = (() => { try { return JSON.parse(localStorage.getItem('orizon_hidden_users') || '[]'); } catch { return []; } })();
let navTargetLat = null;
let navTargetLng = null;

let visibleToUsers = []; // user IDs for custom visibility
let profilePicUrl = null; // cached avatar URL

// ─── INIT ────────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', async () => {
  // Check for email verification redirect (Supabase v2 uses hash fragment)
  const hash = new URLSearchParams(window.location.hash.slice(1));
  const hashType = hash.get('type');
  if (hashType === 'email_confirmation' || hashType === 'signup') {
    // Supabase already processes the token; get resulting session
    const { data: { session } } = await db.auth.getSession();
    if (session) {
      currentUser = session.user;
      await loadUserProfile();
    }
    history.replaceState({}, '', '/');
    showVerifiedScreen();
    return;
  }

  const { data: { session } } = await db.auth.getSession();
  if (session) {
    currentUser = session.user;
    await loadUserProfile();
    showMapScreen();
  }

  db.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
      currentUser = session.user;
    }
  });

  // Check for QR token in URL
  const params = new URLSearchParams(window.location.search);
  const qrToken = params.get('connect');
  if (qrToken) {
    window.pendingQRToken = qrToken;
    history.replaceState({}, '', '/');
  }
});

// ─── AUTH ────────────────────────────────────────────────
function showVerifiedScreen() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('verified-screen').classList.remove('hidden');
}

async function goToMapFromVerified() {
  document.getElementById('verified-screen').classList.add('hidden');
  const { data: { session } } = await db.auth.getSession();
  if (session) {
    currentUser = session.user;
    if (!userProfile) await loadUserProfile();
    showMapScreen();
  } else {
    document.getElementById('auth-screen').classList.remove('hidden');
  }
}

function showRegister() {
  document.getElementById('auth-login').style.display = 'none';
  document.getElementById('auth-register').style.display = 'block';
}
function showLogin() {
  document.getElementById('auth-login').style.display = 'block';
  document.getElementById('auth-register').style.display = 'none';
}

async function handleLogin() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  setAuthError('');

  const { data, error } = await db.auth.signInWithPassword({ email, password });
  if (error) return setAuthError(error.message);

  currentUser = data.user;
  await loadUserProfile();
  showMapScreen();
}

async function handleRegister() {
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  setAuthError('');

  if (!name) return setAuthError('Inserisci il tuo nome.');
  if (password.length < 8) return setAuthError('Password minimo 8 caratteri.');

  const { data, error } = await db.auth.signUp({
    email, password,
    options: { data: { display_name: name } }
  });
  if (error) return setAuthError(error.message);

  // If email confirmation required, show message
  if (!data.session) {
    setAuthError('');
    document.getElementById('auth-error').style.color = 'var(--green)';
    document.getElementById('auth-error').textContent = '✓ Controlla la tua email per verificare l\'account.';
    return;
  }

  currentUser = data.user;
  // Create profile
  await db.from('profiles').upsert({
    id: currentUser.id,
    display_name: name,
    email: email
  });

  await loadUserProfile();
  showMapScreen();
}

async function handleLogout() {
  closeSettings();
  if (!confirm('Vuoi uscire da Orizon?')) return;
  stopGeolocation();
  stopCompass();
  if (realtimeChannel) db.removeChannel(realtimeChannel);
  await db.auth.signOut();
  currentUser = null; userProfile = null;
  document.getElementById('map-screen').classList.add('hidden');
  document.getElementById('auth-screen').classList.remove('hidden');
}

// ─── SETTINGS ────────────────────────────────────────────
function openSettings() {
  const name = userProfile?.display_name || currentUser?.email?.split('@')[0] || '—';
  const email = userProfile?.email || currentUser?.email || '—';
  document.getElementById('settings-name').textContent = name;
  document.getElementById('settings-email').textContent = email;

  // Update settings avatar
  const avatarUrl = userProfile?.avatar_url || profilePicUrl;
  const settingsAvatarEl = document.getElementById('settings-avatar-img');
  const settingsLetterEl = document.getElementById('settings-avatar-letter');
  if (avatarUrl) {
    settingsAvatarEl.style.backgroundImage = `url(${avatarUrl})`;
    settingsAvatarEl.style.backgroundSize = 'cover';
    settingsAvatarEl.style.backgroundPosition = 'center';
    settingsLetterEl.style.display = 'none';
  } else {
    settingsAvatarEl.style.backgroundImage = '';
    settingsLetterEl.style.display = '';
    settingsLetterEl.textContent = name[0]?.toUpperCase() || '?';
  }

  document.getElementById('settings-modal').classList.add('open');
}
function closeSettings() {
  document.getElementById('settings-modal').classList.remove('open');
}

function setAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.style.color = '';
  el.textContent = msg;
}

async function loadUserProfile() {
  let { data } = await db.from('profiles').select('*').eq('id', currentUser.id).single();
  if (!data) {
    // Create from auth metadata
    const name = currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
    await db.from('profiles').upsert({ id: currentUser.id, display_name: name, email: currentUser.email });
    data = { id: currentUser.id, display_name: name, email: currentUser.email };
  }
  userProfile = data;
  profilePicUrl = data.avatar_url || null;
}

// ─── MAP SCREEN ──────────────────────────────────────────
function showMapScreen() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('map-screen').classList.remove('hidden');

  // Update profile UI
  const name = userProfile?.display_name || currentUser.email.split('@')[0];
  const email = userProfile?.email || currentUser?.email || '';
  document.getElementById('profile-name').textContent = name.split(' ')[0];
  // Profile avatar: show pic or letter
  const avatarUrl = userProfile?.avatar_url || profilePicUrl;
  const profileAvatarEl = document.getElementById('profile-avatar');
  const profileLetterEl = document.getElementById('profile-avatar-letter');
  if (avatarUrl) {
    profileAvatarEl.innerHTML = `<img src="${avatarUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover" />`;
  } else {
    profileLetterEl.textContent = name[0].toUpperCase();
  }
  // Update sidebar profile
  document.getElementById('sidebar-avatar').textContent = name[0].toUpperCase();
  document.getElementById('sidebar-name').textContent = name;
  document.getElementById('sidebar-email').textContent = email;

  setTimeout(() => {
    initMap();
    startGeolocationWithBattery();
    loadContacts();
    subscribeRealtime();
    initPanelDrag();

    if (window.pendingQRToken) {
      handleIncomingQR(window.pendingQRToken);
      window.pendingQRToken = null;
    }
  }, 300);
}

// ─── MAP ─────────────────────────────────────────────────
function initMap() {
  if (map) return;
  map = L.map('map', {
    center: [41.9, 12.5],
    zoom: 13,
    zoomControl: false,
    attributionControl: false
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
}

function createMyMarker(lat, lng) {
  if (myMarker) { myMarker.setLatLng([lat, lng]); return; }

  const visClass = visState === 'none' ? ' vis-none' : visState === 'custom' ? ' vis-custom' : '';
  const el = document.createElement('div');
  if (compassMode) {
    el.style.cssText = 'position:relative;width:16px;height:24px;';
    el.innerHTML = `<div class="my-marker-arrow${visClass}"></div>`;
  } else {
    el.style.cssText = 'position:relative;width:16px;height:16px;';
    el.innerHTML = `<div class="my-marker${visClass}"></div><div class="pulse-ring${visClass}"></div>`;
  }

  myMarker = L.marker([lat, lng], {
    icon: L.divIcon({ html: el, className: '', iconSize: [16, 16], iconAnchor: [8, 8] })
  }).addTo(map);
}

function updateContactMarker(contact, lat, lng) {
  // Don't show marker if user is in hidden list
  if (hiddenUsers.includes(contact.id)) {
    removeContactMarker(contact.id);
    return;
  }

  const name = contact.display_name || '?';
  const initial = name[0].toUpperCase();
  const colors = ['#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981'];
  const color = colors[name.charCodeAt(0) % colors.length];

  if (contactMarkers[contact.id]) {
    contactMarkers[contact.id].setLatLng([lat, lng]);
    return;
  }

  const el = document.createElement('div');
  el.className = 'user-marker';
  el.style.background = color;
  el.style.color = '#fff';
  el.title = name;
  if (contact.avatar_url) {
    el.innerHTML = `<img src="${contact.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover" />`;
  } else {
    el.textContent = initial;
  }
  el.onclick = () => {
    map.flyTo([lat, lng], 16, { duration: 1 });
    openNavModal(name, lat, lng);
  };

  contactMarkers[contact.id] = L.marker([lat, lng], {
    icon: L.divIcon({ html: el, className: '', iconSize: [36, 36], iconAnchor: [18, 18] })
  }).addTo(map);
}

function removeContactMarker(userId) {
  if (contactMarkers[userId]) {
    map.removeLayer(contactMarkers[userId]);
    delete contactMarkers[userId];
  }
}

function centerOnMe() {
  if (myMarker) {
    map.flyTo(myMarker.getLatLng(), 16, { duration: 1 });
  }
}

// ─── GEOLOCATION ─────────────────────────────────────────
function startGeolocation() {
  if (!navigator.geolocation) return showToast('GPS non supportato');

  geoWatcher = navigator.geolocation.watchPosition(
    async (pos) => {
      const { latitude: lat, longitude: lng } = pos.coords;
      createMyMarker(lat, lng);

      if (!myMarker._hasCentered) {
        map.setView([lat, lng], 15);
        myMarker._hasCentered = true;
      }

      // Update DB
      await db.from('locations').upsert({
        user_id: currentUser.id,
        lat, lng,
        is_visible: isVisible,
        last_seen: new Date().toISOString()
      }, { onConflict: 'user_id' });
    },
    (err) => showToast('Errore GPS: ' + err.message),
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
  );
}

function stopGeolocation() {
  if (geoWatcher !== null) {
    navigator.geolocation.clearWatch(geoWatcher);
    geoWatcher = null;
  }
}

// ─── VISIBILITY MODAL ─────────────────────────────────────
function openVisibilityModal() {
  // Update radio selection to current state
  document.querySelectorAll('.vis-radio-item').forEach(el => el.classList.remove('selected'));
  if (visState === 'all') document.getElementById('vis-opt-all').classList.add('selected');
  else if (visState === 'none') document.getElementById('vis-opt-none').classList.add('selected');
  else document.getElementById('vis-opt-custom').classList.add('selected');

  // Show/hide custom users list
  document.getElementById('custom-users-list').style.display = visState === 'custom' ? 'block' : 'none';
  if (visState === 'custom') renderCustomUsersList();

  document.getElementById('visibility-modal').classList.add('open');
}
function closeVisibilityModal() {
  document.getElementById('visibility-modal').classList.remove('open');
}

async function setVisibility(mode) {
  visState = mode;
  isVisible = mode !== 'none';

  // Update radio UI
  document.querySelectorAll('.vis-radio-item').forEach(el => el.classList.remove('selected'));
  document.getElementById(`vis-opt-${mode}`).classList.add('selected');

  const dot = document.getElementById('tracking-dot');
  dot.classList.remove('vis-all', 'vis-none', 'vis-custom');

  if (mode === 'all') {
    dot.classList.add('vis-all');
    document.getElementById('custom-users-list').style.display = 'none';
    document.getElementById('sidebar-vis-label').textContent = 'Chi può vederti';
    showToast('🟢 Posizione visibile a tutti');
  } else if (mode === 'none') {
    dot.classList.add('vis-none');
    document.getElementById('custom-users-list').style.display = 'none';
    document.getElementById('sidebar-vis-label').textContent = 'Chi può vederti';
    showToast('🔴 Sei invisibile a tutti');
  } else {
    dot.classList.add('vis-custom');
    document.getElementById('custom-users-list').style.display = 'block';
    renderCustomUsersList();
    updateCustomVisLabel();
    showToast('🟠 Visibilità personalizzata');
  }

  // Update GPS marker colors
  updateMarkerVisState();

  await db.from('locations').update({ is_visible: isVisible })
    .eq('user_id', currentUser.id);
}

function updateMarkerVisState() {
  if (!myMarker) return;
  const el = myMarker.getElement();
  if (!el) return;

  const visClass = visState === 'none' ? 'vis-none' : visState === 'custom' ? 'vis-custom' : '';

  // Update dot marker
  const dot = el.querySelector('.my-marker');
  if (dot) {
    dot.classList.remove('vis-none', 'vis-custom');
    if (visClass) dot.classList.add(visClass);
  }
  const pulse = el.querySelector('.pulse-ring');
  if (pulse) {
    pulse.classList.remove('vis-none', 'vis-custom');
    if (visClass) pulse.classList.add(visClass);
  }

  // Update arrow marker
  const arrow = el.querySelector('.my-marker-arrow');
  if (arrow) {
    arrow.classList.remove('vis-none', 'vis-custom');
    if (visClass) arrow.classList.add(visClass);
  }
}

function renderCustomUsersList() {
  const container = document.getElementById('custom-users-container');
  if (contacts.length === 0) {
    container.innerHTML = '<div style="font-family:var(--mono);font-size:0.7rem;color:var(--text-muted);text-align:center;padding:16px">Nessun contatto nella cerchia</div>';
    return;
  }
  const colors = ['#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981'];
  container.innerHTML = contacts.map(c => {
    const initial = (c.display_name || '?')[0].toUpperCase();
    const color = colors[(c.display_name || '').charCodeAt(0) % colors.length];
    const checked = visibleToUsers.includes(c.id);
    return `
      <label class="custom-user-item ${checked ? 'checked' : ''}" onclick="toggleCustomUser('${c.id}', this)">
        <input type="checkbox" ${checked ? 'checked' : ''} />
        <div class="custom-user-check"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
        <div class="custom-user-avatar" style="background:${color}">${initial}</div>
        <div class="custom-user-name">${c.display_name || c.email}</div>
      </label>
    `;
  }).join('');
}

function toggleCustomUser(userId, el) {
  if (visibleToUsers.includes(userId)) {
    visibleToUsers = visibleToUsers.filter(id => id !== userId);
  } else {
    visibleToUsers.push(userId);
  }
  // Re-render to update checked state
  setTimeout(() => {
    renderCustomUsersList();
    updateCustomVisLabel();
  }, 10);
}

function updateCustomVisLabel() {
  const total = contacts.length;
  const selected = visibleToUsers.length;
  const modalTitle = document.getElementById('vis-modal-title');
  const sidebarLabel = document.getElementById('sidebar-vis-label');
  const customSub = document.getElementById('vis-custom-sub');

  if (selected > 0) {
    modalTitle.textContent = `Chi può vederti: ${selected} Utenti`;
    sidebarLabel.textContent = `Chi può vederti: ${selected}/${total} Utenti`;
    customSub.textContent = `${selected} utenti selezionati su ${total}`;
  } else {
    modalTitle.textContent = 'Chi può vederti';
    sidebarLabel.textContent = 'Chi può vederti';
    customSub.textContent = 'Seleziona utenti specifici';
  }
}

// ─── CONTACTS ────────────────────────────────────────────
async function loadContacts() {
  // Get accepted connections
  const { data: conns } = await db.from('connections')
    .select('user_a, user_b, status')
    .or(`user_a.eq.${currentUser.id},user_b.eq.${currentUser.id}`)
    .eq('status', 'accepted');

  if (!conns || conns.length === 0) return;

  const contactIds = conns.map(c =>
    c.user_a === currentUser.id ? c.user_b : c.user_a
  );

  const { data: profiles } = await db.from('profiles')
    .select('*').in('id', contactIds);

  contacts = profiles || [];
  document.getElementById('contact-count').textContent = contacts.length;

  // Load their locations
  const { data: locs } = await db.from('locations')
    .select('*').in('user_id', contactIds).eq('is_visible', true);

  renderContactsList(locs || []);
  (locs || []).forEach(loc => {
    const contact = contacts.find(c => c.id === loc.user_id);
    if (contact) updateContactMarker(contact, loc.lat, loc.lng);
  });
}

function contactStatusText(c, loc, isOnline, isHidden) {
  if (isHidden) return '🚫 Nascosto da te';
  if (isOnline) {
    if (loc && myMarker) return calcDist(myMarker.getLatLng(), { lat: loc.lat, lng: loc.lng }) + ' km';
    return 'Visibile';
  }
  if (loc && loc.last_seen) {
    const since = timeSince(new Date(loc.last_seen));
    return `Visto ${since}`;
  }
  return 'Mai visto';
}

function batteryHtml(pct) {
  if (pct == null) return '';
  const cls = pct < 15 ? 'critical' : pct < 30 ? 'low' : '';
  const icon = pct < 15
    ? '<path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/>'
    : '<path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4zm-2.67 14H11v-2h2v2zm0-4H11V9h2v5z"/>';
  return `<span class="battery-info ${cls}"><svg viewBox="0 0 24 24" style="width:10px;height:10px;fill:currentColor">${icon}</svg>${Math.round(pct * 100)}%</span>`;
}

function renderContactsList(locations) {
  const list = document.getElementById('contacts-list');
  if (contacts.length === 0) {
    list.innerHTML = `<div class="empty-contacts">Nessun contatto ancora.<br/>Premi + per aggiungere qualcuno<br/>alla tua cerchia.</div>`;
    return;
  }

  const SVG_EYE_ON = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
  const SVG_EYE_OFF = '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>';
  const SVG_NAV = '<path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>';

  list.innerHTML = contacts.map(c => {
    const loc = locations.find(l => l.user_id === c.id);
    const isOnline = !!(loc && loc.is_visible);
    const isHidden = hiddenUsers.includes(c.id);
    const initial = (c.display_name || '?')[0].toUpperCase();
    const colors = ['#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981'];
    const color = colors[(c.display_name || '').charCodeAt(0) % colors.length];
    const statusText = contactStatusText(c, loc, isOnline, isHidden);
    const eyeSvg = isHidden ? SVG_EYE_OFF : SVG_EYE_ON;
    const eyeTitle = isHidden ? 'Mostra sulla mappa' : 'Nascondi dalla mappa';
    const batteryPct = loc?.battery_level ?? null;
    const bHtml = batteryHtml(batteryPct);
    const navBtn = isOnline && !isHidden
      ? `<div class="mini-btn" onclick="event.stopPropagation();openNavModal('${c.display_name || c.email}',${loc.lat},${loc.lng})"><svg viewBox="0 0 24 24">${SVG_NAV}</svg></div>`
      : '';

    return `
      <div class="contact-card" onclick="flyToContact('${c.id}', ${loc?.lat || 0}, ${loc?.lng || 0}, ${isOnline})">
        <div class="contact-avatar" style="background:${color}">
          ${c.avatar_url ? `<img src="${c.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;position:absolute;inset:0" />` : initial}
          <div class="status-dot ${isOnline ? 'online' : 'offline'}"></div>
        </div>
        <div class="contact-info">
          <div class="contact-name" style="display:flex;align-items:center;gap:6px">${c.display_name || c.email}${bHtml}</div>
          <div class="contact-dist">${statusText}</div>
        </div>
        <div class="contact-actions">
          <div class="mini-btn remove-btn" onclick="event.stopPropagation();removeUserFromCircle('${c.id}')" title="Rimuovi dalla cerchia">
            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </div>
          <div class="mini-btn hide-user-btn ${isHidden ? 'active' : ''}" onclick="event.stopPropagation();toggleHideUser('${c.id}')" title="${eyeTitle}">
            <svg viewBox="0 0 24 24">${eyeSvg}</svg>
          </div>
          ${navBtn}
        </div>
      </div>
    `;
  }).join('');
}

// ─── PRIVACY: HIDE/SHOW USER ──────────────────────────────
function toggleHideUser(userId) {
  if (hiddenUsers.includes(userId)) {
    hiddenUsers = hiddenUsers.filter(id => id !== userId);
    // Reload marker for now-visible user
    const contact = contacts.find(c => c.id === userId);
    if (contact) loadContactsLocations();
    showToast('Contatto visibile sulla mappa');
  } else {
    hiddenUsers.push(userId);
    removeContactMarker(userId);
    showToast('Contatto nascosto dalla mappa');
  }
  localStorage.setItem('orizon_hidden_users', JSON.stringify(hiddenUsers));
  loadContactsLocations();
}

function flyToContact(userId, lat, lng, isOnline) {
  if (!isOnline || !lat) { showToast('Posizione non disponibile'); return; }
  map.flyTo([lat, lng], 16, { duration: 1.2 });
  if (panelOpen) togglePanel();
}

function calcDist(a, b) {
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const x = Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return (R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x))).toFixed(1);
}

function timeSince(date) {
  const s = (Date.now() - date) / 1000;
  if (s < 60) return 'ora';
  if (s < 3600) return Math.floor(s/60) + 'm fa';
  if (s < 86400) return Math.floor(s/3600) + 'h fa';
  return Math.floor(s/86400) + 'g fa';
}

// ─── REALTIME ────────────────────────────────────────────
function subscribeRealtime() {
  realtimeChannel = db.channel('locations-channel')
    .on('postgres_changes', {
      event: '*', schema: 'public', table: 'locations'
    }, (payload) => {
      const loc = payload.new;
      if (!loc || loc.user_id === currentUser.id) return;
      const contact = contacts.find(c => c.id === loc.user_id);
      if (!contact) return;

      if (loc.is_visible) {
        updateContactMarker(contact, loc.lat, loc.lng);
      } else {
        removeContactMarker(loc.user_id);
      }

      // Refresh list
      loadContactsLocations();
    })
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'connections'
    }, (payload) => {
      const conn = payload.new;
      // Shower: receives pending request from scanner
      if (conn.user_b === currentUser.id && conn.status === 'pending') {
        handleIncomingConnectionRequest(conn);
      }
    })
    .on('postgres_changes', {
      event: 'UPDATE', schema: 'public', table: 'connections'
    }, (payload) => {
      const conn = payload.new;
      // Scanner: their pending request was accepted by the shower
      if (conn.user_a === currentUser.id && conn.status === 'accepted') {
        closeQRWaitModal();
        closeQRModal();
        // Get the name of the other user
        const otherName = pendingConnection?.name || 'utente';
        showToast('Hai aggiunto ' + otherName + ' alla tua cerchia.');
        loadContacts();
      }
      // Scanner: their request was rejected
      if (conn.user_a === currentUser.id && conn.status === 'rejected') {
        closeQRWaitModal();
        closeQRModal();
        showToast('Richiesta rifiutata');
      }
    })
    .subscribe();
}

async function loadContactsLocations() {
  const contactIds = contacts.map(c => c.id);
  if (!contactIds.length) return;
  const { data: locs } = await db.from('locations')
    .select('*').in('user_id', contactIds);
  renderContactsList(locs || []);
}

// ─── PANEL ───────────────────────────────────────────────
function togglePanel() {
  panelOpen = !panelOpen;
  const panel = document.getElementById('contacts-panel');
  panel.classList.toggle('open', panelOpen);
  panel.style.transform = '';
  const arrow = document.getElementById('panel-arrow');
  arrow.style.transform = panelOpen ? 'rotate(180deg)' : '';
  if (panelOpen) {
    const h = Math.min(panel.offsetHeight, window.innerHeight * 0.72);
    updateFloatingPositions(h);
  } else {
    updateFloatingPositions(72);
  }
}

// ─── QR MODAL ────────────────────────────────────────────
function openQRModal() {
  generateQR();
  document.getElementById('qr-modal').classList.add('open');
}

function closeQRModal() {
  document.getElementById('qr-modal').classList.remove('open');
  stopScan();
  switchTab('show');
}

function generateQR() {
  const container = document.getElementById('qrcode-container');
  container.innerHTML = '';
  const token = btoa(JSON.stringify({
    uid: currentUser.id,
    name: userProfile?.display_name || currentUser.email,
    ts: Date.now()
  }));
  const url = `${window.location.origin}?connect=${token}`;
  new QRCode(container, {
    text: url, width: 200, height: 200,
    colorDark: '#040812', colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });
}

function switchTab(tab) {
  document.getElementById('tab-show').classList.toggle('active', tab === 'show');
  document.getElementById('tab-scan').classList.toggle('active', tab === 'scan');
  document.getElementById('qr-display').style.display = tab === 'show' ? 'flex' : 'none';
  document.getElementById('qr-scan').style.display = tab === 'scan' ? 'flex' : 'none';
  if (tab === 'scan') startScan();
  else stopScan();
}

async function startScan() {
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' }
    });
    const video = document.getElementById('scan-video');
    video.srcObject = videoStream;
    await video.play();
    scanFrame();
  } catch (e) {
    document.getElementById('scan-status').textContent = 'Fotocamera non disponibile';
  }
}

function stopScan() {
  if (scanAnimFrame) { cancelAnimationFrame(scanAnimFrame); scanAnimFrame = null; }
  if (videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
}

function scanFrame() {
  const video = document.getElementById('scan-video');
  if (!video.videoWidth) { scanAnimFrame = requestAnimationFrame(scanFrame); return; }

  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height);

  if (code && code.data.includes('connect=')) {
    const token = new URL(code.data).searchParams.get('connect');
    closeQRModal();
    handleIncomingQR(token);
    return;
  }

  scanAnimFrame = requestAnimationFrame(scanFrame);
}

// ─── QR CONNECT ──────────────────────────────────────────
async function handleIncomingQR(token) {
  try {
    const decoded = JSON.parse(atob(token));
    if (!decoded.uid || decoded.uid === currentUser.id) return;

    // Check if already connected or pending
    const { data: existing } = await db.from('connections')
      .select('*')
      .or(`and(user_a.eq.${currentUser.id},user_b.eq.${decoded.uid}),and(user_a.eq.${decoded.uid},user_b.eq.${currentUser.id})`)
      .maybeSingle();

    if (existing) {
      if (existing.status === 'accepted') { showToast('Già nella tua cerchia!'); return; }
      if (existing.status === 'pending') { showToast('Richiesta già inviata, attendi...'); return; }
    }

    // Scanner inserts pending request and shows wait modal
    const { data: conn, error } = await db.from('connections').insert({
      user_a: currentUser.id,
      user_b: decoded.uid,
      status: 'pending',
      created_at: new Date().toISOString()
    }).select().single();

    if (error) { showToast('Errore: ' + error.message); return; }

    pendingConnection = { ...decoded, connId: conn?.id };
    document.getElementById('qr-wait-name').textContent = decoded.name || 'Utente';
    document.getElementById('qr-wait-modal').classList.add('open');
  } catch (e) {
    showToast('QR non valido');
  }
}

function closeQRWaitModal() {
  document.getElementById('qr-wait-modal').classList.remove('open');
  pendingConnection = null;
}

// Shower: accept incoming pending request
async function acceptIncomingRequest() {
  if (!pendingConnection) return;
  document.getElementById('confirm-modal').classList.remove('open');
  closeQRModal(); // auto-close QR modal on match

  await db.from('connections')
    .update({ status: 'accepted' })
    .eq('id', pendingConnection.connId);

  showToast('Hai aggiunto ' + pendingConnection.name + ' alla tua cerchia.');
  pendingConnection = null;
  await loadContacts();
}

// Shower: reject incoming pending request
async function rejectIncomingRequest() {
  document.getElementById('confirm-modal').classList.remove('open');
  if (pendingConnection?.connId) {
    await db.from('connections')
      .update({ status: 'rejected' })
      .eq('id', pendingConnection.connId);
  }
  pendingConnection = null;
}

async function handleIncomingConnectionRequest(conn) {
  const { data: profile } = await db.from('profiles').select('*').eq('id', conn.user_a).single();
  pendingConnection = { uid: conn.user_a, name: profile?.display_name || 'Utente', connId: conn.id };
  document.getElementById('confirm-avatar').textContent = (pendingConnection.name || '?')[0].toUpperCase();
  document.getElementById('confirm-name').textContent = pendingConnection.name;
  document.getElementById('confirm-modal').classList.add('open');
}

// ─── NAVIGATION MODAL ────────────────────────────────────
function openNavModal(name, lat, lng) {
  navTargetLat = lat;
  navTargetLng = lng;
  document.getElementById('nav-target-name').textContent = name;
  document.getElementById('nav-modal').classList.add('open');
}
function closeNavModal() {
  document.getElementById('nav-modal').classList.remove('open');
}
function openGoogleMaps(mode) {
  if (navTargetLat === null) return;
  const url = `https://maps.google.com/maps?daddr=${navTargetLat},${navTargetLng}&dirflg=${mode}`;
  window.open(url, '_blank');
  closeNavModal();
}

// ─── COMPASS / ARROW MODE ────────────────────────────────
function toggleCompass() {
  compassMode = !compassMode;
  const btn = document.getElementById('compass-btn');
  const bar = document.getElementById('compass-bar');
  btn.classList.toggle('active-btn', compassMode);

  if (compassMode) {
    bar.classList.add('visible');
    // Switch my marker to arrow shape
    rebuildMyMarker();

    if (window.DeviceOrientationEvent) {
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(perm => {
            if (perm === 'granted') {
              window.addEventListener('deviceorientation', handleOrientation, true);
              showToast('🧭 Freccia direzionale attiva');
            } else {
              showToast('Accesso giroscopio negato');
            }
          })
          .catch(() => showToast('Accesso giroscopio negato'));
      } else {
        window.addEventListener('deviceorientation', handleOrientation, true);
        showToast('🧭 Freccia direzionale attiva');
      }
    } else {
      showToast('Giroscopio non supportato');
      compassMode = false;
      btn.classList.remove('active-btn');
      bar.classList.remove('visible');
      rebuildMyMarker();
    }
  } else {
    bar.classList.remove('visible');
    window.removeEventListener('deviceorientation', handleOrientation, true);
    // Switch back to dot marker
    rebuildMyMarker();
    showToast('Modalità freccia disattivata');
  }
}

function rebuildMyMarker() {
  if (!myMarker) return;
  const latlng = myMarker.getLatLng();
  map.removeLayer(myMarker);
  myMarker = null;
  createMyMarker(latlng.lat, latlng.lng);
}

function handleOrientation(e) {
  if (!compassMode) return;
  // Use webkitCompassHeading on iOS, or alpha on Android
  const heading = (e.webkitCompassHeading !== null && e.webkitCompassHeading !== undefined)
    ? e.webkitCompassHeading
    : (e.alpha !== null && e.alpha !== undefined ? (360 - e.alpha) % 360 : 0);
  compassHeading = heading;

  const dirs = ['N','NE','E','SE','S','SO','O','NO'];
  const dir = dirs[Math.round(heading / 45) % 8];
  const needle = document.getElementById('compass-needle');
  if (needle) needle.style.transform = `rotate(${heading}deg)`;
  const txt = document.getElementById('compass-text');
  if (txt) txt.textContent = `${dir} ${Math.round(heading)}°`;

  // Rotate arrow marker with heading
  if (myMarker) {
    const el = myMarker.getElement();
    const arrow = el && el.querySelector('.my-marker-arrow');
    if (arrow) {
      arrow.style.transform = `rotate(${heading}deg)`;
    } else if (el) {
      el.style.transform = `rotate(${heading}deg)`;
    }
  }
}

function stopCompass() {
  compassMode = false;
  window.removeEventListener('deviceorientation', handleOrientation, true);
  if (myMarker) {
    rebuildMyMarker();
  }
}

// ─── SIDEBAR ──────────────────────────────────────────────
function openSidebar() {
  sidebarOpen = true;
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebar-overlay').classList.add('open');
  document.getElementById('fab-container').classList.add('sidebar-open');
}

function closeSidebar() {
  sidebarOpen = false;
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
  document.getElementById('fab-container').classList.remove('sidebar-open');
}



// ─── IL MONDO ORIZON ─────────────────────────────────────
function openOrizonWorld() {
  document.getElementById('orizon-world-modal').classList.add('open');
}
function closeOrizonWorld() {
  document.getElementById('orizon-world-modal').classList.remove('open');
}

// ─── GEOLOCATION (updated to report battery) ─────────────
function startGeolocationWithBattery() {
  startGeolocation();
  // Try to get battery level for own device (visible in location updates)
  if ('getBattery' in navigator) {
    navigator.getBattery().then(battery => {
      const saveBattery = () => {
        if (!currentUser) return;
        db.from('locations').update({ battery_level: battery.level })
          .eq('user_id', currentUser.id).then(() => {}).catch(() => {});
      };
      battery.addEventListener('levelchange', saveBattery);
      saveBattery();
    }).catch(() => {});
  }
}

// ─── TOAST ───────────────────────────────────────────────
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// ─── PROFILE PICTURE UPLOAD ──────────────────────────────
async function handleAvatarUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Validate file
  if (!file.type.startsWith('image/')) {
    showToast('Seleziona un file immagine valido');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    showToast('Immagine troppo grande (max 5MB)');
    return;
  }

  showToast('Caricamento foto profilo...');

  try {
    // Resize image to max 256x256 and convert to base64
    const dataUrl = await resizeImage(file, 256);

    // Try uploading to Supabase Storage
    const ext = file.name.split('.').pop() || 'jpg';
    const filePath = `avatars/${currentUser.id}.${ext}`;

    const { error: uploadError } = await db.storage
      .from('avatars')
      .upload(filePath, file, { upsert: true, contentType: file.type });

    let avatarUrl = dataUrl; // fallback to base64
    if (!uploadError) {
      const { data: urlData } = db.storage.from('avatars').getPublicUrl(filePath);
      if (urlData?.publicUrl) avatarUrl = urlData.publicUrl + '?t=' + Date.now();
    }

    // Update profile in DB
    await db.from('profiles').update({ avatar_url: avatarUrl }).eq('id', currentUser.id);
    userProfile.avatar_url = avatarUrl;
    profilePicUrl = avatarUrl;

    // Update all avatar displays
    updateAllAvatars(avatarUrl);
    showToast('Foto profilo aggiornata!');
  } catch (err) {
    showToast('Errore nel caricamento: ' + (err.message || 'riprova'));
  }
}

function resizeImage(file, maxSize) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > h) { if (w > maxSize) { h = h * maxSize / w; w = maxSize; } }
        else { if (h > maxSize) { w = w * maxSize / h; h = maxSize; } }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', 0.85));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function updateAllAvatars(url) {
  // Profile chip in top bar
  const profileAvatarEl = document.getElementById('profile-avatar');
  if (profileAvatarEl) {
    profileAvatarEl.innerHTML = `<img src="${url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover" />`;
  }
  // Settings avatar
  const settingsAvatarEl = document.getElementById('settings-avatar-img');
  const settingsLetterEl = document.getElementById('settings-avatar-letter');
  if (settingsAvatarEl) {
    settingsAvatarEl.style.backgroundImage = `url(${url})`;
    settingsAvatarEl.style.backgroundSize = 'cover';
    settingsAvatarEl.style.backgroundPosition = 'center';
    if (settingsLetterEl) settingsLetterEl.style.display = 'none';
  }
  // Sidebar avatar
  const sidebarAvatarEl = document.getElementById('sidebar-avatar');
  if (sidebarAvatarEl) {
    sidebarAvatarEl.innerHTML = `<img src="${url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover" />`;
  }
}

// ─── REMOVE USER FROM CIRCLE ─────────────────────────────
async function removeUserFromCircle(userId) {
  const contact = contacts.find(c => c.id === userId);
  const name = contact?.display_name || 'utente';
  if (!confirm(`Rimuovere ${name} dalla tua cerchia?`)) return;

  await db.from('connections')
    .delete()
    .or(`and(user_a.eq.${currentUser.id},user_b.eq.${userId}),and(user_a.eq.${userId},user_b.eq.${currentUser.id})`);

  removeContactMarker(userId);
  contacts = contacts.filter(c => c.id !== userId);
  visibleToUsers = visibleToUsers.filter(id => id !== userId);
  hiddenUsers = hiddenUsers.filter(id => id !== userId);
  localStorage.setItem('orizon_hidden_users', JSON.stringify(hiddenUsers));

  document.getElementById('contact-count').textContent = contacts.length;
  await loadContactsLocations();
  showToast(`${name} rimosso dalla cerchia`);
}

// ─── DELETE ACCOUNT ──────────────────────────────────────
async function deleteAccount() {
  if (!confirm('Sei sicuro di voler eliminare il tuo account?\nTutti i tuoi dati verranno cancellati permanentemente.')) return;
  if (!confirm('Ultima conferma: eliminare definitivamente il tuo account Orizon?')) return;

  closeSettings();
  showToast('Eliminazione account in corso...');

  try {
    await db.from('connections').delete()
      .or(`user_a.eq.${currentUser.id},user_b.eq.${currentUser.id}`);
    await db.from('locations').delete().eq('user_id', currentUser.id);
    await db.from('profiles').delete().eq('id', currentUser.id);

    try {
      await db.storage.from('avatars').remove([
        `avatars/${currentUser.id}.jpg`,
        `avatars/${currentUser.id}.png`,
        `avatars/${currentUser.id}.webp`
      ]);
    } catch(e) {}

    stopGeolocation();
    stopCompass();
    if (realtimeChannel) db.removeChannel(realtimeChannel);
    await db.auth.signOut();

    currentUser = null;
    userProfile = null;
    contacts = [];

    document.getElementById('map-screen').classList.add('hidden');
    document.getElementById('auth-screen').classList.remove('hidden');
    showToast('Account eliminato con successo');
  } catch (err) {
    showToast('Errore: ' + (err.message || 'riprova'));
  }
}

// ─── DRAGGABLE BOTTOM SHEET ──────────────────────────────
let panelDragStartY = 0;
let panelDragStartTranslate = 0;
let panelIsDragging = false;
const PANEL_COLLAPSED_OFFSET = 72;

function initPanelDrag() {
  const dragArea = document.getElementById('panel-drag-area');
  if (!dragArea) return;
  dragArea.addEventListener('touchstart', onPanelTouchStart, { passive: true });
  dragArea.addEventListener('touchmove', onPanelTouchMove, { passive: false });
  dragArea.addEventListener('touchend', onPanelTouchEnd, { passive: true });
}

function getPanelTranslateY() {
  const panel = document.getElementById('contacts-panel');
  const st = getComputedStyle(panel).transform;
  if (!st || st === 'none') return 0;
  const m = new DOMMatrix(st);
  return m.m42;
}

function onPanelTouchStart(e) {
  const panel = document.getElementById('contacts-panel');
  panelDragStartY = e.touches[0].clientY;
  panelDragStartTranslate = getPanelTranslateY();
  panelIsDragging = true;
  panel.classList.add('dragging');
  document.body.classList.add('panel-dragging');
}

function onPanelTouchMove(e) {
  if (!panelIsDragging) return;
  e.preventDefault();
  const panel = document.getElementById('contacts-panel');
  const dy = e.touches[0].clientY - panelDragStartY;
  let newY = panelDragStartTranslate + dy;
  const panelHeight = panel.offsetHeight;
  const maxTranslate = panelHeight - PANEL_COLLAPSED_OFFSET;
  newY = Math.max(0, Math.min(newY, maxTranslate));
  panel.style.transform = `translateY(${newY}px)`;
  const visibleH = panelHeight - newY;
  updateFloatingPositions(visibleH);
}

function onPanelTouchEnd() {
  if (!panelIsDragging) return;
  panelIsDragging = false;
  const panel = document.getElementById('contacts-panel');
  panel.classList.remove('dragging');
  document.body.classList.remove('panel-dragging');

  const currentY = getPanelTranslateY();
  const panelHeight = panel.offsetHeight;
  const maxTranslate = panelHeight - PANEL_COLLAPSED_OFFSET;
  const threshold = maxTranslate * 0.4;

  if (currentY < threshold) {
    panelOpen = true;
    panel.classList.add('open');
    panel.style.transform = '';
    updateFloatingPositions(Math.min(panelHeight, window.innerHeight * 0.72));
  } else {
    panelOpen = false;
    panel.classList.remove('open');
    panel.style.transform = '';
    updateFloatingPositions(PANEL_COLLAPSED_OFFSET);
  }

  const arrow = document.getElementById('panel-arrow');
  arrow.style.transform = panelOpen ? 'rotate(180deg)' : '';
}

function updateFloatingPositions(visibleH) {
  document.documentElement.style.setProperty('--panel-h', visibleH + 'px');
}

// ─── SERVICE WORKER (auto-update on deploy) ─────────────
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(reg => {
    // Check for updates every 60s while the page is open
    setInterval(() => reg.update(), 60000);
    reg.addEventListener('updatefound', () => {
      const newSW = reg.installing;
      if (!newSW) return;
      newSW.addEventListener('statechange', () => {
        // New SW activated → reload to get the latest code
        if (newSW.state === 'activated' && navigator.serviceWorker.controller) {
          window.location.reload();
        }
      });
    });
  }).catch(() => {});
  // Also reload when a new SW takes control while this page is open
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });
}
</script>
</body>
</html>
